<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Doctor Dashboard</title>
  <link rel="stylesheet" href="../style/dashboard.css" />
  <style>
    .cal {
      background: var(--card, #ffffff);
      border: 1px solid var(--border, #e2e8f0);
      border-radius: 20px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      flex: 1 1 auto;
      min-height: 0;
      --cal-week-count: 6;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.1);
    }

    .cal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border, #e2e8f0);
      color: var(--text, #0f172a);
    }

    .cal-title {
      font-weight: 700;
      letter-spacing: 0.02em;
      color: var(--text, #0f172a);
    }

    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-template-rows: auto repeat(var(--cal-week-count, 6), minmax(0, 1fr));
      align-items: stretch;
      flex: 1 1 auto;
      min-height: 0;
      background: var(--bg-soft, #0f172a);
      border-radius: 16px;
      border: 1px solid var(--border, #e2e8f0);
      padding: 8px;
    }

    .cal-weekday {
      padding: clamp(8px, 0.8vw, 14px);
      font-weight: 700;
      font-size: clamp(12px, 0.9vw, 16px);
      color: var(--primary-strong, #0284c7);
      border-bottom: 1px solid rgba(14, 165, 233, 0.25);
      background: rgba(14, 165, 233, 0.1);
      border-radius: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .cal-day {
      min-height: 0;
      padding: clamp(8px, 0.8vw, 14px);
      border-right: 1px solid rgba(0, 0, 0, 0.05);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      position: relative;
      background: var(--card, #ffffff);
      cursor: pointer;
      transition: background-color 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
      display: flex;
      flex-direction: column;
      border-radius: 12px;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.04);
    }

    .cal-day:nth-child(7n) {
      border-right: 0;
    }

    .cal-day.outside {
      background: rgba(241, 245, 249, 0.65);
      color: rgba(100, 116, 139, 0.5);
      cursor: default;
      border-style: dashed;
    }

    .cal-day:not(.outside):hover {
      background: rgba(14, 165, 233, 0.1);
      box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.25) inset;
    }

    .cal-day .date {
      font-size: clamp(12px, 0.9vw, 16px);
      color: var(--text, #0f172a);
      font-weight: 700;
    }

    .cal-events {
      margin-top: clamp(6px, 0.6vw, 12px);
      display: flex;
      flex-direction: column;
      gap: clamp(6px, 0.6vw, 12px);
      flex: 1 1 auto;
      min-height: 0;
      overflow: auto;
      color: rgba(15, 23, 42, 0.85);
    }

    .cal-event {
      display: flex;
      align-items: center;
      gap: 8px;
      border-radius: 10px;
      padding: clamp(4px, 0.5vw, 10px) clamp(8px, 0.8vw, 14px);
      font-size: clamp(12px, 0.9vw, 16px);
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(255, 255, 255, 0.9);
      border-left: 4px solid var(--primary, #0ea5e9);
      color: var(--text, #0f172a);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }

    .cal-event:hover {
      border-color: rgba(14, 165, 233, 0.6);
      background: rgba(240, 249, 255, 0.9);
    }

    .cal-event .time {
      font-weight: 700;
    }

    .cal-event .name {
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cal-event.success {
      border-left-color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
      color: #16a34a;
      border-color: rgba(34, 197, 94, 0.4);
    }

    .cal-event.warning {
      border-left-color: #f59e0b;
      background: rgba(245, 158, 11, 0.12);
      color: #d97706;
      border-color: rgba(245, 158, 11, 0.45);
    }

    .cal-event.info {
      border-left-color: #0ea5e9;
      background: rgba(14, 165, 233, 0.12);
      color: #0284c7;
      border-color: rgba(14, 165, 233, 0.5);
    }

    .cal-event.danger {
      border-left-color: #ef4444;
      background: rgba(239, 68, 68, 0.12);
      color: #dc2626;
      border-color: rgba(239, 68, 68, 0.45);
    }

    .cal-event.neutral {
      border-left-color: #a78bfa;
      background: rgba(167, 139, 250, 0.12);
      color: #7c3aed;
      border-color: rgba(167, 139, 250, 0.4);
    }

    .cal-event.mini {
      padding: 2px 6px;
      font-size: 11px;
    }

    .cal-count {
      position: absolute;
      top: 6px;
      right: 6px;
      min-width: 22px;
      height: 20px;
      padding: 0 6px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      line-height: 20px;
      background: var(--primary, #0ea5e9);
      color: #ffffff;
      text-align: center;
      box-shadow: 0 4px 10px rgba(8, 145, 178, 0.25);
    }

    #appt-list.scroll-area {
      max-height: 440px;
    }

    /* Override .card.compact max-height for appointments today card */
    .card.compact:has(#appt-list) {
      max-height: none;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.3);
      z-index: 2000;
      animation: modalFadeIn 150ms ease-out;
    }

    /* Responsive modal sizing based on screen size */
    .modal-card {
      background: var(--card, #ffffff);
      border: 1px solid var(--border, #e2e8f0);
      border-radius: 20px;
      box-shadow: 0 32px 64px rgba(0, 0, 0, 0.2);
      width: min(360px, 92vw);
      overflow: hidden;
      animation: modalPop 180ms ease-out;
      color: var(--text, #0f172a);
    }

    /* Small screens (mobile) */
    @media (max-width: 768px) {
      .modal-card {
        width: min(360px, 92vw);
      }

      .modal-card.wide {
        width: min(640px, 92vw);
      }

      .modal-card.narrow {
        width: min(480px, 92vw);
      }
    }

    /* Medium screens (tablets) */
    @media (min-width: 769px) and (max-width: 1024px) {
      .modal-card {
        width: min(480px, 85vw);
      }

      .modal-card.wide {
        width: min(800px, 85vw);
      }

      .modal-card.narrow {
        width: min(600px, 85vw);
      }
    }

    /* Large screens (desktops) */
    @media (min-width: 1025px) and (max-width: 1440px) {
      .modal-card {
        width: min(600px, 80vw);
      }

      .modal-card.wide {
        width: min(1000px, 80vw);
      }

      .modal-card.narrow {
        width: min(700px, 80vw);
      }
    }

    /* Extra large screens */
    @media (min-width: 1441px) {
      .modal-card {
        width: min(700px, 70vw);
      }

      .modal-card.wide {
        width: min(1200px, 70vw);
      }

      .modal-card.narrow {
        width: min(800px, 70vw);
      }
    }

    /* Special ultra-wide modal for laboratory exams */
    .modal-card.ultra-wide {
      width: min(99vw, 1400px);
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .modal-card.ultra-wide {
        width: min(95vw, 1200px);
      }
    }

    @media (min-width: 1025px) and (max-width: 1440px) {
      .modal-card.ultra-wide {
        width: min(90vw, 1300px);
      }
    }

    @media (min-width: 1441px) {
      .modal-card.ultra-wide {
        width: min(85vw, 1400px);
      }
    }

    /* Prescription modal - wider than standard wide modal */
    #rx-modal .modal-card.prescription-modal {
      width: min(95vw, 1400px);
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      #rx-modal .modal-card.prescription-modal {
        width: min(92vw, 1200px);
      }
    }

    @media (min-width: 1025px) and (max-width: 1440px) {
      #rx-modal .modal-card.prescription-modal {
        width: min(90vw, 1300px);
      }
    }

    @media (min-width: 1441px) {
      #rx-modal .modal-card.prescription-modal {
        width: min(85vw, 1500px);
      }
    }

    /* Extra narrow modal for date/time picker */
    .modal-card.extra-narrow {
      width: min(420px, 90vw);
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .modal-card.extra-narrow {
        width: min(500px, 85vw);
      }
    }

    @media (min-width: 1025px) and (max-width: 1440px) {
      .modal-card.extra-narrow {
        width: min(560px, 75vw);
      }
    }

    @media (min-width: 1441px) {
      .modal-card.extra-narrow {
        width: min(620px, 65vw);
      }
    }

    /* Light mode styling for medical history modal dropdown menus */
    #mh-allergies-menu li,
    #mh-illnesses-menu li,
    #mh-surgeries-menu li {
      color: var(--text, #0f172a);
    }

    #mh-allergies-menu li:hover,
    #mh-illnesses-menu li:hover,
    #mh-surgeries-menu li:hover {
      background: var(--bg-soft, #0f172a);
      color: var(--text, #0f172a);
    }

    /* Light mode styling for manage tab form elements */
    #tab-manage input,
    #tab-manage textarea,
    #tab-manage select {
      background: var(--card, #ffffff);
      color: var(--text, #0f172a);
      border: 1px solid var(--border, #e2e8f0);
    }

    #tab-manage input::placeholder,
    #tab-manage textarea::placeholder {
      color: var(--muted, #64748b);
      opacity: 1;
    }

    #tab-manage input:focus,
    #tab-manage textarea:focus,
    #tab-manage select:focus {
      background: var(--card-alt, #f1f5f9);
      border-color: var(--primary, #0ea5e9);
      outline: none;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.25);
    }

    #tab-manage label {
      color: var(--muted, #64748b);
    }

    /* Light mode styling for Chief Complaint & Medical History modal */
    #medical-history-content,
    #medical-history-content strong {
      color: var(--text, #0f172a);
    }

    #medical-history-content span {
      color: var(--text, #0f172a);
    }

    /* Light mode styling for Diagnosis modal dropdown menus */
    #diag-diagnosis-menu li,
    #diag-secondary-menu li {
      color: var(--text, #0f172a);
    }

    #diag-diagnosis-menu li:hover,
    #diag-secondary-menu li:hover {
      background: var(--bg-soft, #0f172a);
      color: var(--text, #0f172a);
    }

    /* Keep date-picker calendars fully visible inside their modals without inner scrolling */
    #schedule-modal .modal-card,
    #date-only-modal .modal-card {
      max-height: 92vh;
      display: flex;
      flex-direction: column;
    }

    #schedule-modal .modal-body,
    #date-only-modal .modal-body {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      max-height: none;
      overflow: hidden;
    }

    #schedule-modal .cal-grid,
    #date-only-modal .cal-grid {
      flex: 1 1 auto;
      min-height: 0;
      max-height: none;
      overflow: hidden;
    }

    /* Responsive modal header */
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border, #e2e8f0);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: var(--card-alt, #f1f5f9);
    }

    @media (min-width: 1025px) {
      .modal-header {
        padding: 20px 24px;
      }
    }

    @media (min-width: 1441px) {
      .modal-header {
        padding: 24px 28px;
      }
    }

    .modal-title-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Responsive modal avatar */
    .modal-avatar {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: var(--avatar, #1f3a62);
      color: var(--primary-strong, #7dd3fc);
      border: 1px solid var(--avatar-border, #27446c);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }

    @media (min-width: 1025px) {
      .modal-avatar {
        width: 42px;
        height: 42px;
        font-size: 18px;
      }
    }

    @media (min-width: 1441px) {
      .modal-avatar {
        width: 48px;
        height: 48px;
        font-size: 20px;
      }
    }

    /* Responsive modal icons */
    .modal-icon {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      border: 1px solid transparent;
    }

    @media (min-width: 1025px) {
      .modal-icon {
        width: 32px;
        height: 32px;
        font-size: 16px;
      }
    }

    @media (min-width: 1441px) {
      .modal-icon {
        width: 36px;
        height: 36px;
        font-size: 18px;
      }
    }

    .modal-icon.success {
      background: rgba(34, 197, 94, 0.2);
      color: #4ade80;
      border-color: rgba(34, 197, 94, 0.45);
    }

    .modal-icon.error {
      background: rgba(248, 113, 113, 0.2);
      color: #f87171;
      border-color: rgba(248, 113, 113, 0.45);
    }

    .modal-icon.warning {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      border-color: rgba(251, 191, 36, 0.45);
    }

    .modal-icon.info {
      background: rgba(14, 165, 233, 0.2);
      color: #0ea5e9;
      border-color: rgba(14, 165, 233, 0.45);
    }

    /* Responsive modal title */
    .modal-title {
      font-weight: 700;
      font-size: 18px;
    }

    @media (min-width: 1025px) {
      .modal-title {
        font-size: 20px;
      }
    }

    @media (min-width: 1441px) {
      .modal-title {
        font-size: 22px;
      }
    }

    /* Responsive modal subtitle */
    .modal-sub {
      font-size: 12px;
    }

    @media (min-width: 1025px) {
      .modal-sub {
        font-size: 13px;
      }
    }

    @media (min-width: 1441px) {
      .modal-sub {
        font-size: 14px;
      }
    }

    /* Responsive modal body */
    .modal-body {
      padding: 16px 20px;
      display: grid;
      gap: 12px;
      max-height: 70vh;
      overflow: auto;
    }

    @media (min-width: 1025px) {
      .modal-body {
        padding: 20px 24px;
        gap: 16px;
      }
    }

    @media (min-width: 1441px) {
      .modal-body {
        padding: 24px 28px;
        gap: 20px;
      }
    }

    /* Responsive status modals */
    .modal-card.is-success {
      border-top: 4px solid #16a34a;
      width: min(320px, 92vw);
    }

    .modal-card.is-error {
      border-top: 4px solid #dc2626;
      width: min(320px, 92vw);
    }

    .modal-card.is-warning {
      border-top: 4px solid #d97706;
    }

    .modal-card.is-info {
      border-top: 4px solid #0891b2;
    }

    @media (min-width: 769px) {
      .modal-card.is-success {
        width: min(400px, 85vw);
      }

      .modal-card.is-error {
        width: min(400px, 85vw);
      }
    }

    @media (min-width: 1025px) {
      .modal-card.is-success {
        width: min(500px, 80vw);
      }

      .modal-card.is-error {
        width: min(500px, 80vw);
      }
    }

    @media (min-width: 1441px) {
      .modal-card.is-success {
        width: min(600px, 70vw);
      }

      .modal-card.is-error {
        width: min(600px, 70vw);
      }
    }

    /* Responsive form elements within modals */
    .modal-body label {
      font-size: 14px;
      color: var(--muted, #64748b);
    }

    @media (min-width: 1025px) {
      .modal-body label {
        font-size: 15px;
      }
    }

    @media (min-width: 1441px) {
      .modal-body label {
        font-size: 16px;
      }
    }

    .modal-body input,
    .modal-body select,
    .modal-body textarea {
      font-size: 14px;
      padding: 8px 10px;
      background: var(--card, #ffffff);
      color: var(--text, #0f172a);
      border: 1px solid var(--border, #e2e8f0);
    }

    .modal-body input::placeholder,
    .modal-body textarea::placeholder {
      color: var(--muted, #64748b);
      opacity: 1;
    }

    .modal-body input:focus,
    .modal-body select:focus,
    .modal-body textarea:focus {
      background: var(--card-alt, #f1f5f9);
      border-color: var(--primary, #0ea5e9);
      outline: none;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.25);
    }

    /* Ensure dropdown inputs in modals are dark mode */
    .modal-body .dropdown input {
      background: var(--card, #ffffff);
      color: var(--text, #0f172a);
      border: 1px solid var(--border, #e2e8f0);
    }

    .modal-body .dropdown input::placeholder {
      color: var(--muted, #64748b);
      opacity: 1;
    }

    .modal-body .dropdown input:focus {
      background: var(--card-alt, #f1f5f9);
      border-color: var(--primary, #0ea5e9);
    }

    @media (min-width: 1025px) {

      .modal-body input,
      .modal-body select,
      .modal-body textarea {
        font-size: 15px;
        padding: 10px 12px;
      }
    }

    @media (min-width: 1441px) {

      .modal-body input,
      .modal-body select,
      .modal-body textarea {
        font-size: 16px;
        padding: 12px 14px;
      }
    }

    /* Responsive buttons within modals */
    .modal-body button {
      font-size: 14px;
      padding: 10px 16px;
    }

    @media (min-width: 1025px) {
      .modal-body button {
        font-size: 15px;
        padding: 12px 18px;
      }
    }

    @media (min-width: 1441px) {
      .modal-body button {
        font-size: 16px;
        padding: 14px 20px;
      }
    }

    /* Responsive form grid spacing */
    .modal-body .form-grid {
      gap: 12px;
    }

    @media (min-width: 1025px) {
      .modal-body .form-grid {
        gap: 16px;
      }
    }

    @media (min-width: 1441px) {
      .modal-body .form-grid {
        gap: 20px;
      }
    }

    /* Responsive text content within modals */
    .modal-body p,
    .modal-body div {
      font-size: 14px;
      line-height: 1.5;
    }

    @media (min-width: 1025px) {

      .modal-body p,
      .modal-body div {
        font-size: 15px;
        line-height: 1.6;
      }
    }

    @media (min-width: 1441px) {

      .modal-body p,
      .modal-body div {
        font-size: 16px;
        line-height: 1.6;
      }
    }

    /* Responsive list items within modals */
    .modal-body .list .item {
      padding: 10px 0;
    }

    @media (min-width: 1025px) {
      .modal-body .list .item {
        padding: 12px 0;
      }
    }

    @media (min-width: 1441px) {
      .modal-body .list .item {
        padding: 14px 0;
      }
    }

    /* Responsive field spacing */
    .modal-body .field {
      gap: 6px;
    }

    @media (min-width: 1025px) {
      .modal-body .field {
        gap: 8px;
      }
    }

    @media (min-width: 1441px) {
      .modal-body .field {
        gap: 10px;
      }
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes modalPop {
      from {
        transform: translateY(8px) scale(0.98);
        opacity: 0.98;
      }

      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    #schedule-modal .modal-body {
      max-height: 85vh;
    }

    /* Constrain Patient Information card to viewport */
    #doc-pi {
      max-height: calc(100vh - 260px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    #doc-pi #pi-tabs {
      display: flex;
      flex-direction: column;
      min-height: 0;
      max-height: 100%;
    }

    #doc-pi #pi-tabs .tab-content {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
    }

    #doc-pi #pi-tabs .tab-pane {
      max-height: 100%;
    }

    #doc-pi #pi-diag-list {
      max-height: calc(100vh - 400px);
      overflow-y: auto;
    }

    /* Scrollbar styling for patient info panel */
    #doc-pi::-webkit-scrollbar,
    #doc-pi #pi-diag-list::-webkit-scrollbar,
    #doc-pi #pi-tabs .tab-content::-webkit-scrollbar {
      width: 6px;
    }

    #doc-pi::-webkit-scrollbar-track,
    #doc-pi #pi-diag-list::-webkit-scrollbar-track,
    #doc-pi #pi-tabs .tab-content::-webkit-scrollbar-track {
      background: transparent;
    }

    #doc-pi::-webkit-scrollbar-thumb,
    #doc-pi #pi-diag-list::-webkit-scrollbar-thumb,
    #doc-pi #pi-tabs .tab-content::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    #doc-pi::-webkit-scrollbar-thumb:hover,
    #doc-pi #pi-diag-list::-webkit-scrollbar-thumb:hover,
    #doc-pi #pi-tabs .tab-content::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
</head>

<body>
  <div class="container wide">
    <header class="topbar">
      <h1 id="title">Doctor Dashboard</h1>
      <div class="spacer"></div>
      <span id="whoami" class="who"></span>
      <button id="logout">Logout</button>
    </header>
    <main>
      <div id="content" class="card"></div>
    </main>
  </div>

  <script src="../scripts/dashboard.js"></script>
  <script src="../scripts/api.js"></script>
  <div class="chat-float card compact" id="doctor-chat-float" style="display:none;">
    <div class="section-title">
      <h3>Chat</h3><button id="chat-close" class="btn-secondary btn-small">Close</button>
    </div>
    <div class="chat">
      <div class="chat-sidebar" id="chat-sidebar"></div>
      <div class="chat-main">
        <div id="chat-header" class="chat-header who"
          style="padding:8px 10px; border-bottom:1px solid #e5e7eb; display:none;"></div>
        <div id="chat-body" class="chat-body"></div>
        <div class="chat-input">
          <input id="chat-text" type="text" placeholder="Type a message..." />
          <button id="chat-send" type="button">Send</button>
        </div>
      </div>
    </div>
  </div>
  <button id="chat-open" class="chat-fab" style="display:none;" aria-label="Open chat">
    <span class="notif-badge" id="chat-open-badge">0</span>
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path
        d="M20 2H4a2 2 0 0 0-2 2v18l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2Zm-2 10H6v-2h12v2Zm0-3H6V7h12v2Zm0-3H6V4h12v2Z" />
    </svg>
  </button>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      let currentPatientProfile = null;

      const html = `
        <div class="tabs" id="doctor-tabs">
          <div class="tab-nav">
            <button class="tab-link active" data-tab="tab-schedule">Schedule</button>
            <button class="tab-link" data-tab="tab-patients">Patients</button>
            <button class="tab-link" data-tab="tab-manage">Manage</button>
          </div>
          <div class="tab-content">
            <section class="tab-pane active" id="tab-schedule">
              <div class="schedule-grid">
                <div>
                  <div class="card compact" style="margin-bottom:12px; display:flex; flex-direction:column; min-height:0; flex:1 1 auto;">
                    <div class="section-title"><h3>Calendar</h3></div>
                    <div id="calendar" class="cal">
                      <div class="cal-header">
                        <button id="prev-month" class="btn-secondary btn-small">Prev</button>
                        <div id="cal-title" class="cal-title"></div>
                        <button id="next-month" class="btn-secondary btn-small">Next</button>
                      </div>
                      <div class="cal-grid" id="cal-grid"></div>
                    </div>
                  </div>
                </div>
                <div>
                  <div class="card compact">
                    <div class="section-title" style="display:flex; align-items:center; justify-content:space-between;">
                      <h3>Appointments Today</h3>
                      <div style="display:flex; align-items:center; gap:12px;">
                        <label class="toggle-switch-wrapper">
                          <span class="toggle-switch-label">Show Completed</span>
                          <div class="toggle-switch">
                            <input type="checkbox" id="show-completed-toggle">
                            <span class="slider round"></span>
                          </div>
                        </label>
                        <button id="appt-create-btn" class="btn-small">Create</button>
                      </div>
                    </div>
                    <ul id="appt-list" class="list scroll-area"></ul>
                  </div>
                </div>
              </div>
            </section>
            <section class="tab-pane" id="tab-patients">
              <div class="patients-grid">
                <div>
                  <div class="card compact">
                    <div class="section-title"><h3>Patients</h3></div>
                    <div class="field">
                      <input id="patient-search" type="text" placeholder="Search patients..." />
                    </div>
                    <ul id="patient-results" class="list" style="margin-top:8px;"></ul>
                  </div>
                </div>
                <div>
                  <div class="card compact" style="margin-top:0;">
                    <div class="section-title"><h3>Patient Information</h3></div>
                    <div id="doc-pi" class="who">Select a patient to view information.</div>
                    <ul id="diag-list" class="list" style="display:none;"></ul>
                  </div>
                </div>
              </div>
            </section>
            <section class="tab-pane" id="tab-manage">
              <div class="patients-grid">
                <div>
                  <div class="card compact" style="margin-bottom:12px;">
                    <div class="section-title" style="display:flex; align-items:center; justify-content:space-between;"><h3>Create Patient</h3></div>
                    <form id="nurse-add-patient" class="form-grid" style="margin-top:8px;">
                      <div class="field">
                        <label for="nap-fullName">Full name</label>
                        <input id="nap-fullName" placeholder="e.g. Juan Dela Cruz" />
                      </div>
                      <div class="field">
                        <label for="nap-email">Email</label>
                        <input id="nap-email" type="email" placeholder="e.g. juan@example.com" />
                      </div>
                      <div class="field">
                        <label for="nap-dob">Date of Birth</label>
                        <input id="nap-dob" placeholder="YYYY-MM-DD" />
                      </div>
                      <div class="field">
                        <label for="nap-phone">Phone</label>
                        <input id="nap-phone" placeholder="e.g. 09123456789" />
                      </div>
                      <div class="field col-span-2">
                        <label for="nap-address">Address</label>
                        <input id="nap-address" placeholder="Street, Barangay, City, Province ZIP" />
                      </div>
                      <div class="field">
                        <label for="nap-gender">Gender</label>
                        <input id="nap-gender" placeholder="e.g. Female" />
                      </div>
                      <div class="field">
                        <label for="nap-bloodType">Blood Type</label>
                        <input id="nap-bloodType" placeholder="e.g. O+" />
                      </div>
                      <div class="actions col-span-2">
                        <button type="submit">Create Patient</button>
                      </div>
                    </form>
                  </div>
                  <div class="card compact" style="margin-bottom:12px;">
                    <div class="section-title" style="display:flex; align-items:center; justify-content:space-between;"><h3>My Profile</h3></div>
                    <form id="doctor-profile-form" class="form-grid" style="margin-top:8px;">
                      <div class="field">
                        <label for="dp-fullname">Full Name</label>
                        <input id="dp-fullname" type="text" placeholder="e.g., Dr. Juan Santos" />
                      </div>
                      <div class="field">
                        <label for="dp-abbreviations">Professional Abbreviations</label>
                        <input id="dp-abbreviations" type="text" placeholder="e.g., MD, FPCP, FPSP" />
                      </div>
                      <div class="field col-span-2">
                        <label for="dp-license">PRC License Number</label>
                        <input id="dp-license" type="text" placeholder="Enter your license number" />
                      </div>
                      <div id="dp-error" class="muted" style="color:#dc2626; font-size:12px; display:none;" aria-live="polite"></div>
                      <div class="actions col-span-2">
                        <button type="submit">Update Profile</button>
                      </div>
                    </form>
                  </div>
                </div>
                <div>
                  <div class="card compact" style="margin-bottom:12px;">
                    <div class="section-title" style="display:flex; align-items:center; justify-content:space-between;"><h3>Change Username</h3></div>
                    <form id="doctor-username-form" class="form-grid" style="margin-top:8px;">
                      <div class="field">
                        <label for="du-new-username">New Username</label>
                        <input id="du-new-username" type="text" placeholder="Enter new username" />
                      </div>
                      <div class="field">
                        <label for="du-password">Current Password</label>
                        <input id="du-password" type="password" placeholder="Enter current password" />
                      </div>
                      <div id="du-error" class="muted" style="color:#dc2626; font-size:12px; display:none;" aria-live="polite"></div>
                      <div class="actions col-span-2">
                        <button type="submit">Change Username</button>
                      </div>
                    </form>
                  </div>
                  <div class="card compact" style="margin-bottom:12px;">
                    <div class="section-title" style="display:flex; align-items:center; justify-content:space-between;"><h3>Change Password</h3></div>
                    <form id="doctor-password-form" class="form-grid" style="margin-top:8px;">
                      <div class="field">
                        <label for="dp-current-password">Current Password</label>
                        <input id="dp-current-password" type="password" placeholder="Enter current password" />
                      </div>
                      <div class="field">
                        <label for="dp-new-password">New Password</label>
                        <input id="dp-new-password" type="password" placeholder="Enter new password" />
                      </div>
                      <div class="field">
                        <label for="dp-confirm-password">Confirm New Password</label>
                        <input id="dp-confirm-password" type="password" placeholder="Confirm new password" />
                      </div>
                      <div id="dp-pass-error" class="muted" style="color:#dc2626; font-size:12px; display:none;" aria-live="polite"></div>
                      <div class="actions col-span-2">
                        <button type="submit">Change Password</button>
                      </div>
                    </form>
                  </div>
                  <div class="card compact" style="margin-bottom:12px;">
                    <div class="section-title" style="display:flex; align-items:center; justify-content:space-between;"><h3>Create Doctor Account</h3></div>
                    <form id="create-doctor-account" class="form-grid" style="margin-top:8px;">
                      <div class="field">
                        <label for="doc-new-username">Username</label>
                        <input id="doc-new-username" placeholder="Enter username" autocomplete="off" />
                      </div>
                      <div class="field">
                        <label for="doc-password">Password</label>
                        <input id="doc-password" type="password" placeholder="Enter password" autocomplete="new-password" />
                      </div>
                      <div id="doc-error" class="muted" style="color:#dc2626; font-size:12px; display:none;" aria-live="polite"></div>
                      <div class="actions col-span-2">
                        <button type="submit">Create Doctor</button>
                      </div>
                    </form>
                  </div>
                  <div class="card compact" style="margin-bottom:12px;">
                    <div class="section-title" style="display:flex; align-items:center; justify-content:space-between;"><h3>Appointment Overlap Settings</h3></div>
                    <p class="muted" style="font-size:12px; margin:0 0 8px;">Set the minimum minutes between appointments to prevent scheduling conflicts.</p>
                    <form id="overlap-settings-form" class="form-grid" style="margin-top:8px;">
                      <div class="field">
                        <label for="overlap-minutes">Minimum Minutes Between Appointments</label>
                        <input id="overlap-minutes" type="number" min="5" max="240" placeholder="e.g., 30" />
                      </div>
                      <div id="overlap-error" class="muted" style="color:#dc2626; font-size:12px; display:none;" aria-live="polite"></div>
                      <div class="actions col-span-2">
                        <button type="submit">Save Settings</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>`;

      initDashboard('doctor', html);
      initTabs('#doctor-tabs');
      (async function ensureDoctorCredentials() {
        try {
          const me = await apiGet('/api/doctors/me');
          const fullName = (me && me.fullName) || '';
          const abbreviations = (me && me.abbreviations) || '';
          const licenseNumber = (me && me.licenseNumber) || '';

          // Update header to show full name with abbreviations
          updateDoctorHeader(fullName, abbreviations);

          if (!fullName || !abbreviations || !licenseNumber) {
            openDoctorInfoModal(fullName, abbreviations, licenseNumber);
          }
        } catch (_) {
          // ignore; if unauthorized or error, do nothing
        }
      })();

      function updateDoctorHeader(fullName, abbreviations) {
        const title = document.getElementById('title');
        if (!title) return;

        const user = JSON.parse(localStorage.getItem('authUser') || '{}');
        const username = user.username || '';
        const imgUrl = localStorage.getItem('profilePicUrl') || '';

        // Use full name if available, otherwise fall back to username
        let displayName = fullName && fullName.trim() ? fullName.trim() : username;

        // Add abbreviations if available
        if (abbreviations && abbreviations.trim()) {
          displayName = `${displayName}, ${abbreviations.trim()}`;
        }

        // Use first letter of display name for avatar
        const initial = displayName.slice(0, 1).toUpperCase();

        if (imgUrl) {
          title.innerHTML = `<span class="title-wrap"><img src="${imgUrl}" alt="" class="avatar-img" /><span class="who-name">${displayName}</span></span>`;
        } else {
          title.innerHTML = `<span class="title-wrap"><span class="avatar">${initial}</span><span class="who-name">${displayName}</span></span>`;
        }
      }

      function openDoctorInfoModal(initFullName, initAbbrev, initLicense) {
        const existing = document.getElementById('doctor-info-modal');
        if (existing) existing.remove();
        const overlay = document.createElement('div');
        overlay.id = 'doctor-info-modal';
        overlay.className = 'modal-backdrop';
        overlay.style.zIndex = '2400';
        overlay.style.pointerEvents = 'auto';
        overlay.innerHTML = `
          <div class="modal-card narrow" role="dialog" aria-modal="true" aria-labelledby="dim-title">
            <div class="modal-header">
              <div class="modal-title" id="dim-title">Complete Your Doctor Profile</div>
            </div>
            <div class="modal-body">
              <p style="margin:0 0 12px; color:#64748b;">Please enter your full name, professional abbreviations, and PRC license number to continue.</p>
              <form id="dim-form" class="form-grid">
                <div class="field">
                  <label for="dim-fullname">Full Name</label>
                  <input id="dim-fullname" type="text" placeholder="e.g., Dr. Juan Santos" value="${(initFullName || '').replace(/"/g, '&quot;')}" required />
                </div>
                <div class="field">
                  <label for="dim-abbr">Abbreviations</label>
                  <input id="dim-abbr" type="text" placeholder="e.g., MD, FPCP" value="${(initAbbrev || '').replace(/"/g, '&quot;')}" required />
                </div>
                <div class="field col-span-2">
                  <label for="dim-lic">License Number</label>
                  <input id="dim-lic" type="text" placeholder="Enter license number" value="${(initLicense || '').replace(/"/g, '&quot;')}" required />
                </div>
                <div id="dim-error" class="muted" style="color:#dc2626; font-size:12px; display:none;" aria-live="polite"></div>
                <div class="actions col-span-2">
                  <button type="submit">Save & Continue</button>
                </div>
              </form>
            </div>
          </div>`;

        // Make the modal blocking by preventing clicks outside and disabling background
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
        });

        // Prevent keyboard navigation outside modal
        overlay.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
        });

        // Disable all background content
        const content = document.getElementById('content');
        if (content) {
          content.style.pointerEvents = 'none';
          content.style.opacity = '0.5';
        }

        document.body.appendChild(overlay);
        const form = overlay.querySelector('#dim-form');
        const fullNameInput = overlay.querySelector('#dim-fullname');
        const abbrInput = overlay.querySelector('#dim-abbr');
        const licInput = overlay.querySelector('#dim-lic');
        const errBox = overlay.querySelector('#dim-error');
        setTimeout(() => { try { fullNameInput?.focus(); } catch (_) { } }, 0);

        form?.addEventListener('submit', async (e) => {
          e.preventDefault();
          const fullName = String(fullNameInput?.value || '').trim();
          const abbreviations = String(abbrInput?.value || '').trim();
          const licenseNumber = String(licInput?.value || '').trim();
          if (!fullName || !abbreviations || !licenseNumber) {
            if (errBox) { errBox.textContent = 'All fields are required.'; errBox.style.display = 'block'; }
            return;
          }
          try {
            await apiPut('/api/doctors/me', { fullName, abbreviations, licenseNumber });
            // Update header with new full name and abbreviations
            updateDoctorHeader(fullName, abbreviations);
            // Re-enable background content
            if (content) {
              content.style.pointerEvents = 'auto';
              content.style.opacity = '1';
            }
            try { document.body.removeChild(overlay); } catch (_) { }
          } catch (err) {
            if (errBox) { errBox.textContent = (err && err.message) || 'Failed to save. Please try again.'; errBox.style.display = 'block'; }
          }
        });
      }

      const apptCreateBtn = document.getElementById('appt-create-btn');
      if (apptCreateBtn) {
        apptCreateBtn.addEventListener('click', async () => {
          const overlay = document.createElement('div');
          overlay.className = 'modal-backdrop';
          overlay.style.zIndex = '2300';
          overlay.innerHTML = `
            <div class="modal-card narrow" role="dialog" aria-modal="true" aria-labelledby="ca-title">
              <div class="modal-header">
                <div class="modal-title" id="ca-title">Create Appointment</div>
                <button id="ca-close" class="btn-secondary btn-small">Close</button>
              </div>
              <div class="modal-body" style="max-height:none;">
                <form id="ca-form" class="form-grid">
                  <div class="field col-span-2">
                    <label for="ca-patient">Patient Full Name</label>
                    <div class="dropdown" id="ca-patient-dd">
                      <input id="ca-patient" type="text" placeholder="Search patient by name..." autocomplete="off" />
                      <ul id="ca-patient-menu" class="dropdown-menu" style="display:none;"></ul>
                    </div>
                  </div>
                  <div class="field">
                    <label for="ca-time-text">Date & time</label>
                    <input id="ca-time-text" type="text" placeholder="Pick date & time" readonly />
                    <input id="ca-time" type="hidden" />
                  </div>
                  <div class="field">
                    <label for="ca-doctor">Doctor</label>
                    <div class="dropdown" id="ca-doc-dd">
                      <input id="ca-doctor" type="text" placeholder="Search doctor by name..." autocomplete="off" />
                      <ul id="ca-doc-menu" class="dropdown-menu" style="display:none;"></ul>
                    </div>
                  </div>
                    <div class="field col-span-2">
                      <label for="ca-chief-complaint">Chief Complaint</label>
                      <textarea id="ca-chief-complaint" placeholder="Enter the patient's chief complaint or reason for visit..." rows="3" style="resize: none; min-height: 80px;"></textarea>
                  </div>
                  <div class="actions col-span-2">
                    <button type="submit">Create</button>
                  </div>
                </form>
              </div>
            </div>`;
          document.body.appendChild(overlay);
          function close() { try { document.body.removeChild(overlay); } catch (_) { } }
          overlay.querySelector('#ca-close')?.addEventListener('click', close);
          const caTime = overlay.querySelector('#ca-time');
          const caTimeText = overlay.querySelector('#ca-time-text');
          if (caTimeText) caTimeText.addEventListener('click', () => {
            const now = new Date();
            openScheduleModal(now, (picked) => {
              if (caTime) caTime.value = picked;
              const d = new Date(picked);
              if (caTimeText) caTimeText.value = `${d.toLocaleDateString()} ${d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            });
          });
          // Populate patient search dropdown
          (async function initPatientSearch() {
            const patientInput = overlay.querySelector('#ca-patient');
            const patientMenu = overlay.querySelector('#ca-patient-menu');
            const patientDd = overlay.querySelector('#ca-patient-dd');
            if (!patientInput || !patientMenu || !patientDd) return;

            let searchTimeout;
            function searchPatients(query) {
              clearTimeout(searchTimeout);
              searchTimeout = setTimeout(async () => {
                try {
                  const patients = await apiGet('/api/patients?q=' + encodeURIComponent(query || ''));
                  const arr = Array.isArray(patients) ? patients : [];
                  // Backend already filters by both username and full name, so just limit results
                  const filtered = query.trim()
                    ? arr.slice(0, 10)
                    : arr.slice(0, 20); // Show up to 20 patients when blank

                  if (filtered.length === 0) {
                    patientMenu.innerHTML = '<li class="muted" style="list-style:none; padding:8px 10px;">No patients found</li>';
                  } else {
                    patientMenu.innerHTML = filtered.map(p => `<li data-value="${p.name}" style="list-style:none; padding:8px 10px; cursor:pointer;">${p.name}</li>`).join('');
                  }

                  // Try to get full names for display
                  try {
                    await Promise.all(filtered.map(async (p) => {
                      try {
                        const prof = await apiGet(`/api/patients/${encodeURIComponent(p.name)}`);
                        const full = (prof && (prof.fullName || prof.name)) || p.name;
                        const li = patientMenu.querySelector(`li[data-value="${p.name}"]`);
                        if (li) li.textContent = full;
                      } catch (_) { }
                    }));
                  } catch (_) { }

                  patientMenu.style.display = 'block';
                } catch (_) {
                  patientMenu.style.display = 'none';
                }
              }, query.trim() ? 300 : 0); // No delay when showing all patients
            }

            function openPatientMenu() { patientMenu.style.display = 'block'; }
            function closePatientMenu() { patientMenu.style.display = 'none'; }

            patientInput.addEventListener('input', (e) => searchPatients(e.target.value));
            patientInput.addEventListener('focus', () => {
              searchPatients(patientInput.value);
            });
            patientInput.addEventListener('click', () => {
              searchPatients(patientInput.value);
            });

            document.addEventListener('click', (ev) => {
              if (!patientDd.contains(ev.target)) closePatientMenu();
            });

            patientMenu.addEventListener('click', (ev) => {
              const li = ev.target.closest('li[data-value]');
              if (!li) return;
              const username = li.getAttribute('data-value');
              const displayName = li.textContent || username;
              patientInput.value = displayName;
              patientInput.setAttribute('data-username', username);
              closePatientMenu();
            });
          })();

          // Populate doctor search dropdown
          (async function initDoctorSearch() {
            const doctorInput = overlay.querySelector('#ca-doctor');
            const doctorMenu = overlay.querySelector('#ca-doc-menu');
            const doctorDd = overlay.querySelector('#ca-doc-dd');
            if (!doctorInput || !doctorMenu || !doctorDd) return;

            let allDoctors = [];
            let searchTimeout;

            // Load all doctors initially
            try {
              const docs = await apiGet('/api/doctors');
              allDoctors = Array.isArray(docs) ? docs : [];
            } catch (_) { }

            function searchDoctors(query) {
              clearTimeout(searchTimeout);
              searchTimeout = setTimeout(() => {
                const lowerQuery = query.toLowerCase().trim();
                const filtered = lowerQuery
                  ? allDoctors.filter(d => {
                    const displayName = d.fullName || d.name || '';
                    const username = d.name || '';
                    return displayName.toLowerCase().includes(lowerQuery) || username.toLowerCase().includes(lowerQuery);
                  }).slice(0, 10)
                  : allDoctors.slice(0, 20); // Show up to 20 doctors when blank

                if (filtered.length === 0) {
                  doctorMenu.innerHTML = '<li class="muted" style="list-style:none; padding:8px 10px;">No doctors found</li>';
                } else {
                  doctorMenu.innerHTML = filtered.map(d => {
                    const displayName = d.fullName || d.name;
                    return `<li data-value="${d.name}" data-display="${displayName}" style="list-style:none; padding:8px 10px; cursor:pointer;">${displayName}</li>`;
                  }).join('');
                }

                doctorMenu.style.display = 'block';
              }, query.trim() ? 300 : 0); // No delay when showing all doctors
            }

            function openDoctorMenu() { doctorMenu.style.display = 'block'; }
            function closeDoctorMenu() { doctorMenu.style.display = 'none'; }

            doctorInput.addEventListener('input', (e) => searchDoctors(e.target.value));
            doctorInput.addEventListener('focus', () => {
              searchDoctors(doctorInput.value);
            });
            doctorInput.addEventListener('click', () => {
              searchDoctors(doctorInput.value);
            });

            document.addEventListener('click', (ev) => {
              if (!doctorDd.contains(ev.target)) closeDoctorMenu();
            });

            doctorMenu.addEventListener('click', (ev) => {
              const li = ev.target.closest('li[data-value]');
              if (!li) return;
              const doctorUsername = li.getAttribute('data-value');
              const displayName = li.getAttribute('data-display') || doctorUsername;
              doctorInput.value = displayName;
              doctorInput.setAttribute('data-doctor', doctorUsername);
              closeDoctorMenu();
            });
          })();
          const form = overlay.querySelector('#ca-form');
          if (form) {
            form.addEventListener('submit', async (e) => {
              e.preventDefault();
              const nameInput = overlay.querySelector('#ca-patient');
              const doctorInput = overlay.querySelector('#ca-doctor');
              const chiefComplaintInput = overlay.querySelector('#ca-chief-complaint');
              const patientFullName = (nameInput?.value || '').trim();
              const time = (caTime?.value || '').trim();
              const doctorName = (doctorInput?.value || '').trim();
              const chiefComplaint = (chiefComplaintInput?.value || '').trim();
              if (!patientFullName) { showDoctorFeedbackModal('Create Appointment', 'Select a patient', 'warning'); return; }
              if (!time) { showDoctorFeedbackModal('Create Appointment', 'Pick a date & time', 'warning'); return; }
              if (!doctorName) { showDoctorFeedbackModal('Create Appointment', 'Select a doctor', 'warning'); return; }
              try {
                // Use the selected patient's username and doctor's name from the dropdowns
                const username = nameInput?.getAttribute('data-username') || patientFullName;
                const doctor = doctorInput?.getAttribute('data-doctor') || doctorName;
                await apiPost('/api/appointments', { patientName: username, time, chiefComplaint, doctorName: doctor });
                showDoctorFeedbackModal('Appointment Created', 'Appointment created successfully', 'success');
                close();
                await refresh();
              } catch (err) {
                showDoctorFeedbackModal('Create Appointment Error', (err && err.message) || 'Failed to create', 'error');
              }
            });
          }
        });
      }

      // Helper function to check for duplicate patients on client side
      async function checkForDuplicatePatient(fullName, email, phone) {
        try {
          const response = await fetch('/api/patients', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          if (!response.ok) return null;

          const patients = await response.json();
          const normalizedFullName = fullName.toLowerCase().trim();
          const normalizedEmail = email.toLowerCase().trim();
          const normalizedPhone = phone.trim();

          for (const patient of patients) {
            try {
              const profile = await apiGet(`/api/patients/${encodeURIComponent(patient.name)}`);
              if (profile) {
                // Check full name
                if (normalizedFullName && profile.fullName) {
                  const existingFullName = profile.fullName.toLowerCase().trim();
                  if (existingFullName === normalizedFullName) {
                    return { duplicate: true, field: 'fullName', value: profile.fullName, username: patient.name };
                  }
                }

                // Check email
                if (normalizedEmail && profile.email) {
                  const existingEmail = profile.email.toLowerCase().trim();
                  if (existingEmail === normalizedEmail) {
                    return { duplicate: true, field: 'email', value: profile.email, username: patient.name };
                  }
                }

                // Check phone
                if (normalizedPhone && profile.phone) {
                  const existingPhone = profile.phone.trim();
                  if (existingPhone === normalizedPhone) {
                    return { duplicate: true, field: 'phone', value: profile.phone, username: patient.name };
                  }
                }
              }
            } catch (_) {
              // Continue checking other patients if one fails
            }
          }
          return { duplicate: false };
        } catch (_) {
          return null; // If check fails, let server handle it
        }
      }

      (function initAddPatient() {
        const form = document.getElementById('nurse-add-patient');
        if (!form) return;
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const f = document.getElementById('nap-fullName');
          const em = document.getElementById('nap-email');
          const ph = document.getElementById('nap-phone');
          const ad = document.getElementById('nap-address');
          const dob = document.getElementById('nap-dob');
          const gen = document.getElementById('nap-gender');
          const bt = document.getElementById('nap-bloodType');
          const fullName = (f && f.value || '').trim();
          const email = (em && em.value || '').trim();
          const phone = (ph && ph.value || '').trim();
          const address = (ad && ad.value || '').trim();
          const dobStr = (dob && dob.value || '').trim();
          const gender = (gen && gen.value || '').trim();
          const bloodType = (bt && bt.value || '').trim();
          if (!fullName) { showDoctorFeedbackModal('Create Patient', 'Full name is required', 'warning'); return; }

          // Check for duplicates on client side first
          const duplicateCheck = await checkForDuplicatePatient(fullName, email, phone);
          if (duplicateCheck && duplicateCheck.duplicate) {
            const fieldName = duplicateCheck.field === 'fullName' ? 'Full name' :
              duplicateCheck.field === 'email' ? 'Email' : 'Phone number';
            showDoctorFeedbackModal('Duplicate Patient', `A patient with this ${fieldName.toLowerCase()} already exists (${duplicateCheck.value})`, 'warning');
            return;
          }
          const base = fullName.toLowerCase().replace(/[^a-z]+/g, ' ').trim().split(/\s+/).slice(0, 2).join('.');
          const rand = Math.floor(100 + Math.random() * 900);
          const username = (base || 'patient') + '.' + rand;
          const password = 'pw' + Math.random().toString(36).slice(2, 8) + '!';
          try {
            await apiPost('/api/users/patients', { username, password, fullName, email, phone });
            const payload = { fullName, email, phone, address, dob: dobStr, gender, bloodType };
            await apiPut(`/api/patients/${encodeURIComponent(username)}`, payload);
            if (f) f.value = '';
            if (em) em.value = '';
            if (ph) ph.value = '';
            if (ad) ad.value = '';
            if (dob) dob.value = '';
            if (gen) gen.value = '';
            if (bt) bt.value = '';
            showDoctorFeedbackModal('Patient Created', `Patient created: ${fullName}`, 'success');
            try { await refresh(); } catch (_) { }
          } catch (err) {
            let errorMessage = 'Failed to create patient';
            if (err && err.message) {
              errorMessage = err.message;
            } else if (err && err.error) {
              errorMessage = err.error;
            }
            showDoctorFeedbackModal('Create Patient Error', errorMessage, 'error');
          }
        });
      })();


      (function initAddStaff() {
        const form = document.getElementById('create-doctor-account');
        if (!form) return;
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const u = document.getElementById('doc-new-username');
          const p = document.getElementById('doc-password');
          const errorDiv = document.getElementById('doc-error');
          const submitBtn = form.querySelector('button[type="submit"]');

          const username = (u && u.value || '').trim();
          const password = (p && p.value || '').trim();

          if (!username || !password) {
            showDoctorFeedbackModal('Create Doctor', 'Username and password are required', 'warning');
            return;
          }

          // Disable submit button during request
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
          }
          if (errorDiv) errorDiv.style.display = 'none';

          try {
            // Create the user account
            await apiPost('/api/users', { username, password, newRole: 'doctor' });

            // Clear form fields
            if (u) u.value = '';
            if (p) p.value = '';

            showDoctorFeedbackModal('Doctor Created', 'Doctor account created successfully. They will complete their profile on first login.', 'success');
          } catch (err) {
            if (errorDiv) {
              errorDiv.textContent = (err && err.message) || 'Failed to create doctor';
              errorDiv.style.display = 'block';
            }
            showDoctorFeedbackModal('Create Doctor Error', (err && err.message) || 'Failed to create doctor', 'error');
          } finally {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'Create Doctor';
            }
          }
        });
      })();

      // Cache clearing functionality
      // Make the function globally available for console access
      window.clearPatientCache = function clearPatientCache() {
        try {
          // Clear all patient-related localStorage data
          const keysToRemove = [];
          const allKeys = Object.keys(localStorage);

          // Find all keys related to patient data
          for (const key of allKeys) {
            if (
              key.startsWith('nurse_vitals_') ||
              key.startsWith('vitals_appt_') ||
              key.startsWith('diagnosis_') ||
              key.startsWith('patient_') ||
              key.includes('_vitals_') ||
              key.includes('_appt_') ||
              key.includes('_diagnosis_')
            ) {
              keysToRemove.push(key);
            }
          }

          // Remove all identified keys
          keysToRemove.forEach(key => {
            localStorage.removeItem(key);
          });

          // Clear in-memory caches
          cachedAppts = [];
          cachedDiagnoses = [];
          apptOptionsCache = [];

          return {
            success: true,
            clearedCount: keysToRemove.length,
            clearedKeys: keysToRemove
          };

        } catch (err) {
          return {
            success: false,
            error: err.message || 'Unknown error'
          };
        }
      }

      // Function to get cache statistics
      window.getCacheStats = function getCacheStats() {
        const allKeys = Object.keys(localStorage);
        const patientKeys = allKeys.filter(key =>
          key.startsWith('nurse_vitals_') ||
          key.startsWith('vitals_appt_') ||
          key.startsWith('diagnosis_') ||
          key.startsWith('patient_') ||
          key.includes('_vitals_') ||
          key.includes('_appt_') ||
          key.includes('_diagnosis_')
        );

        let totalSize = 0;
        patientKeys.forEach(key => {
          const value = localStorage.getItem(key);
          if (value) {
            totalSize += key.length + value.length;
          }
        });

        return {
          totalKeys: allKeys.length,
          patientKeys: patientKeys.length,
          estimatedSize: Math.round(totalSize / 1024 * 100) / 100, // KB
          keys: patientKeys
        };
      };

      // Function to update cache statistics display
      function updateCacheStats() {
        const stats = window.getCacheStats();
        const countEl = document.getElementById('cache-count');
        const sizeEl = document.getElementById('cache-size');

        if (countEl) {
          countEl.textContent = `${stats.patientKeys} patient items cached`;
        }
        if (sizeEl) {
          sizeEl.textContent = `${stats.estimatedSize} KB`;
        }
      }

      (function initCacheClear() {
        const clearCacheBtn = document.getElementById('clear-cache-btn');
        const refreshStatsBtn = document.getElementById('refresh-cache-stats');

        // Update cache stats on page load
        updateCacheStats();

        if (refreshStatsBtn) {
          refreshStatsBtn.addEventListener('click', updateCacheStats);
        }

        if (!clearCacheBtn) return;

        clearCacheBtn.addEventListener('click', async () => {
          // Show confirmation modal
          const confirmed = await showDoctorConfirmModal(
            'Clear Patient Cache',
            'This will remove all cached patient data including vitals, appointments, and diagnoses from browser storage. This action cannot be undone. Continue?',
            'Clear Cache',
            'Cancel'
          );

          if (!confirmed) return;

          const result = clearPatientCache();

          if (result.success) {
            // Show success message
            showDoctorFeedbackModal(
              'Cache Cleared',
              `Successfully cleared ${result.clearedCount} cached items from browser storage.`,
              'success'
            );

            // Update cache statistics display
            updateCacheStats();

            // Refresh the current view if needed
            if (typeof loadAppointments === 'function') {
              loadAppointments();
            }
            if (typeof loadDiagnoses === 'function') {
              loadDiagnoses();
            }
          } else {
            showDoctorFeedbackModal(
              'Cache Clear Error',
              'Failed to clear cache: ' + result.error,
              'error'
            );
          }
        });
      })();

      // Add keyboard shortcut for cache clearing (Ctrl+Shift+C)
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.key === 'C') {
          e.preventDefault();
          const clearCacheBtn = document.getElementById('clear-cache-btn');
          if (clearCacheBtn) {
            clearCacheBtn.click();
          }
        }
      });

      const list = document.getElementById('appt-list');
      const calGrid = document.getElementById('cal-grid');
      const calTitle = document.getElementById('cal-title');
      const prevBtn = document.getElementById('prev-month');
      const nextBtn = document.getElementById('next-month');
      const patientSearch = document.getElementById('patient-search');
      const patientResults = document.getElementById('patient-results');
      let currentYear = new Date().getFullYear();
      let currentMonth = new Date().getMonth();
      let cachedAppts = [];
      let cachedDiagnoses = [];
      let selectedDateFilter = '';
      const scheduleHeightVar = '--doctor-schedule-height';

      function updateScheduleHeight() {
        try {
          const container = document.querySelector('.container.wide');
          if (!container) return;
          const containerStyles = window.getComputedStyle(container);
          const paddingTop = parseFloat(containerStyles.paddingTop) || 0;
          const paddingBottom = parseFloat(containerStyles.paddingBottom) || 0;
          const topbar = container.querySelector('.topbar');
          const topbarHeight = topbar ? topbar.getBoundingClientRect().height : 0;
          const spacingAllowance = 132;
          const available = window.innerHeight - topbarHeight - paddingTop - paddingBottom - spacingAllowance;
          const minHeight = 420;
          const maxHeight = 660;
          const scheduleHeight = Math.max(minHeight, Math.min(maxHeight, available));
          document.documentElement.style.setProperty(scheduleHeightVar, `${scheduleHeight}px`);
        } catch (_) { }
      }

      updateScheduleHeight();
      window.addEventListener('load', updateScheduleHeight);
      window.addEventListener('resize', updateScheduleHeight);
      const orientationQuery = window.matchMedia && window.matchMedia('(orientation: landscape)');
      if (orientationQuery) {
        if (orientationQuery.addEventListener) {
          orientationQuery.addEventListener('change', updateScheduleHeight);
        } else if (orientationQuery.addListener) {
          orientationQuery.addListener(updateScheduleHeight);
        }
      }

      function formatYYYYMMDD(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
      }

      function parseApptDate(appt) {
        const [datePart, timePart] = appt.time.split(' ');
        const [y, m, day] = datePart.split('-').map(Number);
        const [hh, mm] = (timePart || '00:00').split(':').map(Number);
        return new Date(y, m - 1, day, hh || 0, mm || 0);
      }
      function formatDow(d) {
        try { return d.toLocaleDateString(undefined, { weekday: 'short' }); } catch (_) { return ''; }
      }
      function relativeTime(targetDate) {
        const now = new Date();
        const diffMs = targetDate.getTime() - now.getTime();
        const abs = Math.abs(diffMs);
        const past = diffMs < 0;
        const minute = 60 * 1000;
        const hour = 60 * minute;
        const day = 24 * hour;
        let value; let unit;
        if (abs >= day) { value = Math.round(abs / day); unit = 'd'; }
        else if (abs >= hour) { value = Math.round(abs / hour); unit = 'h'; }
        else { value = Math.max(1, Math.round(abs / minute)); unit = 'm'; }
        return past ? `${value}${unit} ago` : `in ${value}${unit}`;
      }

      function renderCalendar(appts) {
        cachedAppts = appts;
        const first = new Date(currentYear, currentMonth, 1);
        const firstDay = first.getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const prevMonthDays = new Date(currentYear, currentMonth, 0).getDate();
        const startOffset = firstDay;
        const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        calTitle.textContent = `${first.toLocaleString('default', { month: 'long' })} ${currentYear}`;
        calGrid.innerHTML = weekdays.map(w => `<div class="cal-weekday">${w}</div>`).join('');
        const cells = [];
        for (let i = 0; i < startOffset; i++) {
          const dayNum = prevMonthDays - startOffset + i + 1;
          cells.push({ outside: true, date: new Date(currentYear, currentMonth - 1, dayNum), displayDay: dayNum });
        }
        for (let d = 1; d <= daysInMonth; d++) {
          cells.push({ outside: false, date: new Date(currentYear, currentMonth, d), displayDay: d });
        }
        const totalCells = Math.ceil((cells.length) / 7) * 7;
        const weeks = totalCells / 7;
        calGrid.style.setProperty('--cal-week-count', weeks);
        // Add next month days directly to HTML
        let nextMonthHTML = '';
        for (let i = cells.length; i < totalCells; i++) {
          const dayNum = i - cells.length + 1;
          nextMonthHTML += `
            <div class="cal-day outside" data-date="next-${dayNum}">
              <div class="date">${dayNum}</div>
              <div class="cal-events"></div>
            </div>
          `;
        }
        const byDate = {};
        for (const a of appts) {
          const d = parseApptDate(a);
          const key = formatYYYYMMDD(d);
          (byDate[key] ||= []).push(a);
        }
        calGrid.innerHTML += cells.map(cell => {
          const key = formatYYYYMMDD(cell.date);
          const dayAppts = (byDate[key] || []).sort((a, b) => parseApptDate(a) - parseApptDate(b));
          let summary = '';
          if (dayAppts.length === 1) {
            const firstAppt = dayAppts[0];
            const d1 = new Date(parseApptDate(firstAppt));
            const t1 = d1.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            summary = `<div class=\"cal-event mini info\" data-appt-id=\"${firstAppt.id}\"><span class=\"time\">${t1}</span><span class=\"who\">#${firstAppt.id}</span></div>`;
          } else if (dayAppts.length > 1) {
            const firstAppt = dayAppts[0];
            const lastAppt = dayAppts[dayAppts.length - 1];
            const d1 = new Date(parseApptDate(firstAppt));
            const d2 = new Date(parseApptDate(lastAppt));
            const t1 = d1.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const t2 = d2.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            summary = `
              <div class=\"cal-event mini success\" data-appt-id=\"${firstAppt.id}\"><span class=\"time\">${t1}</span><span class=\"who\">#${firstAppt.id}</span></div>
              <div class=\"cal-event mini danger\" data-appt-id=\"${lastAppt.id}\"><span class=\"time\">${t2}</span><span class=\"who\">#${lastAppt.id}</span></div>
            `;
          }
          const isSelected = selectedDateFilter && key === selectedDateFilter;
          const selStyle = isSelected ? 'style="outline:2px solid #2563eb; outline-offset:-2px; border-radius:6px;"' : '';
          const count = dayAppts.length;
          const countHtml = count > 0 ? `<span class=\"cal-count\">${count}</span>` : '';
          return `
            <div class="cal-day ${cell.outside ? 'outside' : ''}" data-date="${key}" ${selStyle}>
              <div class="date">${cell.displayDay || cell.date.getDate()}</div>
              ${countHtml}
              <div class="cal-events">${summary}</div>
            </div>
          `;
        }).join('') + nextMonthHTML;
      }

      prevBtn.addEventListener('click', () => {
        currentMonth--;
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        renderCalendar(cachedAppts);
      });

      nextBtn.addEventListener('click', () => {
        currentMonth++;
        if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        renderCalendar(cachedAppts);
      });

      const modal = document.createElement('div');
      modal.id = 'appt-modal';
      modal.className = 'modal-backdrop';
      modal.style.display = 'none';
      modal.innerHTML = `
        <div class="modal-card" id="modal-card" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-body">
          <div class="modal-header">
            <div class="modal-title-wrap">
              <div id="modal-avatar" class="modal-avatar"></div>
              <div>
                <div id="modal-title" class="modal-title">Appointment Details</div>
                <div id="modal-sub" class="modal-sub who"></div>
              </div>
            </div>
            <button id="close-modal" class="btn-secondary btn-small">Close</button>
          </div>
          <div id="modal-body" class="modal-body"></div>
        </div>`;
      document.body.appendChild(modal);

      let lastFocusedBeforeModal = null;
      let modalKeydownHandler = null;

      function getFocusableElements(root) {
        return Array.from(root.querySelectorAll('a[href], button, textarea, input, select, [tabindex]:not([tabindex="-1"])'))
          .filter(el => !el.hasAttribute('disabled') && !el.getAttribute('aria-hidden'));
      }

      function openModal(contentHtml, details) {
        const body = document.getElementById('modal-body');
        body.innerHTML = contentHtml;
        const card = document.getElementById('modal-card');
        if (card) {
          card.classList.remove('is-success', 'is-error', 'is-warning', 'is-info', 'wide');
        }
        if (details) {
          const avatar = document.getElementById('modal-avatar');
          const title = document.getElementById('modal-title');
          const sub = document.getElementById('modal-sub');
          if (avatar) avatar.textContent = (details.avatarText || '?').slice(0, 1).toUpperCase();
          if (title && details.title) title.textContent = details.title;
          if (sub) sub.textContent = details.subtitle || '';
          if (card && details.variant) {
            const v = String(details.variant);
            if (v === 'success') card.classList.add('is-success');
            else if (v === 'error') card.classList.add('is-error');
            else if (v === 'warning') card.classList.add('is-warning');
            else if (v === 'info') card.classList.add('is-info');
          }
          if (card) {
            const isFeedback = details && ['success', 'error', 'warning', 'info'].includes(String(details.variant || ''));
            if (details && details.wide === true) card.classList.add('wide');
            else if (!isFeedback && details && details.wide !== false) card.classList.add('wide');
          }
        }
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        lastFocusedBeforeModal = document.activeElement;
        const focusables = getFocusableElements(modal);
        const closeBtn = modal.querySelector('#close-modal');
        (closeBtn || focusables[0] || modal).focus();
        modalKeydownHandler = (e) => {
          if (e.key !== 'Tab') return;
          const els = getFocusableElements(modal);
          if (!els.length) { e.preventDefault(); return; }
          const first = els[0];
          const last = els[els.length - 1];
          if (e.shiftKey && document.activeElement === first) {
            e.preventDefault();
            last.focus();
          } else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        };
        document.addEventListener('keydown', modalKeydownHandler);
      }

      function closeModal() {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        if (modalKeydownHandler) {
          document.removeEventListener('keydown', modalKeydownHandler);
          modalKeydownHandler = null;
        }
        if (lastFocusedBeforeModal && typeof lastFocusedBeforeModal.focus === 'function') {
          try { lastFocusedBeforeModal.focus(); } catch (_) { }
        }
      }
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.style.display !== 'none') closeModal(); });
      modal.querySelector('#close-modal').addEventListener('click', closeModal);

      function escapeForHtml(s) {
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }

      function openPrescriptionModal() {
        const existing = document.getElementById('rx-modal');
        if (existing) existing.remove();
        const rx = document.createElement('div');
        rx.id = 'rx-modal';
        rx.className = 'modal-backdrop';
        let pName = '';
        let pSex = '';
        let pAddress = '';
        let pDob = '';
        try {
          const prof = currentPatientProfile;
          pName = (prof && (prof.fullName || prof.name)) || '';
          pSex = (prof && prof.gender) || '';
          pAddress = (prof && (prof.address || prof.location)) || '';
          pDob = (prof && (prof.dob || prof.birthDate)) || '';
        } catch (_) { }
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayVal = `${yyyy}-${mm}-${dd}`;
        rx.innerHTML = `
          <div class="modal-card wide prescription-modal" role="dialog" aria-modal="true">
            <div style="
              padding:12px 16px;
              border-bottom:1px solid var(--border, #e2e8f0);
              display:flex;
              align-items:center;
              justify-content:space-between;
              background:var(--card-alt, #f1f5f9);
              color:var(--text, #0f172a);
            ">
              <div style="font-weight:700; letter-spacing:0.02em;">Prescription</div>
              <div style="display:flex; gap:8px;">
                <button id="rx-print" class="btn-primary btn-small">Print</button>
                <button id="rx-close" class="btn-secondary btn-small">Close</button>
              </div>
            </div>
            <div style="padding:16px 20px; display:grid; gap:16px; background:var(--card, #ffffff); color:var(--text, #0f172a);">
              <div class="section-title" style="margin-bottom:0;"><h3>Medicines</h3></div>
              <div style="overflow:auto; margin-top:-8px; border:1px solid var(--border, #e2e8f0); border-radius:12px; background:var(--bg-soft, #0f172a);">
                <table style="width:100%; border-collapse:collapse; color:var(--text, #0f172a);">
                  <thead>
                    <tr>
                      <th style="text-align:left; border-bottom:1px solid var(--border, #e2e8f0); padding:8px; background:var(--card-alt, #f1f5f9);">Medicine & Dose</th>
                      <th style="text-align:left; border-bottom:1px solid var(--border, #e2e8f0); padding:8px; width:80px; background:var(--card-alt, #f1f5f9);">Qty</th>
                      <th style="text-align:center; border-bottom:1px solid var(--border, #e2e8f0); padding:8px; background:var(--card-alt, #f1f5f9);" colspan="2">Breakfast</th>
                      <th style="text-align:center; border-bottom:1px solid var(--border, #e2e8f0); padding:8px; background:var(--card-alt, #f1f5f9);" colspan="2">Lunch</th>
                      <th style="text-align:center; border-bottom:1px solid var(--border, #e2e8f0); padding:8px; background:var(--card-alt, #f1f5f9);" colspan="2">Dinner</th>
                      <th style="text-align:center; border-bottom:1px solid var(--border, #e2e8f0); padding:8px; background:var(--card-alt, #f1f5f9);">Bedtime</th>
                      <th style="text-align:center; vertical-align:middle; border-bottom:1px solid var(--border, #e2e8f0); padding:8px; background:var(--card-alt, #f1f5f9);" rowspan="2">Meal Notes</th>
                    </tr>
                    <tr>
                      <th></th>
                      <th></th>
                      <th style="text-align:center; padding:4px 8px; color:var(--muted, #64748b); background:var(--card-alt, #f1f5f9);">Before</th>
                      <th style="text-align:center; padding:4px 8px; color:var(--muted, #64748b); background:var(--card-alt, #f1f5f9);">After</th>
                      <th style="text-align:center; padding:4px 8px; color:var(--muted, #64748b); background:var(--card-alt, #f1f5f9);">Before</th>
                      <th style="text-align:center; padding:4px 8px; color:var(--muted, #64748b); background:var(--card-alt, #f1f5f9);">After</th>
                      <th style="text-align:center; padding:4px 8px; color:var(--muted, #64748b); background:var(--card-alt, #f1f5f9);">Before</th>
                      <th style="text-align:center; padding:4px 8px; color:var(--muted, #64748b); background:var(--card-alt, #f1f5f9);">After</th>
                      <th style="text-align:center; padding:4px 8px; color:var(--muted, #64748b); background:var(--card-alt, #f1f5f9);">Before</th>
                    </tr>
                  </thead>
                  <tbody id="rx-rows">
                    ${Array.from({ length: 5 }).map((_, i) => `
                      <tr>
                        <td style="padding:8px; border-bottom:1px solid var(--border, #e2e8f0);">
                          <div style="display:flex; gap:8px; align-items:center;">
                            <input type="text" class="rx-med" placeholder="e.g., Amoxicillin 500mg, 1 cap"
                              style="flex:2; min-width:0; background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; color:var(--text, #0f172a);" />
                            <input type="text" class="rx-note" placeholder="Notes (optional)"
                              style="flex:1; min-width:120px; background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; color:var(--text, #0f172a);" />
                          </div>
                        </td>
                        <td style="padding:8px; border-bottom:1px solid var(--border, #e2e8f0);">
                          <input type="number" min="1" class="rx-qty" placeholder="1"
                            style="width:72px; background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; color:var(--text, #0f172a);" />
                        </td>
                        <td style="text-align:center; border-bottom:1px solid var(--border, #e2e8f0);"><input type="checkbox" class="rx-bb" /></td>
                        <td style="text-align:center; border-bottom:1px solid var(--border, #e2e8f0);"><input type="checkbox" class="rx-ba" /></td>
                        <td style="text-align:center; border-bottom:1px solid var(--border, #e2e8f0);"><input type="checkbox" class="rx-lb" /></td>
                        <td style="text-align:center; border-bottom:1px solid var(--border, #e2e8f0);"><input type="checkbox" class="rx-la" /></td>
                        <td style="text-align:center; border-bottom:1px solid var(--border, #e2e8f0);"><input type="checkbox" class="rx-db" /></td>
                        <td style="text-align:center; border-bottom:1px solid var(--border, #e2e8f0);"><input type="checkbox" class="rx-da" /></td>
                        <td style="text-align:center; border-bottom:1px solid var(--border, #e2e8f0);"><input type="checkbox" class="rx-btb" /></td>
                        <td style="padding:8px; border-bottom:1px solid var(--border, #e2e8f0);">
                          <input type="text" class="rx-meal-note" placeholder="Meal notes (optional)"
                            style="width:100%; background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; color:var(--text, #0f172a);" />
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
              <div style="display:flex; gap:8px; align-items:center; justify-content:space-between;">
                <div style="display:flex; gap:8px; align-items:center;">
                  <label for="rx-followup-text" style="font-size:14px; white-space:nowrap;">Follow-up:</label>
                  <input id="rx-followup-text" type="text" placeholder="Pick date" readonly style="padding:8px 10px; border:1px solid var(--border, #e2e8f0); border-radius:10px; font-size:14px; cursor:pointer; width:160px; background:var(--card, #ffffff); color:var(--text, #0f172a);" />
                  <input id="rx-followup" type="hidden" />
                </div>
                <div style="display:flex; gap:8px;">
                  <button id="rx-add-row" class="btn-secondary btn-small">Add Row</button>
                  <button id="rx-remove-row" class="btn-secondary btn-small">Remove Row</button>
                  <button id="rx-clear" class="btn-secondary btn-small">Clear</button>
                </div>
              </div>
            </div>
          </div>`;
        document.body.appendChild(rx);

        const closeBtn = rx.querySelector('#rx-close');
        const addBtn = rx.querySelector('#rx-add-row');
        const removeBtn = rx.querySelector('#rx-remove-row');
        const clearBtn = rx.querySelector('#rx-clear');
        const printBtn = rx.querySelector('#rx-print');
        const rowsTbody = rx.querySelector('#rx-rows');
        const msg = rx.querySelector('#rx-msg');
        const followText = rx.querySelector('#rx-followup-text');
        const followHidden = rx.querySelector('#rx-followup');
        closeBtn?.addEventListener('click', () => rx.remove());
        if (followText) {
          followText.addEventListener('click', () => {
            const now = new Date();
            openDateOnlyModal(now, (picked) => {
              const d = new Date(picked);
              const dateOnly = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
              if (followHidden) followHidden.value = dateOnly;
              followText.value = d.toLocaleDateString();
            });
          });
        }
        addBtn?.addEventListener('click', (e) => {
          e.preventDefault();
          const rows = rowsTbody?.querySelectorAll('tr');
          if (rows && rows.length >= 5) {
            showDoctorFeedbackModal('Add Row', 'Cannot add more rows. Maximum 5 rows allowed.', 'warning');
            return;
          }
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;">
              <div style="display:flex; gap:8px; align-items:center;">
                <input type="text" class="rx-med" placeholder="e.g., Paracetamol 500mg, 1 tab" style="flex:2; min-width:0;" />
                <input type="text" class="rx-note" placeholder="Notes (optional)" style="flex:1; min-width:120px;" />
              </div>
            </td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"><input type="number" min="1" class="rx-qty" placeholder="1" style="width:72px;" /></td>
            <td style="text-align:center; border-bottom:1px solid #f1f5f9;"><input type="checkbox" class="rx-bb" /></td>
            <td style="text-align:center; border-bottom:1px solid #f1f5f9;"><input type="checkbox" class="rx-ba" /></td>
            <td style="text-align:center; border-bottom:1px solid #f1f5f9;"><input type="checkbox" class="rx-lb" /></td>
            <td style="text-align:center; border-bottom:1px solid #f1f5f9;"><input type="checkbox" class="rx-la" /></td>
            <td style="text-align:center; border-bottom:1px solid #f1f5f9;"><input type="checkbox" class="rx-db" /></td>
            <td style="text-align:center; border-bottom:1px solid #f1f5f9;"><input type="checkbox" class="rx-da" /></td>
            <td style="text-align:center; border-bottom:1px solid #f1f5f9;"><input type="checkbox" class="rx-btb" /></td>
            <td style="padding:6px 8px; border-bottom:1px solid #f1f5f9;"><input type="text" class="rx-meal-note" placeholder="Meal notes (optional)" style="width:100%;" /></td>`;
          rowsTbody?.appendChild(tr);
        });
        removeBtn?.addEventListener('click', (e) => {
          e.preventDefault();
          const rows = rowsTbody?.querySelectorAll('tr');
          if (rows && rows.length > 1) {
            rows[rows.length - 1].remove();
          } else {
            showDoctorFeedbackModal('Remove Row', 'Cannot remove row. Minimum 1 row required.', 'warning');
          }
        });
        clearBtn?.addEventListener('click', (e) => {
          e.preventDefault();
          rx.querySelectorAll('input').forEach((inp) => { if (inp.type === 'checkbox') inp.checked = false; else inp.value = ''; });
        });
        printBtn?.addEventListener('click', async () => {

          let name = pName || '';
          let sex = pSex || '';
          let dob = pDob || '';
          let address = pAddress || '';

          try {
            if (!name && appt && appt.patientName) {
              const prof2 = await apiGet(`/api/patients/${encodeURIComponent(appt.patientName)}`);
              if (prof2) {
                name = prof2.fullName || prof2.name || appt.patientName || name;
                sex = sex || prof2.gender || '';
                address = address || prof2.address || prof2.location || '';
                dob = dob || prof2.dob || prof2.birthDate || '';
              }
            }
          } catch (_) { }

          if (!name && appt && appt.patientName) name = appt.patientName;
          const dateVal = todayVal;
          const notes = '';

          if (!name && !sex && !dob) {
            showDoctorFeedbackModal('Prescription', 'Patient information not available. Please ensure patient profile is complete.', 'error');
            return;
          }
          const items = Array.from(rx.querySelectorAll('#rx-rows tr')).map((tr) => {
            const med = (tr.querySelector('.rx-med')?.value || '').trim();
            const qty = (tr.querySelector('.rx-qty')?.value || '').trim();
            const note = (tr.querySelector('.rx-note')?.value || '').trim();
            const mealNote = (tr.querySelector('.rx-meal-note')?.value || '').trim();
            const bb = tr.querySelector('.rx-bb')?.checked ? '' : '';
            const ba = tr.querySelector('.rx-ba')?.checked ? '' : '';
            const lb = tr.querySelector('.rx-lb')?.checked ? '' : '';
            const la = tr.querySelector('.rx-la')?.checked ? '' : '';
            const db = tr.querySelector('.rx-db')?.checked ? '' : '';
            const da = tr.querySelector('.rx-da')?.checked ? '' : '';
            const btb = tr.querySelector('.rx-btb')?.checked ? '' : '';
            return { med, qty, note, mealNote, bb, ba, lb, la, db, da, btb };
          }).filter(r => r.med);
          if (!items.length) { showDoctorFeedbackModal('Prescription', 'Enter at least one medicine', 'error'); return; }

          const medsTable = `
            <table style="width:100%; border-collapse:collapse; font-size:14px;">
              <thead>
                <tr>
                  <th style=\"text-align:left; border-bottom:1px solid #e5e7eb; padding:6px 8px;\">Medicine and Dose</th>
                  <th style=\"text-align:left; border-bottom:1px solid #e5e7eb; padding:6px 8px; width:80px;\">Qty</th>
                  <th style=\"text-align:center; border-bottom:1px solid #e5e7eb; padding:6px 8px;\" colspan=\"2\">Breakfast</th>
                  <th style=\"text-align:center; border-bottom:1px solid #e5e7eb; padding:6px 8px;\" colspan=\"2\">Lunch</th>
                  <th style=\"text-align:center; border-bottom:1px solid #e5e7eb; padding:6px 8px;\" colspan=\"2\">Dinner</th>
                  <th style=\"text-align:center; border-bottom:1px solid #e5e7eb; padding:6px 8px;\">Bedtime</th>
                </tr>
                <tr>
                  <th></th><th></th>
                  <th style=\"text-align:center; padding:4px 8px;\">Before</th>
                  <th style=\"text-align:center; padding:4px 8px;\">After</th>
                  <th style=\"text-align:center; padding:4px 8px;\">Before</th>
                  <th style=\"text-align:center; padding:4px 8px;\">After</th>
                  <th style=\"text-align:center; padding:4px 8px;\">Before</th>
                  <th style=\"text-align:center; padding:4px 8px;\">After</th>
                  <th style=\"text-align:center; padding:4px 8px;\">Before</th>
                </tr>
              </thead>
              <tbody>
                ${items.map((r, idx) => `
                  <tr>
                    <td style=\"padding:6px 8px; border-bottom:1px solid #f1f5f9;\"><div style=\"display:flex; gap:8px; align-items:center;\"><span style=\"opacity:0.6;\">${idx + 1}.</span><div style=\"flex:1;\">${escapeForHtml(r.med)}</div></div></td>
                    <td style=\"padding:6px 8px; border-bottom:1px solid #f1f5f9;\">${escapeForHtml(r.qty || '')}</td>
                    <td style=\"text-align:center; border-bottom:1px solid #f1f5f9;\">${r.bb}</td>
                    <td style=\"text-align:center; border-bottom:1px solid #f1f5f9;\">${r.ba}</td>
                    <td style=\"text-align:center; border-bottom:1px solid #f1f5f9;\">${r.lb}</td>
                    <td style=\"text-align:center; border-bottom:1px solid #f1f5f9;\">${r.la}</td>
                    <td style=\"text-align:center; border-bottom:1px solid #f1f5f9;\">${r.db}</td>
                    <td style=\"text-align:center; border-bottom:1px solid #f1f5f9;\">${r.da}</td>
                    <td style=\"text-align:center; border-bottom:1px solid #f1f5f9;\">${r.btb}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>`;

          const patientBlock = `
            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:8px; margin-bottom:8px;">
              <div><strong>Name:</strong> ${escapeForHtml(name)}</div>
              <div><strong>Sex:</strong> ${escapeForHtml(sex)}</div>
              <div><strong>Date:</strong> ${escapeForHtml(new Date(dateVal).toLocaleDateString())}</div>
            </div>
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:8px; margin-bottom:8px;">
              <div><strong>Address:</strong> ${escapeForHtml(address)}</div>
              <div><strong>DOB:</strong> ${escapeForHtml(new Date(dob).toLocaleDateString())}</div>
            </div>`;

          const followupDate = (rx.querySelector('#rx-followup')?.value || '').trim();

          const params = new URLSearchParams();
          if (name) params.set('name', name);
          if (sex) params.set('sex', sex);
          if (address) params.set('address', address);
          if (dob) params.set('dob', dob);
          if (dateVal) params.set('date', dateVal);
          if (followupDate) params.set('followup', followupDate);

          const prescriptionData = {
            medicines: items.map((item, idx) => ({
              number: idx + 1,
              medicine: item.med,
              quantity: item.qty,
              note: item.note || '',
              mealNote: item.mealNote || '',
              breakfast: { before: item.bb === '', after: item.ba === '' },
              lunch: { before: item.lb === '', after: item.la === '' },
              dinner: { before: item.db === '', after: item.da === '' },
              bedtime: { before: item.btb === '' }
            }))
          };
          params.set('prescription', JSON.stringify(prescriptionData));
          params.set('autoprint', '1');

          const href = '/forms/diz/Doc Dizon/Doc Dizon - Medical Prescription/MAIN FORM Doc Dizon - Medical Prescription.html';
          const url = encodeURI(href) + (params.toString() ? (`?${params.toString()}`) : '');

          // Create hidden iframe for printing
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = url;
          document.body.appendChild(iframe);

          // Listen for print completion message
          const messageHandler = function (event) {
            if (event.data === 'print-complete') {
              document.body.removeChild(iframe);
              window.removeEventListener('message', messageHandler);
            }
          };
          window.addEventListener('message', messageHandler);

          // Fallback: remove iframe after timeout
          setTimeout(() => {
            if (document.body.contains(iframe)) {
              document.body.removeChild(iframe);
              window.removeEventListener('message', messageHandler);
            }
          }, 10000);
        });
      }

      function openExamsModal() {
        const existing = document.getElementById('exams-modal');
        if (existing) existing.remove();
        const ex = document.createElement('div');
        ex.id = 'exams-modal';
        ex.className = 'modal-backdrop';
        let pName = '';
        let pSex = '';
        let pAddress = '';
        let pDob = '';
        try {
          const prof = currentPatientProfile;
          console.log('Lab Form Debug - currentPatientProfile:', prof);
          pName = (prof && (prof.fullName || prof.name)) || '';
          pSex = (prof && prof.gender) || '';
          pAddress = (prof && (prof.address || prof.location)) || '';
          pDob = (prof && (prof.dob || prof.birthDate)) || '';
          console.log('Lab Form Debug - extracted data:', { pName, pSex, pAddress, pDob });
        } catch (_) { }
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayVal = `${yyyy}-${mm}-${dd}`;
        function computeAge(dobStr) {
          if (!dobStr) return '';
          const d = new Date(dobStr);
          if (Number.isNaN(d.getTime())) return '';
          const now = new Date();
          let age = now.getFullYear() - d.getFullYear();
          const m = now.getMonth() - d.getMonth();
          if (m < 0 || (m === 0 && now.getDate() < d.getDate())) age--;
          return String(Math.max(age, 0));
        }
        const initAge = computeAge(pDob);
        ex.innerHTML = `
          <style>
            #ex-scroll-area::-webkit-scrollbar {
              width: 8px;
            }
            #ex-scroll-area::-webkit-scrollbar-track {
              background: var(--bg-soft, #0f172a);
              border-radius: 4px;
            }
            #ex-scroll-area::-webkit-scrollbar-thumb {
              background: var(--border, #e2e8f0);
              border-radius: 4px;
            }
            #ex-scroll-area::-webkit-scrollbar-thumb:hover {
              background: rgba(125, 211, 252, 0.6);
            }
            #ex-scroll-area {
              scrollbar-width: thin;
              scrollbar-color: var(--border, #e2e8f0) var(--bg-soft, #0f172a);
            }
            .ex-select-box::-webkit-scrollbar {
              width: 4px;
            }
            .ex-select-box::-webkit-scrollbar-track {
              background: var(--card, #ffffff);
            }
            .ex-select-box::-webkit-scrollbar-thumb {
              background: var(--border, #e2e8f0);
              border-radius: 2px;
            }
            .ex-select-box::-webkit-scrollbar-thumb:hover {
              background: rgba(125, 211, 252, 0.6);
            }
            .ex-select-box {
              scrollbar-width: thin;
              scrollbar-color: var(--border, #e2e8f0) var(--card, #ffffff);
            }
          </style>
         <div class="modal-card ultra-wide" role="dialog" aria-modal="true" style="max-height: 96vh; display: flex; flex-direction: column; background:var(--card, #ffffff); color:var(--text, #0f172a);">
            <div style="padding:16px 20px; border-bottom:1px solid var(--border, #e2e8f0); display:flex; align-items:center; justify-content:space-between; flex-shrink: 0; background:var(--card-alt, #f1f5f9);">
              <div style="font-weight:700; font-size:16px;">Laboratory Exams</div>
              <div style="display:flex; gap:8px; align-items:center;">
                <button id="ex-open" class="btn-primary btn-small">Print</button>
                <button id="ex-close" class="btn-secondary btn-small">Close</button>
              </div>
            </div>
             <div id="ex-scroll-area" style="padding:16px 20px; overflow:auto; flex:1; min-height:0; background:var(--bg, #ffffff);">
              <div style="display:grid; gap:16px; grid-template-columns:repeat(5, 1fr);">
                <div style="background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:14px; padding:16px; min-height:140px; box-shadow:0 10px 30px rgba(0, 0, 0, 0.1);">
                  <label style="font-size:14px; font-weight:600; color:var(--text, #0f172a); display:block; margin-bottom:8px;">Hematology</label>
                  <select multiple id="ex-hematology" class="ex-select-box" style="width:100%; height:110px; font-size:13px; border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; background:var(--card-alt, #f1f5f9); color:var(--text, #0f172a);">
                    <option value="CBC w/ Platelet Count">CBC w/ Platelet Count</option>
                    <option value="Prothrombin Time">Prothrombin Time</option>
                    <option value="APTT">PTT (APTT)</option>
                    <option value="Clotting Time">Clotting Time</option>
                    <option value="Bleeding Time">Bleeding Time</option>
                    <option value="Peripheral Blood Smear">Peripheral Blood Smear</option>
                    <option value="Blood Typing (RH)">Blood Typing (RH)</option>
                  </select>
                </div>
                <div style="background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:14px; padding:16px; min-height:140px; box-shadow:0 10px 30px rgba(0, 0, 0, 0.1);">
                  <label style="font-size:14px; font-weight:600; color:var(--text, #0f172a); display:block; margin-bottom:8px;">Clinical Microscopy</label>
                  <select multiple id="ex-microscopy" class="ex-select-box" style="width:100%; height:110px; font-size:13px; border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; background:var(--card-alt, #f1f5f9); color:var(--text, #0f172a);">
                    <option value="Urinalysis">Urinalysis</option>
                    <option value="Fecalysis">Fecalysis</option>
                    <option value="Occult Blood">Occult blood</option>
                    <option value="Pregnancy Test (Serum)">Pregnancy Test (Serum)</option>
                    <option value="Pregnancy Test (Urine)">Pregnancy Test (Urine)</option>
                  </select>
                </div>
                <div style="background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:14px; padding:16px; min-height:140px; box-shadow:0 10px 30px rgba(0, 0, 0, 0.1);">
                  <label style="font-size:14px; font-weight:600; color:var(--text, #0f172a); display:block; margin-bottom:8px;">Serology</label>
                  <select multiple id="ex-serology" class="ex-select-box" style="width:100%; height:110px; font-size:13px; border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; background:var(--card-alt, #f1f5f9); color:var(--text, #0f172a);">
                    <option value="Dengue NS1">Dengue NS1</option>
                    <option value="Dengue Duo IgG">Dengue Duo IgG</option>
                    <option value="Dengue Duo IgM">Dengue Duo IgM</option>
                    <option value="VDRL (RPR)">VDRL (RPR)</option>
                    <option value="HBsAg">HBsAg</option>
                    <option value="Rubella IgM">Rubella IgM</option>
                    <option value="Rubella IgG">Rubella IgG</option>
                    <option value="HIV Screening">HIV Screening</option>
                    <option value="CRP Qualitative">CRP Qualitative</option>
                    <option value="CRP Quantitative">CRP Quantitative</option>
                    <option value="ASO Screening">ASO Screening</option>
                    <option value="ASO Titer">ASO Titer</option>
                  </select>
                </div>
                <div style="background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:14px; padding:16px; min-height:140px; box-shadow:0 10px 30px rgba(0, 0, 0, 0.1);">
                  <label style="font-size:14px; font-weight:600; color:var(--text, #0f172a); display:block; margin-bottom:8px;">Bacteriology</label>
                  <select multiple id="ex-bacteriology" class="ex-select-box" style="width:100%; height:110px; font-size:13px; border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; background:var(--card-alt, #f1f5f9); color:var(--text, #0f172a);">
                    <option value="Urine Culture & Sensitivity">Urine C&S</option>
                    <option value="Blood Culture & Sensitivity">Blood C&S</option>
                    <option value="Gram Staining">Gram Staining</option>
                    <option value="KOH Staining">KOH Staining</option>
                    <option value="AFB Staining">AFB Staining</option>
                  </select>
                </div>
                <div style="background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:14px; padding:16px; min-height:140px; box-shadow:0 10px 30px rgba(0, 0, 0, 0.1);">
                  <label style="font-size:14px; font-weight:600; color:var(--text, #0f172a); display:block; margin-bottom:8px;">Clinical Chemistry</label>
                  <select multiple id="ex-chemistry" class="ex-select-box" style="width:100%; height:110px; font-size:13px; border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; background:var(--card-alt, #f1f5f9); color:var(--text, #0f172a);">
                    <option value="Fasting Blood Sugar (FBS)">FBS</option>
                    <option value="Random Blood Sugar (RBS)">RBS</option>
                    <option value="HbA1c">HbA1c</option>
                    <option value="Blood Urea Nitrogen (BUN)">BUN</option>
                    <option value="Uric Acid">Uric Acid</option>
                    <option value="Creatinine">Creatinine</option>
                    <option value="Sodium (Na)">Sodium (Na)</option>
                    <option value="Potassium (K)">Potassium (K)</option>
                    <option value="Chloride (Cl)">Chloride (Cl)</option>
                    <option value="Calcium (Ca)">Calcium (Ca)</option>
                    <option value="Ionized Calcium (iCa)">Ionized Calcium</option>
                    <option value="Phosphorus (P)">Phosphorus (P)</option>
                    <option value="SGOT (AST)">SGOT (AST)</option>
                    <option value="SGPT (ALT)">SGPT (ALT)</option>
                    <option value="Lipid Profile">Lipid Profile</option>
                    <option value="Total Cholesterol">Total Cholesterol</option>
                    <option value="Triglycerides">Triglycerides</option>
                    <option value="HDL">HDL</option>
                    <option value="LDL">LDL</option>
                    <option value="VLDL">VLDL</option>
                    <option value="PSA">PSA</option>
                  </select>
                </div>
                <div style="background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:14px; padding:16px; min-height:140px; box-shadow:0 10px 30px rgba(0, 0, 0, 0.1);">
                  <label style="font-size:14px; font-weight:600; color:var(--text, #0f172a); display:block; margin-bottom:8px;">Enzymes</label>
                  <select multiple id="ex-enzymes" class="ex-select-box" style="width:100%; height:110px; font-size:13px; border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; background:var(--card-alt, #f1f5f9); color:var(--text, #0f172a);">
                    <option value="Alkaline Phosphatase">Alkaline Phosphatase</option>
                    <option value="CPK-MB">CPK-MB</option>
                    <option value="CPK-MM">CPK-MM</option>
                    <option value="GGTP">GGTP</option>
                    <option value="Serum LDH">Serum LDH</option>
                    <option value="SGOT (AST)">SGOT (AST)</option>
                    <option value="SGPT (ALT)">SGPT (ALT)</option>
                    <option value="Total CPK">Total CPK</option>
                    <option value="Troponin I Qualitative">Troponin I Qual.</option>
                    <option value="Troponin I Quantitative">Troponin I Quant.</option>
                  </select>
                </div>
                <div style="background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:14px; padding:16px; min-height:140px; box-shadow:0 10px 30px rgba(0, 0, 0, 0.1);">
                  <label style="font-size:14px; font-weight:600; color:var(--text, #0f172a); display:block; margin-bottom:8px;">Hepatitis</label>
                  <select multiple id="ex-hepatitis" class="ex-select-box" style="width:100%; height:110px; font-size:13px; border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; background:var(--card-alt, #f1f5f9); color:var(--text, #0f172a);">
                    <option value="Anti-HAV lgG">Anti-HAV lgG</option>
                    <option value="Anti-HAV lgM">Anti-HAV lgM</option>
                    <option value="Anti-HBclgG">Anti-HBclgG</option>
                    <option value="Anti-HBclgM">Anti-HBclgM</option>
                    <option value="Anti-HBe">Anti-HBe</option>
                    <option value="Anti-HBs">Anti-HBs</option>
                    <option value="Anti-HCV">Anti-HCV</option>
                    <option value="HBeAg">HBeAg</option>
                    <option value="HBsAg (Confirmatory)">HBsAg (Confirm.)</option>
                    <option value="HBsAg (Screening)">HBsAg (Screen.)</option>
                    <option value="Hepa A & B Profile (1-5 + 7)">Hepa A & B Profile</option>
                    <option value="Hepa A, B, C (1-5, +7, & 9)">Hepa A, B, C</option>
                    <option value="Hepa A Profile (7-8)">Hepa A Profile</option>
                    <option value="Hepa B Full Profile (1-6)">Hepa B Full</option>
                  </select>
                </div>
                <div style="background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:14px; padding:16px; min-height:140px; box-shadow:0 10px 30px rgba(0, 0, 0, 0.1);">
                  <label style="font-size:14px; font-weight:600; color:var(--text, #0f172a); display:block; margin-bottom:8px;">Thyroid Function</label>
                  <select multiple id="ex-thyroid" class="ex-select-box" style="width:100%; height:110px; font-size:13px; border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; background:var(--card-alt, #f1f5f9); color:var(--text, #0f172a);">
                    <option value="FT3">FT3</option>
                    <option value="FT4">FT4</option>
                    <option value="FT3 RIA">FT3 RIA</option>
                    <option value="FT4 RIA">FT4 RIA</option>
                    <option value="Thyroglobulin">Thyroglobulin</option>
                    <option value="TSH">TSH</option>
                    <option value="TSH (IRMA)">TSH (IRMA)</option>
                  </select>
                </div>
                <div style="background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:14px; padding:16px; min-height:140px; box-shadow:0 10px 30px rgba(0, 0, 0, 0.1);">
                  <label style="font-size:14px; font-weight:600; color:var(--text, #0f172a); display:block; margin-bottom:8px;">Tumour Markers</label>
                  <select multiple id="ex-tumour" class="ex-select-box" style="width:100%; height:110px; font-size:13px; border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; background:var(--card-alt, #f1f5f9); color:var(--text, #0f172a);">
                    <option value="CA 12-5 (Ovary)">CA 12-5 (Ovary)</option>
                    <option value="CA 15-3 (Breast)">CA 15-3 (Breast)</option>
                    <option value="CA 19-9 (Pancreas)">CA 19-9 (Pancreas)</option>
                    <option value="CEA">CEA</option>
                    <option value="PSA">PSA</option>
                    <option value="Serum B-HCG">Serum B-HCG</option>
                  </select>
                </div>
                <div style="background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:14px; padding:16px; min-height:140px; box-shadow:0 10px 30px rgba(0, 0, 0, 0.1);">
                  <label style="font-size:14px; font-weight:600; color:var(--text, #0f172a); display:block; margin-bottom:8px;">Histopathology</label>
                  <select multiple id="ex-histopathology" class="ex-select-box" style="width:100%; height:110px; font-size:13px; border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; background:var(--card-alt, #f1f5f9); color:var(--text, #0f172a);">
                    <option value="Aspiration Biopsy">Aspiration Biopsy</option>
                    <option value="Small/Medium/Large/Extra Large">S/M/L/XL</option>
                  </select>
                </div>
                <div style="background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:14px; padding:16px; min-height:140px; box-shadow:0 10px 30px rgba(0, 0, 0, 0.1);">
                  <label style="font-size:14px; font-weight:600; color:var(--text, #0f172a); display:block; margin-bottom:8px;">X-Ray</label>
                  <select multiple id="ex-xray" class="ex-select-box" style="width:100%; height:110px; font-size:13px; border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; background:var(--card-alt, #f1f5f9); color:var(--text, #0f172a);">
                    <option value="Chest PA-L">Chest PA, Lateral</option>
                    <option value="Chest AP & Lateral">Chest AP, Lateral</option>
                    <option value="Chest Apicolordotic View">Chest Apicolordotic</option>
                    <option value="Ankle AP/Lateral">Ankle AP/Lateral</option>
                  </select>
                </div>
                <div style="background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:14px; padding:16px; min-height:140px; box-shadow:0 10px 30px rgba(0, 0, 0, 0.1);">
                  <label style="font-size:14px; font-weight:600; color:var(--text, #0f172a); display:block; margin-bottom:8px;">Ultrasound</label>
                  <select multiple id="ex-ultrasound" class="ex-select-box" style="width:100%; height:110px; font-size:13px; border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; background:var(--card-alt, #f1f5f9); color:var(--text, #0f172a);">
                    <option value="Breast">Breast</option>
                    <option value="Gallbladder">Gallbladder</option>
                    <option value="HBT">HBT</option>
                    <option value="Inguino-Scrotal">Inguino-Scrotal</option>
                    <option value="Kidney">Kidney</option>
                    <option value="KUB">KUB</option>
                    <option value="KUB - P">KUB - P</option>
                    <option value="Liver">Liver</option>
                    <option value="Lower Abdomen">Lower Abdomen</option>
                    <option value="Pancreas">Pancreas</option>
                    <option value="Pelvic">Pelvic</option>
                    <option value="Prostate">Prostate</option>
                    <option value="Spleen">Spleen</option>
                    <option value="Transvaginal">Transvaginal</option>
                    <option value="Upper Abdomen">Upper Abdomen</option>
                    <option value="Whole Abdomen">Whole Abdomen</option>
                  </select>
                </div>
                <div style="background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:14px; padding:16px; min-height:140px; box-shadow:0 10px 30px rgba(0, 0, 0, 0.1);">
                  <label style="font-size:14px; font-weight:600; color:var(--text, #0f172a); display:block; margin-bottom:8px;">Cardiology</label>
                  <select multiple id="ex-cardiology" class="ex-select-box" style="width:100%; height:110px; font-size:13px; border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; background:var(--card-alt, #f1f5f9); color:var(--text, #0f172a);">
                    <option value="2D Echo Plain">2D Echo Plain</option>
                    <option value="2D Echo with Doppler">2D Echo w/ Doppler</option>
                    <option value="ECG (Electrocardiogram)">ECG</option>
                  </select>
                </div>
                <div style="background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:14px; padding:16px; min-height:140px; box-shadow:0 10px 30px rgba(0, 0, 0, 0.1);">
                  <label style="font-size:14px; font-weight:600; color:var(--text, #0f172a); display:block; margin-bottom:8px;">Vascular</label>
                  <select multiple id="ex-vascular" class="ex-select-box" style="width:100%; height:110px; font-size:13px; border:1px solid var(--border, #e2e8f0); border-radius:10px; padding:8px; background:var(--card-alt, #f1f5f9); color:var(--text, #0f172a);">
                    <option value="Ankle Brachial Index (ABI)">ABI</option>
                    <option value="Arterial Duplex Scan - Lower (Bilateral/Unilateral)">Arterial Duplex - Lower</option>
                    <option value="Arterial Duplex Scan - Upper">Arterial Duplex - Upper</option>
                    <option value="AV Mapping">AV Mapping</option>
                    <option value="Carotid Duplex Scan">Carotid Duplex</option>
                    <option value="Venous Duplex Scan - Lower (Bilateral/Unilateral)">Venous Duplex - Lower</option>
                    <option value="Venous Duplex Scan - Upper">Venous Duplex - Upper</option>
                  </select>
                </div>
                <div style="background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:14px; padding:16px; min-height:140px; box-shadow:0 10px 30px rgba(0, 0, 0, 0.1);">
                  <label style="font-size:14px; font-weight:600; color:var(--text, #0f172a); display:block; margin-bottom:8px;">Others</label>
                  <input type="text" id="ex-others" placeholder="Specify other test(s)..." style="width:100%; padding:10px 12px; border:1px solid var(--border, #e2e8f0); border-radius:10px; font-size:13px; margin-bottom:12px; background:var(--card-alt, #f1f5f9); color:var(--text, #0f172a);">
                  
                  <!-- Follow-up Date Section -->
                  <div style="display:flex; gap:12px; align-items:center; margin-top:12px;">
                    <label for="ex-followup-text" style="font-size:14px; font-weight:600; color:var(--text, #0f172a); white-space:nowrap;">Follow-up:</label>
                    <input id="ex-followup-text" type="text" placeholder="Pick date" readonly style="padding:8px 12px; border:1px solid var(--border, #e2e8f0); border-radius:10px; font-size:14px; cursor:pointer; width:180px; background:var(--card-alt, #f1f5f9); color:var(--text, #0f172a);" />
                    <input id="ex-followup" type="hidden" />
                  </div>
                </div>
              </div>
            </div>
          </div>`;
        document.body.appendChild(ex);
        const closeBtn = ex.querySelector('#ex-close');
        closeBtn?.addEventListener('click', () => ex.remove());
        const openBtn = ex.querySelector('#ex-open');

        const selectElements = ex.querySelectorAll('select[multiple]');
        selectElements.forEach(select => {
          select.addEventListener('mousedown', function (e) {
            e.preventDefault();
            const option = e.target;
            if (option.tagName === "OPTION") {
              option.selected = !option.selected;
              if (option.selected) {
                option.style.backgroundColor = "#4CAF50";
                option.style.color = "white";
              } else {
                option.style.backgroundColor = "";
                option.style.color = "";
              }
            }
          });
          select.addEventListener('click', function (e) {
            e.stopPropagation();
          });
        });

        // Follow-up date picker functionality
        const followText = ex.querySelector('#ex-followup-text');
        const followHidden = ex.querySelector('#ex-followup');
        if (followText) {
          followText.addEventListener('click', () => {
            const now = new Date();
            openDateOnlyModal(now, (picked) => {
              const d = new Date(picked);
              const dateOnly = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
              if (followHidden) followHidden.value = dateOnly;
              followText.value = d.toLocaleDateString();
            });
          });
        }

        openBtn?.addEventListener('click', (e) => {
          e.preventDefault();
          const params = new URLSearchParams();
          if (pName) params.set('name', pName);
          try {
            const sx = String(pSex || '').trim().toLowerCase();
            const norm = sx === 'male' || sx === 'm' ? 'Male' : sx === 'female' || sx === 'f' ? 'Female' : (sx ? 'Other' : '');
            if (norm) params.set('sex', norm);
          } catch (_) { }
          if (pAddress) params.set('address', pAddress);
          if (initAge) params.set('age', initAge);
          if (pDob) params.set('dob', pDob);
          params.set('date', todayVal);
          params.set('autoprint', '1');

          const selectedTests = [];
          const categoryIds = [
            'ex-hematology', 'ex-microscopy', 'ex-serology', 'ex-bacteriology',
            'ex-chemistry', 'ex-enzymes', 'ex-hepatitis', 'ex-thyroid',
            'ex-tumour', 'ex-histopathology', 'ex-xray', 'ex-ultrasound',
            'ex-cardiology', 'ex-vascular'
          ];

          categoryIds.forEach(categoryId => {
            const select = ex.querySelector(`#${categoryId}`);
            if (select) {
              const selected = Array.from(select.selectedOptions).map(opt => opt.value);
              selectedTests.push(...selected);
            }
          });

          const othersEl = ex.querySelector('#ex-others');
          const othersVal = (othersEl?.value || '').trim();
          if (othersVal) selectedTests.push(othersVal);

          if (selectedTests.length > 0) {
            params.set('others', selectedTests.join(', '));
          }

          // Add follow-up date if selected
          const followupDate = (followHidden?.value || '').trim();
          if (followupDate) {
            params.set('followup', followupDate);
          }

          try {
            const primary = (overlay.querySelector('#diag-diagnosis')?.value || '').trim();
            const secondary = (overlay.querySelector('#diag-secondary')?.value || '').trim();
            const reason = [primary, secondary].filter(Boolean).join(', ');
            if (reason) params.set('reason', reason);
          } catch (_) { }

          params.set('autoprint', '1');
          const href = '/forms/diz/Doc Dizon/Doc Dizon - Laboratory Diagnostics/MAIN FORM Doc Dizon - Laboratory Diagnostics.html';
          const url = encodeURI(href) + (params.toString() ? ('?' + params.toString()) : '');
          console.log('Lab Form Debug - Final URL:', url);
          console.log('Lab Form Debug - Parameters:', params.toString());

          // Create hidden iframe for printing
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = url;
          document.body.appendChild(iframe);

          // Listen for print completion message
          const messageHandler = function (event) {
            if (event.data === 'print-complete') {
              document.body.removeChild(iframe);
              window.removeEventListener('message', messageHandler);
            }
          };
          window.addEventListener('message', messageHandler);

          // Fallback: remove iframe after timeout
          setTimeout(() => {
            if (document.body.contains(iframe)) {
              document.body.removeChild(iframe);
              window.removeEventListener('message', messageHandler);
            }
          }, 10000);
        });
      }

      function showDoctorFeedbackModal(title, message, variant) {
        const icon = variant === 'success' ? '' : (variant === 'error' ? '!' : (variant === 'warning' ? '!' : 'i'));
        const iconClass = variant === 'success' ? 'success' : (variant === 'error' ? 'error' : (variant === 'warning' ? 'warning' : 'info'));
        const overlay = document.createElement('div');
        overlay.className = 'modal-backdrop';
        overlay.style.zIndex = '2300';
        const cardClass = variant ? `modal-card extra-narrow is-${iconClass}` : 'modal-card extra-narrow';
        overlay.innerHTML = `
          <div class="${cardClass}" role="dialog" aria-modal="true" aria-labelledby="feedback-title">
            <div class="modal-header">
              <div class="modal-title" id="feedback-title">${String(title || 'Notice')}</div>
              <button id="feedback-close" class="btn-secondary btn-small">Close</button>
            </div>
            <div class="modal-body" style="max-height:none;">
              <div style="display:flex; gap:12px; align-items:flex-start;">
                <div class="modal-icon ${iconClass}">${icon}</div>
                <div class="who">${String(message || '')}</div>
              </div>
            </div>
          </div>`;
        document.body.appendChild(overlay);
        const btn = overlay.querySelector('#feedback-close');
        function close() { try { document.body.removeChild(overlay); } catch (_) { } }
        if (btn) btn.addEventListener('click', close);
        overlay.addEventListener('click', (e) => { if (e.target === overlay) close(); });
        if (variant !== 'error') setTimeout(close, 2500);
      }

      async function showDoctorConfirmModal(title, message, confirmLabel) {
        return new Promise((resolve) => {
          const overlay = document.createElement('div');
          overlay.style.cssText = 'position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(2,6,23,0.45); z-index:2200;';
          overlay.innerHTML = `
            <div class="modal-card narrow" style="overflow:hidden;">
              <div style="padding:12px 16px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between;">
                <div style="font-weight:700;">${String(title || 'Confirm')}</div>
                <button id="x-confirm-close" class="btn-secondary btn-small">Close</button>
              </div>
              <div style="padding:16px 16px;">
                <div class="who" style="padding:4px 0 2px;">${String(message || '')}</div>
                <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                  <button id="confirm-cancel" class="btn-secondary btn-small">Cancel</button>
                  <button id="confirm-ok" class="btn-small">${String(confirmLabel || 'Confirm')}</button>
                </div>
              </div>
            </div>`;
          document.body.appendChild(overlay);
          const ok = overlay.querySelector('#confirm-ok');
          const cancel = overlay.querySelector('#confirm-cancel');
          const x = overlay.querySelector('#x-confirm-close');
          function done(val) { try { resolve(val); } catch (_) { } document.body.removeChild(overlay); }
          overlay.addEventListener('click', (e) => { if (e.target === overlay) done(false); });
          if (ok) ok.addEventListener('click', () => done(true), { once: true });
          if (cancel) cancel.addEventListener('click', () => done(false), { once: true });
          if (x) x.addEventListener('click', () => done(false), { once: true });
        });
      }

      async function showDoctorPromptModal(title, currentValue) {
        return new Promise((resolve) => {
          const lastDot = String(currentValue || '').lastIndexOf('.');
          const ext = lastDot !== -1 ? String(currentValue).slice(lastDot) : '';
          const base = lastDot !== -1 ? String(currentValue).slice(0, lastDot) : String(currentValue || '');
          const overlay = document.createElement('div');
          overlay.style.cssText = 'position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(2,6,23,0.45); z-index:2200;';
          overlay.innerHTML = `
            <div class="modal-card narrow" style="overflow:hidden;">
              <div style="padding:12px 16px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between;">
                <div style="font-weight:700;">${String(title || 'Input')}</div>
                <button id="x-prompt-close" class="btn-secondary btn-small">Close</button>
              </div>
              <div style="padding:16px 16px; display:grid; gap:12px;">
                <div class="field">
                  <label for="prompt-input" class="sr-only">Name</label>
                  <div style="display:flex; gap:6px; align-items:center;">
                    <input id="prompt-input" type="text" />
                    <span class="who" aria-hidden="true">${ext}</span>
                  </div>
                </div>
                <div style="display:flex; gap:8px; justify-content:flex-end;">
                  <button id="prompt-cancel" class="btn-secondary btn-small">Cancel</button>
                  <button id="prompt-ok" class="btn-small">Save</button>
                </div>
              </div>
            </div>`;
          document.body.appendChild(overlay);
          const input = overlay.querySelector('#prompt-input');
          const ok = overlay.querySelector('#prompt-ok');
          const cancel = overlay.querySelector('#prompt-cancel');
          const x = overlay.querySelector('#x-prompt-close');
          if (input) { input.value = base; setTimeout(() => input.focus(), 0); }
          function submit() {
            const baseVal = input ? String(input.value || '') : '';
            const val = baseVal ? (ext ? baseVal + ext : baseVal) : '';
            document.body.removeChild(overlay);
            resolve(val);
          }
          if (ok) ok.addEventListener('click', submit, { once: true });
          if (cancel) cancel.addEventListener('click', () => { document.body.removeChild(overlay); resolve(null); }, { once: true });
          if (x) x.addEventListener('click', () => { document.body.removeChild(overlay); resolve(null); }, { once: true });
          if (input) input.addEventListener('keydown', (e) => { if (e.key === 'Enter') submit(); });
        });
      }

      const scheduleModal = document.createElement('div');
      scheduleModal.id = 'schedule-modal';
      scheduleModal.className = 'modal-backdrop';
      scheduleModal.style.display = 'none';
      scheduleModal.style.zIndex = '3000';
      scheduleModal.innerHTML = `
        <div class="modal-card extra-narrow" role="dialog" aria-modal="true" aria-label="Pick date and time">
          <div class="modal-header">
            <div class="modal-title" id="schedule-title">Pick date & time</div>
            <button id="close-schedule" class="btn-secondary btn-small">Close</button>
          </div>
          <div class="modal-body" style="display:grid; gap:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <button id="sched-prev" class="btn-secondary btn-small">Prev</button>
              <div id="sched-title" class="cal-title"></div>
              <button id="sched-next" class="btn-secondary btn-small">Next</button>
            </div>
            <div id="sched-grid" class="cal-grid"></div>
            <div style="display:flex; gap:8px; align-items:center;">
              <label class="who" for="sched-time-text">Time</label>
              <input id="sched-time-text" type="text" placeholder="09:00" readonly style="width:90px; text-align:center;" />
              <input id="sched-time" type="hidden" />
            </div>
            <div style="display:flex; gap:8px; justify-content:flex-end;">
              <button id="sched-cancel" class="btn-secondary btn-small">Cancel</button>
              <button id="sched-save" class="btn-small">Save</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(scheduleModal);

      // Date-only picker modal (without time)
      const dateOnlyModal = document.createElement('div');
      dateOnlyModal.id = 'date-only-modal';
      dateOnlyModal.className = 'modal-backdrop';
      dateOnlyModal.style.display = 'none';
      dateOnlyModal.style.zIndex = '3000';
      dateOnlyModal.innerHTML = `
        <div class="modal-card narrow" role="dialog" aria-modal="true" aria-label="Pick date">
          <div class="modal-header">
            <div class="modal-title" id="date-only-title">Pick date</div>
            <button id="close-date-only" class="btn-secondary btn-small">Close</button>
          </div>
          <div class="modal-body" style="display:grid; gap:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <button id="date-only-prev" class="btn-secondary btn-small">Prev</button>
              <div id="date-only-title-display" class="cal-title"></div>
              <button id="date-only-next" class="btn-secondary btn-small">Next</button>
            </div>
            <div id="date-only-grid" class="cal-grid" style="display:grid; grid-template-columns:repeat(7, 1fr); gap:2px; font-size:14px;"></div>
            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
              <button id="date-only-cancel" class="btn-secondary btn-small">Cancel</button>
              <button id="date-only-save" class="btn-small">Save</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(dateOnlyModal);

      let schedYear = 0, schedMonth = 0, schedSelectedDay = 0;
      let schedConfirmCb = null;

      // Date-only picker variables
      let dateOnlyYear = 0, dateOnlyMonth = 0, dateOnlySelectedDay = 0;
      let dateOnlyConfirmCb = null;

      function pad2(n) { return String(n).padStart(2, '0'); }

      function openTimePopover(anchorInput, initialHHmm, onPick) {
        const existing = document.getElementById('time-popover');
        if (existing) existing.remove();
        const pop = document.createElement('div');
        pop.id = 'time-popover';
        pop.className = 'time-popover';
        const [ih, im] = String(initialHHmm || '09:00').split(':').map(n => Number(n));
        let selH = isFinite(ih) ? ih : 9;
        let selM = isFinite(im) ? im : 0;
        function fmt(h, m) { return `${pad2(h)}:${pad2(m)}`; }
        function item(h, isHour) { const s = isHour ? (h === selH) : (h === selM); return `<div class="tp-item ${s ? 'selected' : ''}" data-${isHour ? 'hour' : 'minute'}="${h}">${isHour ? pad2(h) : pad2(h)}</div>`; }
        const minuteSteps = Array.from({ length: 12 }, (_, i) => i * 5);
        pop.innerHTML = `
          <div class="tp-cols">
            <div class="tp-col" id="tp-hours">${Array.from({ length: 24 }, (_, h) => item(h, true)).join('')}</div>
            <div class="tp-col" id="tp-mins">${minuteSteps.map(m => item(m, false)).join('')}</div>
          </div>`;
        document.body.appendChild(pop);
        function position() {
          const r = anchorInput.getBoundingClientRect();
          const pr = pop.getBoundingClientRect();
          let top = r.bottom + 6; let left = r.left;
          const maxLeft = window.innerWidth - 8 - pr.width;
          if (left > maxLeft) left = Math.max(8, maxLeft);
          if (top + pr.height > window.innerHeight - 8) top = Math.max(8, r.top - 6 - pr.height);
          pop.style.top = top + 'px'; pop.style.left = left + 'px';
        }
        position();
        window.addEventListener('resize', position);
        window.addEventListener('scroll', position, true);
        function cleanup() {
          window.removeEventListener('resize', position);
          window.removeEventListener('scroll', position, true);
          const ex = document.getElementById('time-popover'); if (ex) ex.remove();
          document.removeEventListener('click', onDoc);
        }
        function onDoc(e) { if (!pop.contains(e.target) && e.target !== anchorInput) cleanup(); }
        setTimeout(() => document.addEventListener('click', onDoc), 0);
        pop.addEventListener('click', (e) => {
          const h = e.target.closest('[data-hour]');
          const m = e.target.closest('[data-minute]');
          if (h) { selH = Number(h.getAttribute('data-hour')); document.querySelectorAll('#tp-hours .tp-item').forEach(el => el.classList.remove('selected')); h.classList.add('selected'); }
          if (m) { selM = Number(m.getAttribute('data-minute')); document.querySelectorAll('#tp-mins .tp-item').forEach(el => el.classList.remove('selected')); m.classList.add('selected'); }
          if (h || m) { onPick(fmt(selH, selM)); }
        });
      }

      function renderScheduleGrid() {
        const grid = document.getElementById('sched-grid');
        const title = document.getElementById('sched-title');
        const first = new Date(schedYear, schedMonth, 1);
        const firstDay = first.getDay();
        const daysInMonth = new Date(schedYear, schedMonth + 1, 0).getDate();
        const prevMonthDays = new Date(schedYear, schedMonth, 0).getDate();
        const startOffset = firstDay;
        const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        title.textContent = `${first.toLocaleString('default', { month: 'long' })} ${schedYear}`;
        const cells = [];
        grid.innerHTML = weekdays.map(w => `<div class="cal-weekday">${w}</div>`).join('');
        for (let i = 0; i < startOffset; i++) {
          const dayNum = prevMonthDays - startOffset + i + 1;
          cells.push({ outside: true, date: new Date(schedYear, schedMonth - 1, dayNum), displayDay: dayNum });
        }
        for (let d = 1; d <= daysInMonth; d++) {
          cells.push({ outside: false, date: new Date(schedYear, schedMonth, d), displayDay: d });
        }
        const totalCells = Math.ceil(cells.length / 7) * 7;
        for (let i = cells.length; i < totalCells; i++) {
          const dayNum = i - cells.length + 1;
          cells.push({ outside: true, date: new Date(schedYear, schedMonth, 1), dayNumber: dayNum });
        }
        grid.innerHTML += cells.map(c => {
          const dnum = c.dayNumber || c.displayDay || c.date.getDate();
          const isSel = !c.outside && dnum === schedSelectedDay;
          return `
            <div class="cal-day ${c.outside ? 'outside' : ''}" data-day="${dnum}" style="${isSel ? 'outline:2px solid #2563eb; outline-offset:-2px; border-radius:6px;' : ''}">
              <div class="date">${dnum}</div>
            </div>
          `;
        }).join('');
      }

      function renderDateOnlyGrid() {
        const grid = document.getElementById('date-only-grid');
        const title = document.getElementById('date-only-title-display');
        const first = new Date(dateOnlyYear, dateOnlyMonth, 1);
        const firstDay = first.getDay();
        const daysInMonth = new Date(dateOnlyYear, dateOnlyMonth + 1, 0).getDate();
        const prevMonthDays = new Date(dateOnlyYear, dateOnlyMonth, 0).getDate();
        const startOffset = firstDay;
        const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        title.textContent = `${first.toLocaleString('default', { month: 'long' })} ${dateOnlyYear}`;
        const cells = [];
        grid.innerHTML = weekdays.map(w => `<div class="cal-weekday">${w}</div>`).join('');
        for (let i = 0; i < startOffset; i++) {
          const dayNum = prevMonthDays - startOffset + i + 1;
          cells.push({ outside: true, date: new Date(dateOnlyYear, dateOnlyMonth - 1, dayNum), displayDay: dayNum });
        }
        for (let d = 1; d <= daysInMonth; d++) {
          cells.push({ outside: false, date: new Date(dateOnlyYear, dateOnlyMonth, d), displayDay: d });
        }
        const totalCells = Math.ceil(cells.length / 7) * 7;
        for (let i = cells.length; i < totalCells; i++) {
          const dayNum = i - cells.length + 1;
          cells.push({ outside: true, date: new Date(dateOnlyYear, dateOnlyMonth, 1), dayNumber: dayNum });
        }
        grid.innerHTML += cells.map(c => {
          const dnum = c.dayNumber || c.displayDay || c.date.getDate();
          const isSel = !c.outside && dnum === dateOnlySelectedDay;
          return `
            <div class="cal-day ${c.outside ? 'outside' : ''}" data-day="${dnum}" style="${isSel ? 'outline:2px solid #2563eb; outline-offset:-2px; border-radius:6px;' : ''}">
              <div class="date">${dnum}</div>
            </div>
          `;
        }).join('');
      }

      function openDateOnlyModal(initialDate, onConfirm) {
        dateOnlyConfirmCb = onConfirm;
        dateOnlyYear = initialDate.getFullYear();
        dateOnlyMonth = initialDate.getMonth();
        dateOnlySelectedDay = initialDate.getDate();

        renderDateOnlyGrid();
        dateOnlyModal.style.display = 'flex';
      }

      function closeDateOnlyModal() { dateOnlyModal.style.display = 'none'; }

      function openScheduleModal(initialDate, onConfirm) {
        schedConfirmCb = onConfirm;
        schedYear = initialDate.getFullYear();
        schedMonth = initialDate.getMonth();
        schedSelectedDay = initialDate.getDate();

        // Initialize time picker
        const schedTimeText = scheduleModal.querySelector('#sched-time-text');
        const schedTime = scheduleModal.querySelector('#sched-time');
        if (schedTimeText && schedTime) {
          const now = new Date();
          const hhmm = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
          schedTime.value = hhmm;
          schedTimeText.value = new Date(`1970-01-01T${hhmm}`).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          schedTimeText.addEventListener('click', () => {
            openTimePopover(schedTimeText, schedTime.value, (timeStr) => {
              schedTime.value = timeStr;
              schedTimeText.value = new Date(`1970-01-01T${timeStr}`).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            });
          });
        }

        renderScheduleGrid();
        scheduleModal.style.display = 'flex';
      }

      function closeScheduleModal() { scheduleModal.style.display = 'none'; }
      scheduleModal.addEventListener('click', (e) => { if (e.target === scheduleModal) closeScheduleModal(); });
      scheduleModal.querySelector('#close-schedule').addEventListener('click', closeScheduleModal);
      scheduleModal.querySelector('#sched-prev').addEventListener('click', () => { schedMonth--; if (schedMonth < 0) { schedMonth = 11; schedYear--; } renderScheduleGrid(); });
      scheduleModal.querySelector('#sched-next').addEventListener('click', () => { schedMonth++; if (schedMonth > 11) { schedMonth = 0; schedYear++; } renderScheduleGrid(); });
      scheduleModal.querySelector('#sched-grid').addEventListener('click', (e) => {
        const dayEl = e.target.closest('.cal-day');
        if (!dayEl || dayEl.classList.contains('outside')) return;
        const day = Number(dayEl.getAttribute('data-day'));
        if (!day) return;
        schedSelectedDay = day;
        renderScheduleGrid();
      });
      scheduleModal.querySelector('#sched-cancel').addEventListener('click', closeScheduleModal);
      scheduleModal.querySelector('#sched-save').addEventListener('click', () => {
        if (!schedSelectedDay) {
          showDoctorFeedbackModal('Schedule Appointment', 'Please select a date', 'warning');
          return;
        }
        const schedTime = scheduleModal.querySelector('#sched-time');
        const timeStr = schedTime ? schedTime.value : '09:00';
        const y = schedYear, m = schedMonth + 1, d = schedSelectedDay;
        const picked = `${y}-${pad2(m)}-${pad2(d)}T${timeStr}`;
        if (typeof schedConfirmCb === 'function') schedConfirmCb(picked);
        closeScheduleModal();
      });

      // Date-only modal event listeners
      dateOnlyModal.addEventListener('click', (e) => { if (e.target === dateOnlyModal) closeDateOnlyModal(); });
      dateOnlyModal.querySelector('#close-date-only').addEventListener('click', closeDateOnlyModal);
      dateOnlyModal.querySelector('#date-only-prev').addEventListener('click', () => { dateOnlyMonth--; if (dateOnlyMonth < 0) { dateOnlyMonth = 11; dateOnlyYear--; } renderDateOnlyGrid(); });
      dateOnlyModal.querySelector('#date-only-next').addEventListener('click', () => { dateOnlyMonth++; if (dateOnlyMonth > 11) { dateOnlyMonth = 0; dateOnlyYear++; } renderDateOnlyGrid(); });
      dateOnlyModal.querySelector('#date-only-grid').addEventListener('click', (e) => {
        const dayEl = e.target.closest('.cal-day');
        if (!dayEl || dayEl.classList.contains('outside')) return;
        const day = Number(dayEl.getAttribute('data-day'));
        if (!day) return;
        dateOnlySelectedDay = day;
        renderDateOnlyGrid();
      });
      dateOnlyModal.querySelector('#date-only-cancel').addEventListener('click', closeDateOnlyModal);
      dateOnlyModal.querySelector('#date-only-save').addEventListener('click', () => {
        if (!dateOnlySelectedDay) {
          showDoctorFeedbackModal('Pick Date', 'Please select a date', 'warning');
          return;
        }
        const y = dateOnlyYear, m = dateOnlyMonth + 1, d = dateOnlySelectedDay;
        const picked = new Date(y, m - 1, d);
        if (typeof dateOnlyConfirmCb === 'function') dateOnlyConfirmCb(picked);
        closeDateOnlyModal();
      });


      calGrid.addEventListener('click', (e) => {
        const ev = e.target.closest('.cal-event[data-appt-id]');
        if (!ev) return;
        const apptId = ev.getAttribute('data-appt-id');
        const appt = cachedAppts.find(a => String(a.id) === String(apptId));
        if (!appt) return;
        const d = parseApptDate(appt);
        const patientFullName = currentPatientProfile ? (currentPatientProfile.fullName || currentPatientProfile.name || appt.patientName) : appt.patientName;
        const details = {
          avatarText: patientFullName || 'P',
          title: `Appt #${appt.id}  ${patientFullName}`,
          subtitle: `${d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at ${d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}  Dr. ${appt.doctorDisplayName || appt.doctorName}`,
          wide: false
        };
        const html = `
          <div style="display:grid; grid-template-columns: 120px 1fr; gap:8px 12px;">
            <div class="who">Appointment #</div><div>${appt.id}</div>
            <div class="who">Patient</div><div>${patientFullName}</div>
            <div class="who">Doctor</div><div>${appt.doctorDisplayName || appt.doctorName}</div>
            <div class="who">Status</div><div><span id="modal-status" class="badge ${statusClass(appt.status)}">${appt.status}</span></div>
            <div class="who">Date</div><div>${d.toLocaleDateString()}</div>
            <div class="who">Time</div><div>${d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
            ${appt.chiefComplaint ? `<div class="who">Chief Complaint</div><div>${appt.chiefComplaint}</div>` : ''}
            ${appt.reason ? `<div class="who">Notes</div><div>${appt.reason}</div>` : ''}
          </div>
        `;
        openModal(html, details);
      });

      calGrid.addEventListener('click', (e) => {
        if (e.target.closest('.cal-event[data-appt-id]')) return;
        const dayEl = e.target.closest('.cal-day');
        if (!dayEl || dayEl.classList.contains('outside')) return;
        const key = dayEl.getAttribute('data-date');
        if (!key) return;
        selectedDateFilter = (selectedDateFilter === key) ? '' : key;
        refresh();
      });

      modal.addEventListener('click', async (e) => {
        const sbtn = e.target.closest('button[data-status][data-appt-id]');
        if (sbtn) {
          const apptId = sbtn.getAttribute('data-appt-id');
          const status = sbtn.getAttribute('data-status');
          try {
            if (status === 'scheduled') {
              const now = new Date();
              openScheduleModal(now, async (picked) => {
                try {
                  await apiPost(`/api/appointments/${apptId}/status`, { status: 'scheduled', time: picked });
                  showDoctorFeedbackModal('Appointment', 'Appointment rescheduled successfully', 'success');
                  closeModal();
                  refresh();
                } catch (err) {
                  showDoctorFeedbackModal('Schedule Error', err.message || 'Failed to reschedule appointment', 'error');
                }
              });
              return;
            } else {
              await apiPost(`/api/appointments/${apptId}/status`, { status });
            }
            showDoctorFeedbackModal('Appointment', 'Appointment updated successfully', 'success');
            closeModal();
            refresh();
          } catch (err) {
            showDoctorFeedbackModal('Update Error', err.message || 'Failed to update appointment', 'error');
          }
          return;
        }
      });
      const diagForm = { addEventListener: () => { } };
      const diagApptInput = { value: '', addEventListener: () => { } };
      const diagApptMenu = { style: { display: 'none' }, contains: () => false, addEventListener: () => { } };
      const diagApptId = { value: '' };
      const diagInput = { value: '', addEventListener: () => { }, setSelectionRange: () => { } };
      const diagMenu = { style: { display: 'none' }, querySelectorAll: () => [], contains: () => false, addEventListener: () => { } };
      const diagChips = { innerHTML: '', addEventListener: () => { } };
      const commonDiagnoses = [
        'Hypertension', 'Type 2 Diabetes Mellitus', 'Upper respiratory infection',
        'Migraine', 'Gastroenteritis', 'Anxiety disorder', 'Depression',
        'Urinary tract infection', 'Allergic rhinitis', 'Low back pain'
      ];
      let activeIndex = -1;
      let apptActiveIndex = -1;
      let apptOptionsCache = [];

      function buildMenuItems(options) {
        return options.map((opt, idx) => `<li data-value="${opt}" ${idx === activeIndex ? 'class="active"' : ''} style="list-style:none; padding:8px 10px; cursor:pointer;">${opt}</li>`).join('');
      }

      function openMenu() {
        diagMenu.style.display = 'block';
      }

      function closeMenu() {
        diagMenu.style.display = 'none';
        activeIndex = -1;
      }

      function openApptMenu() {
        diagApptMenu.style.display = 'block';
      }

      function closeApptMenu() {
        diagApptMenu.style.display = 'none';
        apptActiveIndex = -1;
      }

      function filterAndRender() {
        const q = diagInput.value.trim().toLowerCase();
        const opts = commonDiagnoses.filter(o => o.toLowerCase().includes(q));
        diagMenu.innerHTML = buildMenuItems(opts);
        return opts;
      }

      function buildApptItems(options) {
        return options.map((opt, idx) => {
          const label = `#${opt.id} ${opt.patientName} at ${opt.time}`;
          return `<li data-id="${opt.id}" data-label="${label}" ${idx === apptActiveIndex ? 'class="active"' : ''} style="list-style:none; padding:8px 10px; cursor:pointer;">${label}</li>`;
        }).join('');
      }

      function filterAndRenderAppts() {
        const q = diagApptInput.value.trim().toLowerCase();
        const filtered = apptOptionsCache.filter(o => (
          o.patientName.toLowerCase().includes(q) || String(o.id).includes(q) || (o.time || '').toLowerCase().includes(q)
        ));
        diagApptMenu.innerHTML = buildApptItems(filtered);
        return filtered;
      }

      diagInput.addEventListener('focus', () => {
        filterAndRender();
        openMenu();
      });

      diagInput.addEventListener('input', () => {
        activeIndex = -1;
        filterAndRender();
        openMenu();
      });

      diagInput.addEventListener('keydown', (e) => {
        const items = Array.from(diagMenu.querySelectorAll('li'));
        if (!items.length) return;
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          activeIndex = (activeIndex + 1) % items.length;
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          activeIndex = (activeIndex - 1 + items.length) % items.length;
        } else if (e.key === 'Enter') {
          if (activeIndex >= 0) {
            e.preventDefault();
            const val = items[activeIndex].getAttribute('data-value');
            diagInput.value = val;
            closeMenu();
          }
        } else if (e.key === 'Escape') {
          closeMenu();
        } else {
          return;
        }
        items.forEach((el, idx) => el.classList.toggle('active', idx === activeIndex));
      });

      diagApptInput.addEventListener('focus', () => {
        filterAndRenderAppts();
        openApptMenu();
      });

      diagApptInput.addEventListener('input', () => {
        apptActiveIndex = -1;
        filterAndRenderAppts();
        openApptMenu();
      });

      diagApptInput.addEventListener('keydown', (e) => {
        const items = Array.from(diagApptMenu.querySelectorAll('li'));
        if (!items.length) return;
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          apptActiveIndex = (apptActiveIndex + 1) % items.length;
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          apptActiveIndex = (apptActiveIndex - 1 + items.length) % items.length;
        } else if (e.key === 'Enter') {
          if (apptActiveIndex >= 0) {
            e.preventDefault();
            const li = items[apptActiveIndex];
            const id = li.getAttribute('data-id');
            const label = li.getAttribute('data-label');
            diagApptInput.value = label;
            diagApptId.value = id;
            closeApptMenu();
          }
        } else if (e.key === 'Escape') {
          closeApptMenu();
        } else {
          return;
        }
        items.forEach((el, idx) => el.classList.toggle('active', idx === apptActiveIndex));
      });

      const selectedDiagnoses = new Set();

      function renderChips() {
        if (!diagChips) return;
        if (selectedDiagnoses.size === 0) { diagChips.innerHTML = ''; return; }
        diagChips.innerHTML = Array.from(selectedDiagnoses).map(v => `
          <span class="chip">${v}<button type="button" class="chip-x" data-remove="${v}"></button></span>
        `).join('');
      }

      function addDiagnosis(val) {
        const v = String(val || '').trim();
        if (!v) return;
        selectedDiagnoses.add(v);
        renderChips();
      }

      diagMenu.addEventListener('mousedown', (e) => {
        const li = e.target.closest('li[data-value]');
        if (!li) return;
        e.preventDefault();
        const val = li.getAttribute('data-value');
        addDiagnosis(val);
        diagInput.value = '';
        closeMenu();
      });

      diagInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && diagInput.value.trim()) {
          e.preventDefault();
          addDiagnosis(diagInput.value.trim());
          diagInput.value = '';
          closeMenu();
        }
      });

      diagChips.addEventListener('click', (e) => {
        const btn = e.target.closest('button.chip-x');
        if (!btn) return;
        const val = btn.getAttribute('data-remove');
        selectedDiagnoses.delete(val);
        renderChips();
      });

      diagApptMenu.addEventListener('mousedown', (e) => {
        const li = e.target.closest('li[data-id]');
        if (!li) return;
        e.preventDefault();
        const id = li.getAttribute('data-id');
        const label = li.getAttribute('data-label');
        diagApptInput.value = label;
        diagApptId.value = id;
        closeApptMenu();
      });

      document.addEventListener('click', (e) => {
        if (!diagMenu.contains(e.target) && e.target !== diagInput) {
          closeMenu();
        }
        if (!diagApptMenu.contains(e.target) && e.target !== diagApptInput) {
          closeApptMenu();
        }
      });
      const diagNotes = { value: '' };
      const diagMsg = { textContent: '' };
      const diagList = document.getElementById('diag-list');
      const chatFloat = document.getElementById('doctor-chat-float');
      const chatBody = document.getElementById('chat-body');
      const chatSidebar = document.getElementById('chat-sidebar');
      const chatHeader = document.getElementById('chat-header');
      const chatText = document.getElementById('chat-text');
      const chatSend = document.getElementById('chat-send');
      const chatClose = document.getElementById('chat-close');
      const chatOpenBtn = document.getElementById('chat-open');
      if (chatOpenBtn) chatOpenBtn.style.display = 'none';
      if (chatSidebar) chatSidebar.setAttribute('role', 'listbox');
      function updateFabBadge() {
        const btn = document.getElementById('chat-open');
        const badge = document.getElementById('chat-open-badge');
        if (!btn || !badge) return;
        let total = 0; unread.forEach(v => { total += Number(v) || 0; });
        badge.textContent = String(total);
        btn.classList.toggle('has-unread', total > 0 && (chatFloat?.style.display === 'none' || chatFloat?.style.display === '' || chatFloat == null));
      }
      function showChat() {
        if (chatFloat) {
          chatFloat.style.display = 'block';
          if (chatOpenBtn) chatOpenBtn.style.display = 'none';
          if (activeContact) {
            unread.delete(activeContact);
            renderSidebar();
            renderConversation(activeContact);
          }
          updateFabBadge();
        }
      }
      if (chatClose) chatClose.addEventListener('click', () => { chatFloat.style.display = 'none'; if (chatOpenBtn) chatOpenBtn.style.display = 'inline-flex'; updateFabBadge(); });
      if (chatOpenBtn) chatOpenBtn.addEventListener('click', showChat);

      const user = JSON.parse(localStorage.getItem('authUser') || '{}');
      let ws;
      let contacts = [];
      let activeContact = '';
      const conversations = new Map();
      const unread = new Map();
      const storageKey = `chat_active_${user.role}_${user.username}`;

      function updateChatHeader() {
        if (!chatHeader) return;
        if (activeContact) {
          const initials = activeContact.slice(0, 1).toUpperCase();
          chatHeader.innerHTML = `<span class="avatar">${initials}</span><span style="margin-left:8px;"><strong>${activeContact}</strong></span>`;
          chatHeader.style.display = 'flex';
          chatHeader.style.alignItems = 'center';
          chatHeader.style.gap = '8px';
        } else {
          chatHeader.innerHTML = '';
          chatHeader.style.display = 'none';
        }
      }

      function updateInputEnabled() {
        const has = !!activeContact;
        if (chatText) { chatText.disabled = !has; chatText.placeholder = has ? 'Type a message...' : 'Select a contact to start chatting'; }
        if (chatSend) chatSend.disabled = !has;
      }

      function ensureActiveVisible() {
        const el = chatSidebar && chatSidebar.querySelector('.item.active');
        if (el && el.scrollIntoView) el.scrollIntoView({ block: 'nearest' });
      }

      function renderMessageHtml(msg) {
        const time = new Date(msg.ts || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const isMe = msg.from === user.username;
        const initials = (msg.from || '?').slice(0, 1).toUpperCase();
        return `${!isMe ? `<div class="avatar">${initials}</div>` : ''}<div><div class="bubble">${msg.text}</div><div class="meta">${time}</div></div>`;
      }

      function appendRendered(msg) {
        const div = document.createElement('div');
        div.className = 'chat-msg' + (msg.from === user.username ? ' me' : '');
        div.innerHTML = renderMessageHtml(msg);
        chatBody.appendChild(div);
        chatBody.scrollTop = chatBody.scrollHeight;
      }

      function renderConversation(contact) {
        chatBody.innerHTML = '';
        const items = conversations.get(contact) || [];
        for (const m of items) appendRendered(m);
      }

      function addToConversation(partner, msg) {
        const arr = conversations.get(partner) || [];
        arr.push(msg);
        conversations.set(partner, arr);
      }
      function connectWs() {
        try {
          ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws`, [], {
            headers: { 'X-User': user.username, 'X-Role': user.role }
          });
        } catch (e) {
          ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws`);
        }
        ws.onopen = () => { };
        ws.onclose = () => { };
        ws.onerror = () => { };
        ws.onmessage = (ev) => {
          let data; try { data = JSON.parse(ev.data); } catch (e) { return; }
          if (data.type === 'ready') return;
          if (data.type === 'contacts') {
            contacts = data.contacts || [];
            renderSidebar();
            if (contacts.length) {
              const saved = localStorage.getItem(storageKey);
              if (!activeContact && saved && contacts.includes(saved)) {
                activeContact = saved;
              }
              if (!activeContact) {
                activeContact = contacts[0];
              }
              chatSidebar.setAttribute('data-active', activeContact);
              renderSidebar();
              renderConversation(activeContact);
              updateChatHeader();
              updateInputEnabled();
              ensureActiveVisible();
            } else {
              activeContact = '';
              chatSidebar.setAttribute('data-active', '');
              renderSidebar();
              renderConversation('');
              updateChatHeader();
              updateInputEnabled();
            }
            return;
          }
          if (data.type === 'appointment_request') {
            try { refresh(); } catch (_) { }
            return;
          }
          if (data.type === 'chat') {
            const partner = data.from === user.username ? data.to : data.from;
            addToConversation(partner, { from: data.from, to: data.to, text: data.text, ts: data.ts });
            const chatVisible = !!(chatFloat && chatFloat.style.display !== 'none');
            if (partner === activeContact && chatVisible) {
              appendRendered(data);
            } else {
              unread.set(partner, (unread.get(partner) || 0) + 1);
              renderSidebar();
              updateFabBadge();
            }
            return;
          }
        };
        ws.addEventListener('open', () => {
          ws.send(JSON.stringify({ type: 'hello', username: user.username, role: user.role }));
          ws.send(JSON.stringify({ type: 'contacts' }));
        });
      }
      function renderSidebar() {
        const current = activeContact || (chatSidebar.getAttribute('data-active') || '');
        chatSidebar.setAttribute('data-active', current);
        chatSidebar.innerHTML = contacts.map(c => {
          const u = unread.get(c) || 0;
          const badge = u > 0 ? `<span class="badge info" style="margin-left:auto;">${u}</span>` : '';
          return `<div class="item ${c === current ? 'active' : ''}" data-name="${c}" aria-selected="${c === current ? 'true' : 'false'}"><div class="avatar">${c.slice(0, 1).toUpperCase()}</div><div>${c}</div>${badge}</div>`;
        }).join('');
        ensureActiveVisible();
      }
      chatSidebar.addEventListener('click', (e) => {
        const item = e.target.closest('.item[data-name]');
        if (!item) return;
        activeContact = item.getAttribute('data-name');
        localStorage.setItem(storageKey, activeContact);
        chatSidebar.setAttribute('data-active', activeContact);
        unread.delete(activeContact);
        renderSidebar();
        renderConversation(activeContact);
        updateFabBadge();
        updateChatHeader();
        updateInputEnabled();
        ensureActiveVisible();
      });
      updateFabBadge();
      connectWs();
      updateInputEnabled();
      chatSend.addEventListener('click', () => {
        const to = activeContact || chatSidebar.getAttribute('data-active');
        const text = chatText.value.trim();
        if (!to || !text) return;
        ws && ws.readyState === WebSocket.OPEN && ws.send(JSON.stringify({ type: 'chat', to, text }));
        chatText.value = '';
      });
      chatText.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          chatSend.click();
        }
      });

      function statusClass(s) {
        if (s === 'completed' || s === 'accepted') return 'success';
        if (s === 'pending') return 'warning';
        if (s === 'cancelled' || s === 'declined') return 'danger';
        if (s === 'scheduled') return 'info';
        return 'neutral';
      }

      function render(appts) {
        if (!appts.length) {
          list.innerHTML = `
            <li class="item" style="justify-content:center;">
              <div class="who">No appointments for the selected day.</div>
            </li>
          `;
          diagApptInput.value = '';
          diagApptId.value = '';
          apptOptionsCache = [];
          return;
        }
        list.innerHTML = appts.map(a => {
          const d = parseApptDate(a);
          const t = new Date(d).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
          const dateStr = new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
          const dow = formatDow(d);
          const rel = relativeTime(d);
          return `
          <li class="item" data-appt-id="${a.id}">
            <div class="left">
              <div class="primary">#${a.id}  ${a.displayName || a.patientName}</div>
              <div class="meta">${dateStr}  ${dow}  ${t}  ${rel}</div>
            </div>
            <div class="right" style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
              <span class="badge ${statusClass(a.status)}">${a.status}</span>
              ${a.status === 'declined' || a.status === 'cancelled' || a.status === 'completed' ? '' : `<div class="actions-inline">
                <button class="btn-info btn-small" data-action="status" data-id="${a.id}" data-status="scheduled">Reschedule</button>
                <button class="btn-secondary btn-small" data-action="start" data-id="${a.id}">Start</button>
                <button class="btn-danger btn-small" data-action="status" data-id="${a.id}" data-status="cancelled">Cancel</button>
              </div>`}
            </div>
          </li>`;
        }).join('');

        apptOptionsCache = appts.slice();
        const stillExists = apptOptionsCache.some(o => String(o.id) === String(diagApptId.value));
        if (!stillExists) {
          diagApptInput.value = '';
          diagApptId.value = '';
        }
      }

      let patientFilter = '';

      function filterByPatient(appts) {
        // Always return all appointments - no patient filtering
        return appts;
      }

      function filterByDate(appts) {
        if (!selectedDateFilter) return appts;
        return appts.filter(a => formatYYYYMMDD(parseApptDate(a)) === selectedDateFilter);
      }

      function renderPatients(items) {
        patientResults.innerHTML = items.map(p => `
          <li class="item ${p.name === patientFilter ? 'active' : ''}" data-patient="${p.name}">
            <div class="left">
              <div class="primary">${p.displayName || p.name}</div>
              <div class="who">${p.totalAppointments} appt(s)</div>
            </div>
            <div class="right">
            </div>
          </li>
        `).join('');
        if (Array.isArray(items) && items.length) {
          (async () => {
            try {
              await Promise.all(items.map(async (p) => {
                try {
                  const prof = await apiGet(`/api/patients/${encodeURIComponent(p.name)}`);
                  const full = (prof && (prof.fullName || prof.name)) || p.name;
                  const row = patientResults.querySelector(`li.item[data-patient="${p.name}"] .left .primary`);
                  if (row) row.textContent = full;
                } catch (_) { }
              }));
            } catch (_) { }
          })();
        }
      }






      // Event listener for Show Completed toggle
      const showCompletedToggle = document.getElementById('show-completed-toggle');
      if (showCompletedToggle) {
        showCompletedToggle.addEventListener('change', refresh);
      }

      async function refresh() {
        try {
          const allAppts = await apiGet('/api/appointments');
          const items = Array.isArray(allAppts) ? allAppts : [];
          const uniquePatients = Array.from(new Set(items.map(a => a && a.patientName).filter(Boolean)));
          const nameMap = {};
          await Promise.all(uniquePatients.map(async (uname) => {
            try {
              const prof = await apiGet(`/api/patients/${encodeURIComponent(uname)}`);
              const full = (prof && (prof.fullName || prof.name)) || '';
              if (full) nameMap[uname] = full;
            } catch (_) { }
          }));
          // Fetch doctor profiles to get full names
          const doctorNameMap = {};
          try {
            const doctors = await apiGet('/api/doctors');
            if (Array.isArray(doctors)) {
              doctors.forEach(doc => {
                if (doc.name && doc.fullName) doctorNameMap[doc.name] = doc.fullName;
              });
            }
          } catch (_) { }
          const enriched = items.map(a => ({ ...a, displayName: nameMap[a.patientName] || a.patientName, doctorDisplayName: doctorNameMap[a.doctorName] || a.doctorName }));
          const apptsForCalendar = filterByPatient(enriched);
          let apptsForList = filterByDate(apptsForCalendar);

          // Filter out completed appointments if toggle is off
          if (showCompletedToggle && !showCompletedToggle.checked) {
            apptsForList = apptsForList.filter(a => a.status !== 'completed');
          }

          render(apptsForList);
          renderCalendar(apptsForCalendar);
          const diags = await apiGet('/api/diagnoses');
          cachedDiagnoses = diags;
          // Get diagnoses from server-side storage
          const serverDiags = patientFilter
            ? diags.filter(d => String(d.patientName || '').toLowerCase() === patientFilter.toLowerCase())
            : [];

          // Get diagnoses from localStorage
          const localDiags = [];
          if (patientFilter) {
            const allKeys = Object.keys(localStorage);
            const diagnosisKeys = allKeys.filter(key => key.startsWith('diagnosis_'));

            for (const key of diagnosisKeys) {
              try {
                const diagData = JSON.parse(localStorage.getItem(key));
                if (diagData && diagData.apptId) {
                  // Find the appointment to get patient name
                  const appt = cachedAppts.find(a => String(a.id) === String(diagData.apptId));
                  if (appt && appt.patientName === patientFilter) {
                    // Convert localStorage format to match server format
                    const localDiag = {
                      appointmentId: diagData.apptId,
                      patientName: appt.patientName,
                      diagnoses: [diagData.primaryDiagnosis, diagData.secondaryDiagnosis].filter(Boolean),
                      notes: diagData.assessment || '',
                      createdAt: diagData.diagnosedAt,
                      diagnosedBy: diagData.diagnosedBy || 'doctor'
                    };
                    localDiags.push(localDiag);
                  }
                }
              } catch (err) {
                console.warn('Failed to parse diagnosis from localStorage:', err);
              }
            }
          }

          // Combine server and localStorage diagnoses, removing duplicates
          const allDiags = [...serverDiags];
          for (const localDiag of localDiags) {
            const exists = allDiags.find(d => String(d.appointmentId) === String(localDiag.appointmentId));
            if (!exists) {
              allDiags.push(localDiag);
            }
          }

          const diagsFiltered = allDiags;
          const diagList = document.getElementById('diag-list');

          if (!patientFilter) {
            const docPi = document.getElementById('doc-pi');
            if (docPi) docPi.innerHTML = 'Select a patient to view information.';
            if (diagList) diagList.style.display = 'none';
          } else {
            try {
              currentPatientProfile = await apiGet(`/api/patients/${encodeURIComponent(patientFilter)}`);
              const prof = currentPatientProfile;
              // Get diagnoses from server-side storage
              const serverDiags = Array.isArray(cachedDiagnoses) ? cachedDiagnoses.filter(d => String(d.patientName || '') === patientFilter) : [];

              // Get diagnoses from localStorage
              const localDiags = [];
              const allKeys = Object.keys(localStorage);
              const diagnosisKeys = allKeys.filter(key => key.startsWith('diagnosis_'));

              for (const key of diagnosisKeys) {
                try {
                  const diagData = JSON.parse(localStorage.getItem(key));
                  if (diagData && diagData.apptId) {
                    // Find the appointment to get patient name
                    const appt = cachedAppts.find(a => String(a.id) === String(diagData.apptId));
                    if (appt && appt.patientName === patientFilter) {
                      // Convert localStorage format to match server format
                      const localDiag = {
                        appointmentId: diagData.apptId,
                        patientName: appt.patientName,
                        diagnoses: [diagData.primaryDiagnosis, diagData.secondaryDiagnosis].filter(Boolean),
                        notes: diagData.assessment || '',
                        createdAt: diagData.diagnosedAt,
                        diagnosedBy: diagData.diagnosedBy || 'doctor'
                      };
                      localDiags.push(localDiag);
                    }
                  }
                } catch (err) {
                  console.warn('Failed to parse diagnosis from localStorage:', err);
                }
              }

              // Combine server and localStorage diagnoses, removing duplicates
              const allDiags = [...serverDiags];
              for (const localDiag of localDiags) {
                const exists = allDiags.find(d => String(d.appointmentId) === String(localDiag.appointmentId));
                if (!exists) {
                  allDiags.push(localDiag);
                }
              }

              const diagsFor = allDiags;

              const personalHtml = `
                 <div class="section-title" style="display:flex; align-items:center; justify-content:space-between; margin-top:4px;"><h3>Personal Info</h3><div style="display:flex; gap:8px;"><button id="pi-edit" class="btn-small">Edit</button><button id="pi-delete" class="btn-small" style="background:#dc2626; color:#fff; border-color:#dc2626;">Delete Patient</button></div></div>
                 <div style="display:grid; grid-template-columns: 160px 1fr; gap:8px 12px;">
                   <div class="who">Full name</div><div id="pi-fullName">${(prof && (prof.fullName || prof.name)) || ''}</div>
                   <div class="who">Email</div><div id="pi-email">${(prof && prof.email) || ''}</div>
                   <div class="who">Phone</div><div id="pi-phone">${(prof && prof.phone) || ''}</div>
                   <div class="who">Address</div><div id="pi-address">${(prof && (prof.address || prof.location)) || ''}</div>
                   <div class="who">Date of Birth</div><div id="pi-dob">${(prof && (prof.dob || prof.birthDate)) || ''}</div>
                   <div class="who">Gender</div><div id="pi-gender">${(prof && prof.gender) || ''}</div>
                   <div class="who">Blood Type</div><div id="pi-bloodType">${(prof && (prof.bloodType || prof.blood)) || ''}</div>
                 </div>`;
              const tabsHtml = `
                 <div id="pi-tabs" class="tabs">
                  <div class="tab-nav">
                    <button class="tab-link active" data-tab="pi-personal">Personal Info</button>
                    <button class="tab-link" data-tab="pi-history">Past Diagnoses</button>
                    <button class="tab-link" data-tab="pi-medical">Medical History</button>
                  </div>
                   <div class="tab-content">
                     <section class="tab-pane active" id="pi-personal">${personalHtml}</section>
                     <section class="tab-pane" id="pi-history">
                       <div class="field" style="margin-bottom:8px;">
                         <input id="pi-diag-search" type="text" placeholder="Search past diagnoses..." style="width:100%;" />
                       </div>
                       <ul id="pi-diag-list" class="list" style="margin-top:8px;"></ul>
                     </section>
                     <section class="tab-pane" id="pi-medical">
                       <div class="section-title" style="display:flex; align-items:center; justify-content:space-between;">
                         <h3>Medical History</h3>
                         <button id="mh-open" class="btn-small">Add / Edit</button>
                       </div>
                       <div style="display:grid; grid-template-columns: 160px 1fr; gap:8px 12px;">
                         <div class="who">Allergies</div><div id="pi-allergies-view">${Array.isArray(prof?.allergies) && prof.allergies.length ? prof.allergies.join(', ') : ''}</div>
                         <div class="who">Past illnesses</div><div id="pi-illnesses-view">${Array.isArray(prof?.pastIllnesses) && prof.pastIllnesses.length ? prof.pastIllnesses.join(', ') : ''}</div>
                         <div class="who">Surgery history</div><div id="pi-surgeries-view">${Array.isArray(prof?.surgeryHistory) && prof.surgeryHistory.length ? prof.surgeryHistory.join(', ') : ''}</div>
                       </div>
                     </section>
                   </div>
                 </div>`;
              const docPi = document.getElementById('doc-pi');
              if (docPi) docPi.innerHTML = tabsHtml;
              const diagListEl = document.getElementById('pi-diag-list');
              const diagSearchEl = document.getElementById('pi-diag-search');

              function renderDiagnosisList(diagnoses = diagsFor) {
                if (!diagListEl) return;

                if (!diagnoses.length) {
                  diagListEl.innerHTML = `<li class="item" style="justify-content:center;"><div class="who">No past diagnoses.</div></li>`;
                } else {
                  diagListEl.innerHTML = diagnoses.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).map(d => `
                     <li class="item" data-appt-id="${d.appointmentId}">
                     <div class="left">
                       <div class="primary">Appt #${d.appointmentId}</div>
                <div class="who">${new Date(d.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at ${new Date(d.createdAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}</div>
                     </div>
                     <div class="right"><span class="who">${(Array.isArray(d.diagnoses) && d.diagnoses.length ? d.diagnoses.join(', ') : (d.diagnosis || ''))}</span></div>
              </li>
            `).join('');
                }
              }

              // Initial render
              renderDiagnosisList();

              // Add search functionality
              if (diagSearchEl) {
                diagSearchEl.addEventListener('input', (e) => {
                  const query = e.target.value.toLowerCase().trim();
                  if (!query) {
                    renderDiagnosisList();
                    return;
                  }

                  const filtered = diagsFor.filter(d => {
                    const diagnoses = Array.isArray(d.diagnoses) ? d.diagnoses : [d.diagnosis || ''];
                    const appointmentId = String(d.appointmentId);
                    const date = new Date(d.createdAt).toLocaleString();

                    return diagnoses.some(diag => diag.toLowerCase().includes(query)) ||
                      appointmentId.includes(query) ||
                      date.toLowerCase().includes(query);
                  });

                  renderDiagnosisList(filtered);
                });
              }

              // Enable viewing appointment details (vitals, diagnosis, actions) from Past Diagnoses tab
              if (diagListEl) {
                diagListEl.addEventListener('click', async (ev) => {
                  const li = ev.target.closest('li.item[data-appt-id]');
                  if (!li) return;
                  const apptId = li.getAttribute('data-appt-id');
                  try {
                    const appt = cachedAppts.find(a => String(a.id) === String(apptId));
                    if (!appt) return;
                    const d = parseApptDate(appt);
                    const patientFullName = currentPatientProfile ? (currentPatientProfile.fullName || currentPatientProfile.name || appt.patientName) : appt.patientName;
                    const details = {
                      avatarText: patientFullName || 'P',
                      title: `Appt #${appt.id}  ${patientFullName}`,
                      subtitle: `${d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at ${d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}  Dr. ${appt.doctorDisplayName || appt.doctorName}`,
                      wide: true
                    };

                    // Load vitals for this appointment - try server first, then localStorage
                    const patientName = appt.patientName;
                    const time = appt.time || '';
                    // Prefer server-side storage for reliability
                    let vitals = null;

                    // Try to load from server first
                    try {
                      const serverVitals = await apiGet(`/api/vitals/${String(appt.id)}`);
                      if (serverVitals) {
                        vitals = serverVitals;
                        console.log('Loaded vitals from server for past appointment:', appt.id);
                      }
                    } catch (err) {
                      // Server vitals not found, fallback to localStorage
                      console.log('No server vitals found for past appointment, checking localStorage');
                    }

                    // Fallback to localStorage if no server data
                    if (!vitals) {
                      try {
                        const byId = localStorage.getItem(`vitals_appt_${String(appt.id)}`);
                        if (byId) {
                          try {
                            vitals = JSON.parse(byId);
                          } catch (e) { }
                        }
                      } catch (e) { }
                      const vitalsKeys = [
                        `nurse_vitals_${patientName}_${time}`,
                        `nurse_vitals_${patientName}_${String(time).replace(/[:\s]/g, '_')}`,
                        `nurse_vitals_${patientName}_${String(time).replace(/[:\s-]/g, '_')}`,
                        // Also try ISO format variations
                        `nurse_vitals_${patientName}_${String(time).replace(/[T\s]/g, '_')}`,
                        `nurse_vitals_${patientName}_${String(time).replace(/[T\s-]/g, '_')}`,
                        `nurse_vitals_${patientName}_${String(time).replace(/[T\s:-]/g, '_')}`
                      ];
                      console.log('Searching for vitals with keys:', vitalsKeys);
                      for (const k of vitalsKeys) {
                        if (vitals) break;
                        const raw = localStorage.getItem(k);
                        if (raw) {
                          try {
                            vitals = JSON.parse(raw);
                          } catch (e) { }
                          if (vitals) break;
                        }
                      }
                    }

                    // Load diagnosis for this appointment from localStorage, fallback to cachedDiagnoses
                    let diag = null;
                    try {
                      const rawDiag = localStorage.getItem(`diagnosis_${appt.id}`);
                      if (rawDiag) diag = JSON.parse(rawDiag);
                    } catch (_) { }
                    if (!diag) {
                      const fromServer = cachedDiagnoses.find(dg => String(dg.appointmentId) === String(appt.id));
                      if (fromServer) {
                        diag = {
                          primaryDiagnosis: Array.isArray(fromServer.diagnoses) ? (fromServer.diagnoses[0] || '') : (fromServer.diagnosis || ''),
                          secondaryDiagnosis: Array.isArray(fromServer.diagnoses) ? (fromServer.diagnoses[1] || '') : '',
                          assessment: fromServer.notes || '',
                          recommendations: fromServer.recommendations || '',
                          diagnosedAt: fromServer.createdAt || ''
                        };
                      }
                    }

                    const vitalsHtml = `
                       <div class="section-title" style="display:flex; align-items:center; justify-content:space-between;"><h3>Vitals</h3></div>
                       <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
                         <div style="display:grid; grid-template-columns:80px 1fr; gap:8px 12px;">
                           <div class="who">BP</div><div>${vitals?.bp || '<span style="color:#94a3b8; font-style:italic;">Not recorded</span>'}</div>
                           <div class="who">HR</div><div>${vitals?.hr || '<span style="color:#94a3b8; font-style:italic;">Not recorded</span>'}</div>
                           <div class="who">RR</div><div>${vitals?.rr || '<span style="color:#94a3b8; font-style:italic;">Not recorded</span>'}</div>
                           <div class="who">Temp</div><div>${vitals?.temp || '<span style="color:#94a3b8; font-style:italic;">Not recorded</span>'}</div>
                         </div>
                         <div style="display:grid; grid-template-columns:80px 1fr; gap:8px 12px;">
                           <div class="who">Height</div><div>${vitals?.heightCm || '<span style="color:#94a3b8; font-style:italic;">Not recorded</span>'}</div>
                           <div class="who">Weight</div><div>${vitals?.weightKg || '<span style="color:#94a3b8; font-style:italic;">Not recorded</span>'}</div>
                           <div class="who">BMI</div><div>${vitals?.bmi ? `${vitals.bmi}${vitals?.bmiCategory ? ' (' + vitals.bmiCategory + ')' : ''}` : '<span style="color:#94a3b8; font-style:italic;">Not recorded</span>'}</div>
                           <div class="who">Exam</div><div style="white-space:pre-wrap;">${vitals?.physicalExam || '<span style="color:#94a3b8; font-style:italic;">Not recorded</span>'}</div>
                         </div>
                       </div>`;

                    const diagHtml = `
                       <div class="section-title" style="display:flex; align-items:center; justify-content:space-between;"><h3>Impressions and Assesments</h3></div>
                       <div style="display:grid; grid-template-columns:160px 1fr; gap:8px 12px;">
                         <div class="who">Primary</div><div>${(diag?.primaryDiagnosis || '<span style="color:#94a3b8; font-style:italic;">Not provided</span>')}</div>
                         <div class="who">Secondary</div><div>${(diag?.secondaryDiagnosis || '<span style="color:#94a3b8; font-style:italic;">Not provided</span>')}</div>
                         <div class="who">Assessment</div><div style="white-space:pre-wrap;">${(diag?.assessment || '<span style="color:#94a3b8; font-style:italic;">Not provided</span>')}</div>
                         <div class="who">Recommendations</div><div style="white-space:pre-wrap;">${(diag?.recommendations || '<span style="color:#94a3b8; font-style:italic;">Not provided</span>')}</div>
                         <div class="who">Recorded</div><div>${diag?.diagnosedAt ? `${new Date(diag.diagnosedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at ${new Date(diag.diagnosedAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}` : '<span style="color:#94a3b8; font-style:italic;">Not recorded</span>'}</div>
                       </div>`;

                    const ccHtml = appt.chiefComplaint ? `<div class=\"section-title\"><h3>Chief Complaint</h3></div><div style=\"padding:12px; background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:8px; white-space:pre-wrap; color:var(--text, #0f172a);\">${appt.chiefComplaint}</div>` : '';

                    const html = `
                       ${ccHtml}
                       ${vitalsHtml}
                       ${diagHtml}
                     `;

                    // Create modal with actions in header
                    const modal = document.createElement('div');
                    modal.className = 'modal-backdrop';
                    modal.innerHTML = `
                       <div class="modal-card wide" role="dialog" aria-modal="true" aria-labelledby="appt-modal-title">
                         <div class="modal-header">
                           <div class="modal-title-wrap">
                             <div class="modal-avatar">${(patientFullName || 'P').slice(0, 1).toUpperCase()}</div>
                             <div>
                               <div class="modal-title" id="appt-modal-title">${details.title}</div>
                               <div class="modal-sub who">${details.subtitle}</div>
                             </div>
                           </div>
                           <div style="display:flex; gap:8px; align-items:center;">
                             <button id="appt-gen-prescription" class="btn-secondary btn-small">Prescription</button>
                             <button id="appt-gen-cert" class="btn-secondary btn-small">Certificate</button>
                             <button id="appt-gen-lab" class="btn-secondary btn-small">Lab</button>
                             <button id="appt-close" class="btn-secondary btn-small">Close</button>
                           </div>
                         </div>
                         <div class="modal-body">${html}</div>
                       </div>`;
                    document.body.appendChild(modal);

                    // Close modal function
                    function closeApptModal() {
                      try { document.body.removeChild(modal); } catch (_) { }
                    }

                    // Wire close button
                    modal.querySelector('#appt-close')?.addEventListener('click', closeApptModal);

                    // Show modal
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';

                    // Wire action buttons
                    const btnRx = modal.querySelector('#appt-gen-prescription');
                    btnRx?.addEventListener('click', () => {
                      openPrescriptionModal();
                    });

                    const btnCert = modal.querySelector('#appt-gen-cert');
                    btnCert?.addEventListener('click', async () => {
                      try {
                        const prof = await apiGet(`/api/patients/${encodeURIComponent(appt.patientName)}`);
                        const params = new URLSearchParams();
                        const fullName = prof?.fullName || prof?.name || appt.patientName || '';
                        if (fullName) params.set('name', fullName);
                        if (prof?.gender) params.set('sex', prof.gender);
                        if (prof?.address || prof?.location) params.set('address', prof.address || prof.location);
                        if (prof?.dob || prof?.birthDate) params.set('dob', prof.dob || prof.birthDate);
                        if (diag?.primaryDiagnosis || diag?.secondaryDiagnosis) {
                          const reason = [diag?.primaryDiagnosis, diag?.secondaryDiagnosis].filter(Boolean).join('\n');
                          if (reason) params.set('reason', reason);
                        }
                        if (diag?.assessment) params.set('assessment', diag.assessment);
                        if (diag?.recommendations) params.set('recommendations', diag.recommendations);
                        params.set('autoprint', '1');
                        const href = '/forms/diz/Doc Dizon/Doc Dizon - Medical Certificate/MAIN FORM Doc Dizon - Medical Certificate.html';
                        const url = encodeURI(href) + (params.toString() ? (`?${params.toString()}`) : '');

                        // Create hidden iframe for printing
                        const iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        iframe.src = url;
                        document.body.appendChild(iframe);

                        // Listen for print completion message
                        const messageHandler = function (event) {
                          if (event.data === 'print-complete') {
                            document.body.removeChild(iframe);
                            window.removeEventListener('message', messageHandler);
                          }
                        };
                        window.addEventListener('message', messageHandler);

                        // Fallback: remove iframe after timeout
                        setTimeout(() => {
                          if (document.body.contains(iframe)) {
                            document.body.removeChild(iframe);
                            window.removeEventListener('message', messageHandler);
                          }
                        }, 10000);
                      } catch (_) { }
                    });

                    const btnLab = modal.querySelector('#appt-gen-lab');
                    btnLab?.addEventListener('click', () => {
                      openExamsModal();
                    });
                  } catch (_) { }
                });
              }
              const tabs = document.getElementById('pi-tabs');
              if (tabs) {
                const links = Array.from(tabs.querySelectorAll('.tab-link'));
                const panes = Array.from(tabs.querySelectorAll('.tab-pane'));
                tabs.addEventListener('click', (ev) => {
                  const btn = ev.target.closest('.tab-link');
                  if (!btn) return;
                  const id = btn.getAttribute('data-tab');
                  links.forEach(l => l.classList.toggle('active', l === btn));
                  panes.forEach(p => p.classList.toggle('active', p.id === id));
                });
              }
              (function initPersonalEdit() {
                const piEdit = document.getElementById('pi-edit');
                if (!piEdit) return;
                piEdit.addEventListener('click', async () => {
                  const overlay = document.createElement('div');
                  overlay.className = 'modal-backdrop';
                  overlay.style.zIndex = '2300';
                  let seedProfile = null;
                  try { seedProfile = await apiGet(`/api/patients/${encodeURIComponent(patientFilter)}`); } catch (_) { seedProfile = {}; }
                  overlay.innerHTML = `
                    <div class="modal-card wide" role="dialog" aria-modal="true" aria-labelledby="pi-title">
                      <div class="modal-header">
                        <div class="modal-title" id="pi-title">Edit Personal Information</div>
                        <button id="pi-close" class="btn-secondary btn-small">Close</button>
                      </div>
                      <div class="modal-body" style="max-height:none;">
                        <form id="pi-form" class="form-grid">
                          <div class="field">
                            <label for="pi-fullName-input">Full name</label>
                            <input id="pi-fullName-input" value="${(seedProfile.fullName || seedProfile.name || '')}" />
                          </div>
                          <div class="field">
                            <label for="pi-email-input">Email</label>
                            <input id="pi-email-input" type="email" value="${seedProfile.email || ''}" />
                          </div>
                          <div class="field">
                            <label for="pi-dob-input">Date of Birth</label>
                            <input id="pi-dob-input" placeholder="YYYY-MM-DD" value="${(seedProfile.dob || seedProfile.birthDate || '')}" />
                          </div>
                          <div class="field">
                            <label for="pi-phone-input">Phone</label>
                            <input id="pi-phone-input" placeholder="e.g. 09123456789" value="${seedProfile.phone || ''}" />
                          </div>
                          <div class="field col-span-2">
                            <label for="pi-address-input">Address</label>
                            <input id="pi-address-input" value="${(seedProfile.address || seedProfile.location || '')}" />
                          </div>
                          <div class="field">
                            <label for="pi-gender-input">Gender</label>
                            <input id="pi-gender-input" value="${seedProfile.gender || ''}" />
                          </div>
                          <div class="field">
                            <label for="pi-bloodType-input">Blood Type</label>
                            <input id="pi-bloodType-input" value="${(seedProfile.bloodType || seedProfile.blood || '')}" />
                          </div>
                          <div class="actions col-span-2">
                            <button type="submit">Save</button>
                          </div>
                        </form>
                      </div>
                    </div>`;
                  document.body.appendChild(overlay);
                  function close() { try { document.body.removeChild(overlay); } catch (_) { } }
                  const cBtn = overlay.querySelector('#pi-close'); if (cBtn) cBtn.addEventListener('click', close);
                  const form = overlay.querySelector('#pi-form');
                  if (form) {
                    form.addEventListener('submit', async (ev) => {
                      ev.preventDefault();
                      const msg = overlay.querySelector('#pi-msg');
                      const payload = {
                        fullName: (overlay.querySelector('#pi-fullName-input')?.value || '').trim(),
                        email: (overlay.querySelector('#pi-email-input')?.value || '').trim(),
                        phone: (overlay.querySelector('#pi-phone-input')?.value || '').trim(),
                        address: (overlay.querySelector('#pi-address-input')?.value || '').trim(),
                        dob: (overlay.querySelector('#pi-dob-input')?.value || '').trim(),
                        gender: (overlay.querySelector('#pi-gender-input')?.value || '').trim(),
                        bloodType: (overlay.querySelector('#pi-bloodType-input')?.value || '').trim(),
                      };
                      try {
                        await apiPut(`/api/patients/${encodeURIComponent(patientFilter)}`, payload);
                        const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v || ''; };
                        setText('pi-fullName', payload.fullName);
                        setText('pi-email', payload.email);
                        setText('pi-phone', payload.phone);
                        setText('pi-address', payload.address);
                        setText('pi-dob', payload.dob);
                        setText('pi-gender', payload.gender);
                        setText('pi-bloodType', payload.bloodType);
                        showDoctorFeedbackModal('Personal Information', 'Saved successfully', 'success');
                        close();
                      } catch (err) {
                        showDoctorFeedbackModal('Personal Information', (err && err.message) || 'Save failed', 'error');
                      }
                    });
                  }
                });
              })();

              (function initPatientDelete() {
                const piDelete = document.getElementById('pi-delete');
                if (!piDelete) return;
                piDelete.addEventListener('click', async () => {
                  const patientName = patientFilter;
                  if (!patientName) return;

                  const patientFullName = currentPatientProfile ? (currentPatientProfile.fullName || currentPatientProfile.name || patientName) : patientName;

                  // Show confirmation modal
                  const overlay = document.createElement('div');
                  overlay.className = 'modal-backdrop';
                  overlay.style.zIndex = '2300';
                  overlay.innerHTML = `
                    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="delete-title">
                      <div class="modal-header">
                        <div class="modal-title" id="delete-title">Delete Patient</div>
                        <button id="delete-close" class="btn-secondary btn-small">Cancel</button>
                      </div>
                      <div class="modal-body">
                        <div style="margin-bottom: 16px;">
                          <p><strong>Warning:</strong> This action will permanently delete the patient and all associated data including:</p>
                          <ul style="margin: 8px 0; padding-left: 20px;">
                            <li>Patient profile and personal information</li>
                            <li>All appointments</li>
                            <li>All diagnoses and medical records</li>
                            <li>All uploaded documents</li>
                            <li>User account</li>
                          </ul>
                          <p><strong>This action cannot be undone.</strong></p>
                        </div>
                        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                          <p style="margin: 0; color: #991b1b; font-weight: 600;">Patient: ${patientFullName}</p>
                        </div>
                        <div class="actions" style="justify-content: flex-end; gap: 8px;">
                          <button id="delete-cancel" class="btn-secondary">Cancel</button>
                          <button id="delete-confirm" class="btn" style="background: #dc2626; color: #fff; border-color: #dc2626;">Delete Patient</button>
                        </div>
                      </div>
                    </div>`;

                  document.body.appendChild(overlay);

                  function close() {
                    try { document.body.removeChild(overlay); } catch (_) { }
                  }

                  // Close on cancel buttons
                  const cancelBtn = overlay.querySelector('#delete-cancel');
                  const closeBtn = overlay.querySelector('#delete-close');
                  if (cancelBtn) cancelBtn.addEventListener('click', close);
                  if (closeBtn) closeBtn.addEventListener('click', close);

                  // Handle delete confirmation
                  const confirmBtn = overlay.querySelector('#delete-confirm');
                  if (confirmBtn) {
                    confirmBtn.addEventListener('click', async () => {
                      try {
                        // Disable button to prevent double-clicks
                        confirmBtn.disabled = true;
                        confirmBtn.textContent = 'Deleting...';

                        await apiDelete(`/api/patients/${encodeURIComponent(patientName)}`);

                        // Clear patient filter and refresh
                        patientFilter = '';
                        const patientSearch = document.getElementById('patient-search');
                        if (patientSearch) patientSearch.value = '';

                        showDoctorFeedbackModal('Patient Deleted', `Patient ${patientFullName} has been deleted successfully`, 'success');
                        close();

                        // Refresh the patient list and clear the patient info display
                        try { await refresh(); } catch (_) { }

                      } catch (err) {
                        // Re-enable button on error
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'Delete Patient';

                        const errorMessage = (err && err.message) || 'Failed to delete patient';
                        showDoctorFeedbackModal('Delete Error', errorMessage, 'error');
                      }
                    });
                  }
                });
              })();

              (function initMedicalHistoryEdit() {
                const mhOpen = document.getElementById('mh-open');
                if (!mhOpen) return;
                mhOpen.addEventListener('click', async () => {
                  const overlay = document.createElement('div');
                  overlay.className = 'modal-backdrop';
                  overlay.style.zIndex = '2300';
                  let seedProfile = null;
                  try { seedProfile = await apiGet(`/api/patients/${encodeURIComponent(patientFilter)}`); } catch (_) { seedProfile = {}; }
                  overlay.innerHTML = `
                    <div class="modal-card wide" role="dialog" aria-modal="true" aria-labelledby="mh-title">
                      <div class="modal-header">
                        <div class="modal-title" id="mh-title">Edit Medical History</div>
                        <button id="mh-close" class="btn-secondary btn-small">Close</button>
                      </div>
                      <div class="modal-body" style="max-height:none;">
                        <div class="who">Type to add, press Enter or pick from dropdown. Use  to remove.</div>
                        <form id="mh-form" class="form-grid" style="margin-top:8px;">
                          <div class="field col-span-2">
                            <label for="mh-allergies-input">Allergies</label>
                            <div class="dropdown" style="position:relative;">
                              <input id="mh-allergies-input" placeholder="Search or type allergy" autocomplete="off" />
                              <ul id="mh-allergies-menu" class="dropdown-menu" style="display:none; position:absolute; top:100%; left:0; right:0; background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:8px; margin-top:4px; padding:4px 0; z-index:3000; max-height:220px; overflow:auto; box-shadow:0 24px 40px rgba(15,23,42,0.35);"></ul>
                            </div>
                            <div id="mh-allergies-chips" class="chips"></div>
                          </div>
                          <div class="field col-span-2">
                            <label for="mh-illnesses-input">Past illnesses</label>
                            <div class="dropdown" style="position:relative;">
                              <input id="mh-illnesses-input" placeholder="Search or type illness" autocomplete="off" />
                              <ul id="mh-illnesses-menu" class="dropdown-menu" style="display:none; position:absolute; top:100%; left:0; right:0; background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:8px; margin-top:4px; padding:4px 0; z-index:3000; max-height:220px; overflow:auto; box-shadow:0 24px 40px rgba(15,23,42,0.35);"></ul>
                            </div>
                            <div id="mh-illnesses-chips" class="chips"></div>
                          </div>
                          <div class="field col-span-2">
                            <label for="mh-surgeries-input">Surgery history</label>
                            <div class="dropdown" style="position:relative;">
                              <input id="mh-surgeries-input" placeholder="Search or type surgery" autocomplete="off" />
                              <ul id="mh-surgeries-menu" class="dropdown-menu" style="display:none; position:absolute; top:100%; left:0; right:0; background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:8px; margin-top:4px; padding:4px 0; z-index:3000; max-height:220px; overflow:auto; box-shadow:0 24px 40px rgba(15,23,42,0.35);"></ul>
                            </div>
                            <div id="mh-surgeries-chips" class="chips"></div>
                          </div>
                          <div class="actions col-span-2">
                            <button type="submit">Save</button>
                          </div>
                        </form>
                      </div>
                    </div>`;
                  document.body.appendChild(overlay);
                  function close() { try { document.body.removeChild(overlay); } catch (_) { } }
                  overlay.addEventListener('click', (e) => { if (e.target === overlay) close(); });
                  overlay.querySelector('#mh-close')?.addEventListener('click', close);

                  function initChipInput(inputId, menuId, chipsId, initial, suggestions) {
                    const input = overlay.querySelector('#' + inputId);
                    const menu = overlay.querySelector('#' + menuId);
                    const chips = overlay.querySelector('#' + chipsId);
                    let values = Array.isArray(initial) ? initial.slice(0, 50) : [];
                    function renderChips() {
                      chips.innerHTML = values.map(v => `<span class="chip">${v}<button type="button" aria-label="Remove"></button></span>`).join('');
                    }
                    function open() { menu.style.display = 'block'; }
                    function closeMenu() { menu.style.display = 'none'; }
                    function position() { /* absolute inside container; already styled */ }
                    function filterAndRender(q) {
                      const list = (suggestions || []).filter(s => String(s).toLowerCase().includes(String(q || '').toLowerCase())).slice(0, 50);
                      menu.innerHTML = list.map(s => `<li>${s}</li>`).join('');
                      open(); position();
                    }
                    renderChips();
                    input.addEventListener('input', () => filterAndRender(input.value));
                    input.addEventListener('focus', () => filterAndRender(input.value));
                    document.addEventListener('click', (ev) => { if (!menu.contains(ev.target) && ev.target !== input) closeMenu(); });
                    menu.addEventListener('mousedown', (e) => {
                      const li = e.target.closest('li');
                      if (!li) return;
                      e.preventDefault();
                      const val = li.textContent || '';
                      if (val && !values.includes(val)) values.push(val);
                      renderChips();
                      closeMenu();
                      input.value = '';
                    });
                    chips.addEventListener('click', (e) => {
                      if (e.target.tagName === 'BUTTON') {
                        const label = e.target.parentElement?.firstChild?.textContent || '';
                        values = values.filter(v => v !== label);
                        renderChips();
                      }
                    });
                    input.addEventListener('keydown', (e) => {
                      if (e.key === 'Enter') {
                        e.preventDefault();
                        const val = (input.value || '').trim();
                        if (val && !values.includes(val)) values.push(val);
                        input.value = '';
                        renderChips();
                        closeMenu();
                      }
                    });
                    return { getValues: () => values.slice(0, 50) };
                  }

                  const commonAllergies = ['Penicillin', 'Peanuts', 'Shellfish', 'Aspirin', 'Latex', 'Milk', 'Eggs', 'Soy', 'Tree nuts', 'Sulfa drugs'];
                  const commonIllnesses = ['Asthma', 'Hypertension', 'Diabetes', 'Chickenpox', 'Tuberculosis', 'Anemia', 'Hepatitis', 'Migraine', 'Anxiety disorder', 'Depression'];
                  const commonSurgeries = ['Appendectomy', 'Cesarean section', 'Cholecystectomy', 'Knee arthroscopy', 'Hip replacement', 'Hernia repair', 'Tonsillectomy', 'CABG', 'Cataract surgery', 'Mastectomy'];
                  const aInit = Array.isArray(seedProfile?.allergies) ? seedProfile.allergies : [];
                  const iInit = Array.isArray(seedProfile?.pastIllnesses) ? seedProfile.pastIllnesses : [];
                  const sInit = Array.isArray(seedProfile?.surgeryHistory) ? seedProfile.surgeryHistory : [];
                  const aMgr = initChipInput('mh-allergies-input', 'mh-allergies-menu', 'mh-allergies-chips', aInit, commonAllergies);
                  const iMgr = initChipInput('mh-illnesses-input', 'mh-illnesses-menu', 'mh-illnesses-chips', iInit, commonIllnesses);
                  const sMgr = initChipInput('mh-surgeries-input', 'mh-surgeries-menu', 'mh-surgeries-chips', sInit, commonSurgeries);

                  const form = overlay.querySelector('#mh-form');
                  if (form) {
                    form.addEventListener('submit', async (ev) => {
                      ev.preventDefault();
                      const msg = overlay.querySelector('#mh-msg');
                      const payload = { allergies: aMgr.getValues(), pastIllnesses: iMgr.getValues(), surgeryHistory: sMgr.getValues() };
                      try {
                        await apiPut(`/api/patients/${encodeURIComponent(patientFilter)}`, payload);
                        const aView = document.getElementById('pi-allergies-view'); if (aView) aView.textContent = payload.allergies.length ? payload.allergies.join(', ') : '';
                        const iView = document.getElementById('pi-illnesses-view'); if (iView) iView.textContent = payload.pastIllnesses.length ? payload.pastIllnesses.join(', ') : '';
                        const sView = document.getElementById('pi-surgeries-view'); if (sView) sView.textContent = payload.surgeryHistory.length ? payload.surgeryHistory.join(', ') : '';
                        showDoctorFeedbackModal('Medical History', 'Saved successfully', 'success');
                        close();
                      } catch (err) {
                        showDoctorFeedbackModal('Medical History', (err && err.message) || 'Save failed', 'error');
                      }
                    });
                  }
                });
              })();
            } catch (_) {
              const docPi = document.getElementById('doc-pi');
              if (docPi) docPi.innerHTML = 'Failed to load patient information.';
            }
          }
          const apptIdsWithDiag = new Set(diags.map(d => String(d.appointmentId)));
          apptOptionsCache = apptsForCalendar.filter(a => !apptIdsWithDiag.has(String(a.id)));
          const stillAvailableForDiag = apptOptionsCache.some(o => String(o.id) === String(diagApptId.value));
          if (!stillAvailableForDiag) {
            diagApptInput.value = '';
            diagApptId.value = '';
            selectedDiagnoses.clear();
            renderChips();
          }
          filterAndRender();
          filterAndRenderAppts();
          const q = patientSearch.value.trim();
          const patients = await apiGet('/api/patients' + (q ? `?q=${encodeURIComponent(q)}` : ''));
          renderPatients(patients);
        } catch (e) {
          list.innerHTML = `<li>Error loading appointments</li>`;
        }
      }

      list.addEventListener('click', async (e) => {
        const liItem = e.target.closest('li.item[data-appt-id]');
        if (liItem && !e.target.closest('button')) {
          return;
        }
        const startBtn = e.target.closest('button[data-action="start"]');
        if (startBtn) {
          const apptId = startBtn.getAttribute('data-id');
          const appt = cachedAppts.find(a => String(a.id) === String(apptId));
          const patient = appt ? (appt.displayName || appt.patientName) : '';

          if (appt && appt.patientName) {
            try {
              currentPatientProfile = await apiGet(`/api/patients/${encodeURIComponent(appt.patientName)}`);
            } catch (_) {
              currentPatientProfile = null;
            }
          }

          async function openVitals() {
            const overlay = document.createElement('div');
            overlay.className = 'modal-backdrop';

            // Get patient full name from currentPatientProfile
            const patientFullName = currentPatientProfile ? (currentPatientProfile.fullName || currentPatientProfile.name || patient) : patient;

            overlay.innerHTML = `
               <div class="modal-card wide" role="dialog" aria-modal="true" aria-labelledby="vs-title">
                 <div class="modal-header">
                   <div class="modal-title-wrap"><div class="modal-title" id="vs-title">Vitals & Physical Exam</div><div class="modal-subtitle who">Patient: ${patientFullName}  Appt #${apptId}</div></div>
                   <button id="vs-close" class="btn-secondary btn-small">Close</button>
                 </div>
                <div class="modal-body" style="max-height:none;">
                  <form id="vs-form" class="form-grid">
                    <div class="field">
                      <label for="vs-bp">Blood Pressure (mmHg)</label>
                      <input id="vs-bp" placeholder="e.g. 120/80" />
                    </div>
                    <div class="field">
                      <label for="vs-hr">Heart Rate (bpm)</label>
                      <input id="vs-hr" type="number" min="0" placeholder="e.g. 72" />
                    </div>
                    <div class="field">
                      <label for="vs-rr">Respiratory Rate (breaths/min)</label>
                      <input id="vs-rr" type="number" min="0" placeholder="e.g. 16" />
                    </div>
                    <div class="field">
                      <label for="vs-temp">Temperature (C)</label>
                      <input id="vs-temp" type="number" step="0.1" placeholder="e.g. 36.5" />
                    </div>
                    <div class="field">
                      <label for="vs-height">Height (cm)</label>
                      <input id="vs-height" type="number" min="0" step="0.1" placeholder="e.g. 170" />
                    </div>
                    <div class="field">
                      <label for="vs-weight">Weight (kg)</label>
                      <input id="vs-weight" type="number" min="0" step="0.1" placeholder="e.g. 70" />
                    </div>
                    <div class="field col-span-2">
                      <label>BMI (Asian classification)</label>
                      <div id="vs-bmi" class="who"></div>
                    </div>
                    <div class="field col-span-2">
                      <label for="vs-exam">Physical Examination</label>
                      <textarea id="vs-exam" rows="4" placeholder="Enter physical examination findings..." style="resize: none;"></textarea>
                    </div>
                  </form>
                </div>
              </div>`;
            document.body.appendChild(overlay);
            function close() { try { document.body.removeChild(overlay); } catch (_) { } }
            overlay.querySelector('#vs-close')?.addEventListener('click', close);

            const patientName = appt ? appt.patientName : '';
            const appointmentTime = appt ? appt.time : '';
            console.log('Vitals modal - appointment object:', appt);
            console.log('Vitals modal - appointmentTime:', appointmentTime);

            const possibleKeys = [
              `nurse_vitals_${patientName}_${appointmentTime}`,
              `nurse_vitals_${patientName}_${appointmentTime.replace(/[:\s]/g, '_')}`,
              `nurse_vitals_${patientName}_${appointmentTime.replace(/[:\s-]/g, '_')}`
            ];

            let nurseVitalsData = null;
            let foundKey = null;

            // Try to load vitals from server first
            try {
              const apptIdForVitals = appt && appt.id != null ? String(appt.id) : '';
              if (apptIdForVitals) {
                const serverVitals = await apiGet(`/api/vitals/${apptIdForVitals}`);
                if (serverVitals) {
                  nurseVitalsData = JSON.stringify(serverVitals);
                  console.log('Loaded vitals from server for appointment:', apptIdForVitals);
                }
              }
            } catch (err) {
              // Server vitals not found or error, will fallback to localStorage
              console.log('No server vitals found, checking localStorage');
            }

            // Fallback to localStorage if no server data
            if (!nurseVitalsData) {
              for (const key of possibleKeys) {
                nurseVitalsData = localStorage.getItem(key);
                if (nurseVitalsData) {
                  foundKey = key;
                  break;
                }
              }
            }

            // Only load vital signs if they were specifically recorded for this appointment
            // Don't fall back to previous appointments' vital signs

            // Function to save vitals data
            async function saveVitalsData() {
              const bp = overlay.querySelector('#vs-bp')?.value?.trim() || '';
              const hr = overlay.querySelector('#vs-hr')?.value?.trim() || '';
              const rr = overlay.querySelector('#vs-rr')?.value?.trim() || '';
              const temp = overlay.querySelector('#vs-temp')?.value?.trim() || '';
              const height = overlay.querySelector('#vs-height')?.value?.trim() || '';
              const weight = overlay.querySelector('#vs-weight')?.value?.trim() || '';
              const exam = overlay.querySelector('#vs-exam')?.value?.trim() || '';

              // Calculate BMI if height and weight are provided
              let bmi = '';
              let bmiCategory = '';
              if (height && weight) {
                const heightM = parseFloat(height) / 100;
                const weightKg = parseFloat(weight);
                if (heightM > 0 && weightKg > 0) {
                  bmi = (weightKg / (heightM * heightM)).toFixed(1);
                  // Asian BMI classification
                  if (bmi < 18.5) bmiCategory = 'Underweight';
                  else if (bmi < 23) bmiCategory = 'Normal';
                  else if (bmi < 27.5) bmiCategory = 'Overweight';
                  else bmiCategory = 'Obese';
                }
              }

              const vitalsData = {
                bp,
                hr,
                rr,
                temp,
                heightCm: height,
                weightKg: weight,
                bmi,
                bmiCategory,
                physicalExam: exam,
                recordedBy: 'doctor',
                recordedAt: new Date().toISOString()
              };

              // Save to localStorage with appointment-specific key (for backward compatibility)
              const key = `nurse_vitals_${patientName}_${appointmentTime.replace(/[:\s-]/g, '_')}`;
              console.log('Saving vitals with key:', key, 'appointmentTime:', appointmentTime);
              localStorage.setItem(key, JSON.stringify(vitalsData));
              // Also save using appointmentId-based key for reliable lookup in past diagnoses
              try {
                const apptIdForVitals = appt && appt.id != null ? String(appt.id) : '';
                if (apptIdForVitals) {
                  localStorage.setItem(`vitals_appt_${apptIdForVitals}`, JSON.stringify(vitalsData));
                }
              } catch (e) { }

              // Save to server database
              try {
                const apptIdForVitals = appt && appt.id != null ? String(appt.id) : '';
                if (apptIdForVitals) {
                  await apiPut(`/api/vitals/${apptIdForVitals}`, vitalsData);
                  console.log('Vitals saved to database for appointment:', apptIdForVitals);
                }
              } catch (err) {
                console.error('Failed to save vitals to database:', err);
                // Don't block the user flow if server save fails - localStorage is still available
              }

              return vitalsData;
            }

            // Add real-time BMI calculation
            const heightInput = overlay.querySelector('#vs-height');
            const weightInput = overlay.querySelector('#vs-weight');
            const bmiDisplay = overlay.querySelector('#vs-bmi');

            function calculateBMI() {
              const height = parseFloat(heightInput?.value || 0);
              const weight = parseFloat(weightInput?.value || 0);

              if (height > 0 && weight > 0) {
                const heightM = height / 100;
                const bmi = (weight / (heightM * heightM)).toFixed(1);
                let bmiCategory = '';

                // Asian BMI classification
                if (bmi < 18.5) bmiCategory = 'Underweight';
                else if (bmi < 23) bmiCategory = 'Normal';
                else if (bmi < 27.5) bmiCategory = 'Overweight';
                else bmiCategory = 'Obese';

                if (bmiDisplay) {
                  bmiDisplay.textContent = `${bmi} (${bmiCategory})`;
                }
              } else if (bmiDisplay) {
                bmiDisplay.textContent = '';
              }
            }

            heightInput?.addEventListener('input', calculateBMI);
            weightInput?.addEventListener('input', calculateBMI);

            if (nurseVitalsData) {
              try {
                const vitals = JSON.parse(nurseVitalsData);
                overlay.querySelector('#vs-bp').value = vitals.bp || '';
                overlay.querySelector('#vs-hr').value = vitals.hr || '';
                overlay.querySelector('#vs-rr').value = vitals.rr || '';
                overlay.querySelector('#vs-temp').value = vitals.temp || '';
                overlay.querySelector('#vs-height').value = vitals.heightCm || '';
                overlay.querySelector('#vs-weight').value = vitals.weightKg || '';
                overlay.querySelector('#vs-exam').value = vitals.physicalExam || '';

                const bmiEl = overlay.querySelector('#vs-bmi');
                if (vitals.bmi && vitals.bmiCategory) {
                  bmiEl.textContent = `${vitals.bmi} (${vitals.bmiCategory})`;
                } else if (vitals.bmi) {
                  bmiEl.textContent = vitals.bmi;
                } else {
                  bmiEl.textContent = '';
                }

                // Trigger BMI calculation if height and weight are loaded
                calculateBMI();


              } catch (err) {
                console.warn('Failed to parse nurse vitals data:', err);
              }
            }
            const proceedBtn = document.createElement('button');
            proceedBtn.type = 'button';
            proceedBtn.textContent = 'Proceed to Diagnosis';
            proceedBtn.className = 'btn-primary';
            proceedBtn.style.marginTop = '12px';
            proceedBtn.style.justifySelf = 'end';
            proceedBtn.addEventListener('click', async () => {
              // Save vitals data before proceeding to diagnosis
              await saveVitalsData();
              close();
              openDiagnosis();
            });
            overlay.querySelector('.modal-body').appendChild(proceedBtn);
          }

          function openDiagnosis() {
            const overlay = document.createElement('div');
            overlay.className = 'modal-backdrop';

            // Get patient full name from currentPatientProfile
            const patientFullName = currentPatientProfile ? (currentPatientProfile.fullName || currentPatientProfile.name || patient) : patient;

            overlay.innerHTML = `
               <div class="modal-card wide" role="dialog" aria-modal="true" aria-labelledby="diag-title">
                 <div class="modal-header">
                   <div class="modal-title-wrap">
                     <div class="modal-title" id="diag-title">Diagnosis</div>
                     <div class="modal-subtitle who">Patient: ${patientFullName}  Appt #${apptId}</div>
                   </div>
                   <button id="diag-close" class="btn-secondary btn-small">Close</button>
                 </div>
                <div class="modal-body" style="max-height:none;">
                  <form id="diag-form" class="form-grid">
                    <div class="field col-span-2">
                      <label for="diag-assessment">Assessment / Impression</label>
                      <textarea id="diag-assessment" rows="2" placeholder="Clinical assessment and impression..." style="resize: none;"></textarea>
                    </div>
                    <div class="field">
                      <label for="diag-diagnosis">Primary Diagnosis</label>
                      <div class="dropdown" style="position:relative;">
                        <input id="diag-diagnosis" type="text" placeholder="Search primary diagnosis..." autocomplete="off" />
                        <ul id="diag-diagnosis-menu" class="dropdown-menu" style="display:none; position:fixed; background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:8px; margin-top:4px; padding:4px 0; z-index:9999; max-height:220px; overflow:auto; box-shadow:0 24px 40px rgba(15,23,42,0.35);"></ul>
                      </div>
                    </div>
                    <div class="field">
                      <label for="diag-secondary">Secondary Diagnosis (if applicable)</label>
                      <div class="dropdown" style="position:relative;">
                        <input id="diag-secondary" type="text" placeholder="Search secondary diagnosis..." autocomplete="off" />
                        <ul id="diag-secondary-menu" class="dropdown-menu" style="display:none; position:fixed; background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:8px; margin-top:4px; padding:4px 0; z-index:9999; max-height:220px; overflow:auto; box-shadow:0 24px 40px rgba(15,23,42,0.35);"></ul>
                      </div>
                    </div>
                    <div class="field col-span-2">
                      <label for="diag-recommendations">Recommendations</label>
                      <textarea id="diag-recommendations" rows="2" placeholder="Treatment recommendations and follow-up..." style="resize: none;"></textarea>
                    </div>
                    <div class="actions col-span-2" style="justify-content:flex-end;">
                      <button id="diag-gen-exams" type="button" class="btn-secondary btn-small">Exams</button>
                      <button id="diag-gen-meds" type="button" class="btn-secondary btn-small">Prescription</button>
                      <button id="diag-gen-cert" type="button" class="btn-secondary btn-small">Certificate</button>
                      <button type="submit">Save Diagnosis</button>
                    </div>
                  </form>
                </div>
              </div>`;
            document.body.appendChild(overlay);
            function close() { try { document.body.removeChild(overlay); } catch (_) { } }
            overlay.querySelector('#diag-close')?.addEventListener('click', close);

            const commonDiagnoses = [
              'Hypertension', 'Diabetes mellitus type 2', 'Diabetes mellitus type 1', 'Hyperlipidemia',
              'Coronary artery disease', 'Myocardial infarction', 'Heart failure', 'Atrial fibrillation',
              'Stroke', 'Transient ischemic attack', 'Chronic obstructive pulmonary disease', 'Asthma',
              'Pneumonia', 'Bronchitis', 'Sinusitis', 'Upper respiratory infection', 'Gastroesophageal reflux disease',
              'Peptic ulcer disease', 'Irritable bowel syndrome', 'Inflammatory bowel disease', 'Diverticulitis',
              'Cholelithiasis', 'Hepatitis', 'Cirrhosis', 'Chronic kidney disease', 'Urinary tract infection',
              'Benign prostatic hyperplasia', 'Osteoarthritis', 'Rheumatoid arthritis', 'Fibromyalgia',
              'Migraine', 'Tension headache', 'Depression', 'Anxiety disorder', 'Bipolar disorder',
              'Hypothyroidism', 'Hyperthyroidism', 'Obesity', 'Anemia', 'Iron deficiency anemia',
              'Vitamin D deficiency', 'Osteoporosis', 'Cataracts', 'Glaucoma', 'Macular degeneration',
              'Dermatitis', 'Eczema', 'Psoriasis', 'Acne', 'Cellulitis', 'Allergic rhinitis',
              'Seasonal allergies', 'Food allergies', 'Drug allergies', 'Sleep apnea', 'Insomnia'
            ];

            const primaryInput = overlay.querySelector('#diag-diagnosis');
            const primaryMenu = overlay.querySelector('#diag-diagnosis-menu');
            const secondaryInput = overlay.querySelector('#diag-secondary');
            const secondaryMenu = overlay.querySelector('#diag-secondary-menu');

            function setupDiagnosisDropdown(input, menu) {
              function showMenu() {
                menu.style.display = 'block';
                const rect = input.getBoundingClientRect();
                menu.style.left = rect.left + 'px';
                menu.style.top = (rect.bottom + 4) + 'px';
                menu.style.width = rect.width + 'px';
              }

              function hideMenu() {
                menu.style.display = 'none';
              }

              function filterDiagnoses(query) {
                const filtered = commonDiagnoses.filter(diag =>
                  diag.toLowerCase().includes(query.toLowerCase())
                );
                menu.innerHTML = '';
                filtered.forEach(diag => {
                  const li = document.createElement('li');
                  li.textContent = diag;
                  li.addEventListener('click', () => {
                    input.value = diag;
                    hideMenu();
                  });
                  menu.appendChild(li);
                });
              }

              input.addEventListener('input', (e) => {
                const query = e.target.value;
                if (query.length > 0) {
                  filterDiagnoses(query);
                  showMenu();
                } else {
                  hideMenu();
                }
              });

              input.addEventListener('focus', () => {
                if (input.value.length > 0) {
                  filterDiagnoses(input.value);
                  showMenu();
                }
              });

              input.addEventListener('blur', () => {
                setTimeout(hideMenu, 150);
              });

              input.addEventListener('click', () => {
                if (input.value.length === 0) {
                  menu.innerHTML = '';
                  commonDiagnoses.forEach(diag => {
                    const li = document.createElement('li');
                    li.textContent = diag;
                    li.addEventListener('click', () => {
                      input.value = diag;
                      hideMenu();
                    });
                    menu.appendChild(li);
                  });
                  showMenu();
                }
              });
            }

            setupDiagnosisDropdown(primaryInput, primaryMenu);
            setupDiagnosisDropdown(secondaryInput, secondaryMenu);

            function openPrintModal({ title, contentHtml }) {
              const po = document.createElement('div');
              po.className = 'modal-backdrop';
              po.innerHTML = `
                <div class="modal-card narrow" role="dialog" aria-modal="true" aria-labelledby="print-title">
                  <div class="modal-header">
                    <div class="modal-title" id="print-title">${title}</div>
                    <button id="print-close" class="btn-secondary btn-small">Close</button>
                  </div>
                  <div class="modal-body">
                    <div class="field col-span-2">
                      <div class="who">Preview</div>
                      <div class="card" id="print-preview">${contentHtml}</div>
                    </div>
                    <div class="actions col-span-2" style="justify-content:flex-end;">
                      <button id="print-do" type="button">Print</button>
                    </div>
                  </div>
                </div>`;
              document.body.appendChild(po);
              const close = () => { try { document.body.removeChild(po); } catch (_) { } };
              po.querySelector('#print-close')?.addEventListener('click', close);
              po.querySelector('#print-do')?.addEventListener('click', () => {
                const win = window.open('', '_blank');
                if (!win) return;
                const safe = (s) => String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                win.document.write(`<!doctype html><html><head><meta charset="utf-8"/><title>${safe(title)}</title><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#0f172a;padding:24px;}h1{margin:0 0 8px 0;font-size:18px}.box{border:1px solid #e5e7eb;border-radius:8px;padding:10px;background:#fff;min-height:40px}@media print{body{padding:0}}</style></head><body><h1>${safe(title)}</h1><div class="box">${contentHtml}</div></body></html>`);
                win.document.close();
                try { win.focus(); win.print(); } catch (_) { }
              });
            }

            const getPatientHeader = () => {
              const primary = (overlay.querySelector('#diag-diagnosis')?.value || '').trim();
              const secondary = (overlay.querySelector('#diag-secondary')?.value || '').trim();
              const nowStr = new Date().toLocaleString();
              const safe = (s) => String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
              const patientFullName = currentPatientProfile ? (currentPatientProfile.fullName || currentPatientProfile.name || patient) : patient;
              return `<div class="who" style="margin-bottom:8px;">Patient: ${safe(patientFullName)}  Appt #${safe(String(apptId))}  ${safe(nowStr)}</div>
                       <div class="who" style="margin-bottom:8px;">Primary: ${safe(primary) || ''}${secondary ? `  Secondary: ${safe(secondary)}` : ''}</div>`;
            };

            const btnExams = overlay.querySelector('#diag-gen-exams');
            if (btnExams) btnExams.addEventListener('click', () => {
              openExamsModal();
            });

            const btnMeds = overlay.querySelector('#diag-gen-meds');
            if (btnMeds) btnMeds.addEventListener('click', () => {
              openPrescriptionModal();
            });




            const btnCert = overlay.querySelector('#diag-gen-cert');
            if (btnCert) btnCert.addEventListener('click', async () => {
              const primary = (overlay.querySelector('#diag-diagnosis')?.value || '').trim();
              const secondary = (overlay.querySelector('#diag-secondary')?.value || '').trim();
              const assessment = (overlay.querySelector('#diag-assessment')?.value || '').trim();
              const recommendations = (overlay.querySelector('#diag-recommendations')?.value || '').trim();

              if (!primary) {
                showDoctorFeedbackModal('Medical Certificate', 'Primary diagnosis is required to generate a medical certificate', 'error');
                return;
              }

              if (!assessment) {
                showDoctorFeedbackModal('Medical Certificate', 'Assessment/Impression is required to generate a medical certificate', 'error');
                return;
              }

              try {
                let prof = null;
                try {
                  if (appt && appt.patientName) {
                    prof = await apiGet(`/api/patients/${encodeURIComponent(appt.patientName)}`);
                  }
                } catch (_) { }

                const fullName = (prof && (prof.fullName || prof.name)) || (appt && appt.patientName) || '';
                if (!fullName.trim()) {
                  showDoctorFeedbackModal('Medical Certificate', 'Patient name is required to generate a medical certificate', 'error');
                  return;
                }

                if (!prof?.gender) {
                  showDoctorFeedbackModal('Medical Certificate', 'Patient gender is required to generate a medical certificate', 'error');
                  return;
                }

                if (!prof?.dob && !prof?.birthDate) {
                  showDoctorFeedbackModal('Medical Certificate', 'Patient date of birth is required to generate a medical certificate', 'error');
                  return;
                }

                const params = new URLSearchParams();
                if (fullName) params.set('name', fullName);
                if (prof?.gender) params.set('sex', prof.gender);
                if (prof?.address || prof?.location) params.set('address', prof.address || prof.location);
                if (prof?.dob || prof?.birthDate) params.set('dob', prof.dob || prof.birthDate);

                const reason = [primary, secondary].filter(Boolean).join('\n');
                if (reason) params.set('reason', reason);
                if (assessment) params.set('assessment', assessment);
                if (recommendations) params.set('recommendations', recommendations);
                params.set('autoprint', '1');

                const href = '/forms/diz/Doc Dizon/Doc Dizon - Medical Certificate/MAIN FORM Doc Dizon - Medical Certificate.html';
                const url = encodeURI(href) + (params.toString() ? (`?${params.toString()}`) : '');

                // Create hidden iframe for printing
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = url;
                document.body.appendChild(iframe);

                // Listen for print completion message
                const messageHandler = function (event) {
                  if (event.data === 'print-complete') {
                    document.body.removeChild(iframe);
                    window.removeEventListener('message', messageHandler);
                  }
                };
                window.addEventListener('message', messageHandler);

                // Fallback: remove iframe after timeout
                setTimeout(() => {
                  if (document.body.contains(iframe)) {
                    document.body.removeChild(iframe);
                    window.removeEventListener('message', messageHandler);
                  }
                }, 10000);
              } catch (_) {
                const content = `${getPatientHeader()}<div><strong>Medical Certificate</strong></div><div style="margin-top:8px; white-space:pre-wrap;"></div>`;
                openPrintModal({ title: 'Medical Certificate', contentHtml: content });
              }
            });

            const form = overlay.querySelector('#diag-form');
            form?.addEventListener('submit', async (ev) => {
              ev.preventDefault();

              // Get form elements
              const submitBtn = form.querySelector('button[type="submit"]');
              const primaryDiagnosis = overlay.querySelector('#diag-diagnosis')?.value?.trim() || '';
              const secondaryDiagnosis = overlay.querySelector('#diag-secondary')?.value?.trim() || '';
              const assessment = overlay.querySelector('#diag-assessment')?.value?.trim() || '';
              const recommendations = overlay.querySelector('#diag-recommendations')?.value?.trim() || '';

              // Validate required fields
              if (!primaryDiagnosis) {
                showDoctorFeedbackModal('Validation Error', 'Primary diagnosis is required', 'error');
                overlay.querySelector('#diag-diagnosis')?.focus();
                return;
              }

              // Set loading state
              const originalBtnText = submitBtn?.textContent || 'Save Diagnosis';
              if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
                submitBtn.style.opacity = '0.6';
              }

              // Disable all form inputs during save
              const formInputs = form.querySelectorAll('input, textarea, select, button');
              formInputs.forEach(input => {
                if (input !== submitBtn) input.disabled = true;
              });

              let retryCount = 0;
              const maxRetries = 3;

              const saveDiagnosis = async () => {
                try {
                  // Validate localStorage availability
                  if (typeof Storage === 'undefined') {
                    throw new Error('Local storage is not available in this browser');
                  }

                  // Check localStorage quota
                  const testKey = 'diagnosis_test_' + Date.now();
                  try {
                    localStorage.setItem(testKey, 'test');
                    localStorage.removeItem(testKey);
                  } catch (quotaError) {
                    throw new Error('Storage quota exceeded. Please clear some data and try again.');
                  }

                  // Save diagnosis data
                  const diagnosisData = {
                    apptId,
                    primaryDiagnosis,
                    secondaryDiagnosis,
                    assessment,
                    recommendations,
                    diagnosedBy: 'doctor',
                    diagnosedAt: new Date().toISOString(),
                    version: '1.0' // For future compatibility
                  };

                  // Validate data before saving
                  if (!diagnosisData.apptId) {
                    throw new Error('Appointment ID is missing');
                  }

                  const diagnosisKey = `diagnosis_${apptId}`;
                  localStorage.setItem(diagnosisKey, JSON.stringify(diagnosisData));

                  // Verify the save was successful
                  const savedData = localStorage.getItem(diagnosisKey);
                  if (!savedData) {
                    throw new Error('Failed to verify diagnosis data was saved');
                  }

                  const parsedData = JSON.parse(savedData);
                  if (parsedData.primaryDiagnosis !== primaryDiagnosis) {
                    throw new Error('Data integrity check failed');
                  }

                  // Persist diagnosis to the server so it is available outside this device/session
                  const diagnosisList = [primaryDiagnosis];
                  if (secondaryDiagnosis) diagnosisList.push(secondaryDiagnosis);
                  try {
                    const serverDiag = await apiPut(`/api/diagnoses/${apptId}`, {
                      diagnoses: diagnosisList,
                      notes: assessment,
                      recommendations: recommendations
                    });
                    if (serverDiag) {
                      // Refresh cached diagnoses so UI shows latest data
                      cachedDiagnoses = Array.isArray(cachedDiagnoses) ? cachedDiagnoses.filter(d => String(d.appointmentId) !== String(apptId)) : [];
                      cachedDiagnoses.push(serverDiag);
                    }
                  } catch (serverErr) {
                    console.error('Failed to persist diagnosis to server:', serverErr);
                    throw new Error(serverErr?.message || 'Failed to save diagnosis to server');
                  }

                  // Refresh data so newly saved diagnosis appears without manual reload
                  if (typeof refresh === 'function') {
                    try {
                      await refresh();
                    } catch (refreshErr) {
                      console.warn('Failed to refresh data after diagnosis save:', refreshErr);
                    }
                  }

                  // Also save vital signs if they were recorded
                  const patientName = appt ? appt.patientName : '';
                  const appointmentTime = appt ? appt.time : '';

                  if (patientName && appointmentTime) {
                    // Check if there are any vital signs to save from the vitals modal
                    const vitalsKey = `nurse_vitals_${patientName}_${appointmentTime.replace(/[:\s-]/g, '_')}`;
                    const existingVitals = localStorage.getItem(vitalsKey);

                    if (existingVitals) {
                      // Vitals already exist, keep them
                      console.log('Vital signs already saved for this appointment');
                      // Mirror to appointmentId-based key for reliable lookup
                      try {
                        const apptIdForVitals = appt && appt.id != null ? String(appt.id) : '';
                        if (apptIdForVitals) {
                          localStorage.setItem(`vitals_appt_${apptIdForVitals}`, existingVitals);
                        }
                      } catch (e) {
                        console.warn('Failed to mirror vitals data:', e);
                      }
                    } else {
                      // Try to get vitals from the vitals modal if it was opened
                      const vitalsModal = document.querySelector('#vs-form');
                      if (vitalsModal) {
                        const bp = vitalsModal.querySelector('#vs-bp')?.value?.trim() || '';
                        const hr = vitalsModal.querySelector('#vs-hr')?.value?.trim() || '';
                        const rr = vitalsModal.querySelector('#vs-rr')?.value?.trim() || '';
                        const temp = vitalsModal.querySelector('#vs-temp')?.value?.trim() || '';
                        const height = vitalsModal.querySelector('#vs-height')?.value?.trim() || '';
                        const weight = vitalsModal.querySelector('#vs-weight')?.value?.trim() || '';
                        const exam = vitalsModal.querySelector('#vs-exam')?.value?.trim() || '';

                        // Only save if at least one vital sign was entered
                        if (bp || hr || rr || temp || height || weight || exam) {
                          // Calculate BMI if height and weight are provided
                          let bmi = '';
                          let bmiCategory = '';
                          if (height && weight) {
                            const heightM = parseFloat(height) / 100;
                            const weightKg = parseFloat(weight);
                            if (heightM > 0 && weightKg > 0) {
                              bmi = (weightKg / (heightM * heightM)).toFixed(1);
                              // Asian BMI classification
                              if (bmi < 18.5) bmiCategory = 'Underweight';
                              else if (bmi < 23) bmiCategory = 'Normal';
                              else if (bmi < 27.5) bmiCategory = 'Overweight';
                              else bmiCategory = 'Obese';
                            }
                          }

                          const vitalsData = {
                            bp,
                            hr,
                            rr,
                            temp,
                            heightCm: height,
                            weightKg: weight,
                            bmi,
                            bmiCategory,
                            physicalExam: exam,
                            recordedBy: 'doctor',
                            recordedAt: new Date().toISOString()
                          };

                          localStorage.setItem(vitalsKey, JSON.stringify(vitalsData));
                          console.log('Vital signs saved with diagnosis');
                          // Also save using appointmentId-based key
                          try {
                            const apptIdForVitals = appt && appt.id != null ? String(appt.id) : '';
                            if (apptIdForVitals) {
                              localStorage.setItem(`vitals_appt_${apptIdForVitals}`, JSON.stringify(vitalsData));
                            }
                          } catch (e) {
                            console.warn('Failed to save vitals with appointment ID:', e);
                          }
                        }
                      }
                    }
                  }

                  // Update appointment status to completed
                  try {
                    await apiPost(`/api/appointments/${apptId}/status`, { status: 'completed' });
                    console.log('Appointment status updated to completed');

                    // Update the local appointment data
                    const apptIndex = cachedAppts.findIndex(a => String(a.id) === String(apptId));
                    if (apptIndex !== -1) {
                      cachedAppts[apptIndex].status = 'completed';
                      console.log('Local appointment data updated');

                      // Refresh the UI components to show the updated status
                      try {
                        const apptsForCalendar = filterByPatient(cachedAppts);
                        const apptsForList = filterByDate(apptsForCalendar);
                        render(apptsForList);
                        renderCalendar(apptsForCalendar);
                        console.log('UI refreshed with updated appointment status');
                      } catch (uiErr) {
                        console.warn('Failed to refresh UI components:', uiErr);
                      }
                    }
                  } catch (statusErr) {
                    console.warn('Failed to update appointment status:', statusErr);
                    // Don't fail the entire operation if status update fails
                  }

                  // Success - restore form state
                  if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                    submitBtn.style.opacity = '1';
                  }
                  formInputs.forEach(input => {
                    if (input !== submitBtn) input.disabled = false;
                  });

                  showDoctorFeedbackModal('Diagnosis', 'Diagnosis saved and appointment completed successfully', 'success');
                  close();

                } catch (err) {
                  console.error('Diagnosis save error:', err);

                  // Restore form state on error
                  if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                    submitBtn.style.opacity = '1';
                  }
                  formInputs.forEach(input => {
                    if (input !== submitBtn) input.disabled = false;
                  });

                  // Determine error message based on error type
                  let errorMessage = 'Save failed';
                  if (err.message.includes('quota')) {
                    errorMessage = 'Storage is full. Please clear some data and try again.';
                  } else if (err.message.includes('integrity')) {
                    errorMessage = 'Data verification failed. Please try again.';
                  } else if (err.message.includes('missing')) {
                    errorMessage = 'Required information is missing. Please refresh and try again.';
                  } else if (err.message.includes('not available')) {
                    errorMessage = 'Browser storage is not available. Please use a different browser.';
                  } else if (err.message) {
                    errorMessage = err.message;
                  }

                  // Show error with retry option
                  const shouldRetry = retryCount < maxRetries && !err.message.includes('quota') && !err.message.includes('not available');

                  if (shouldRetry) {
                    retryCount++;
                    showDoctorFeedbackModal(
                      'Diagnosis Error',
                      `${errorMessage}\n\nRetry attempt ${retryCount} of ${maxRetries}...`,
                      'error'
                    );
                    // Retry after a short delay
                    setTimeout(() => {
                      saveDiagnosis();
                    }, 2000);
                  } else {
                    showDoctorFeedbackModal('Diagnosis Error', errorMessage, 'error');
                  }
                }
              };

              // Start the save process
              saveDiagnosis();
            });
          }

          const ccOverlay = document.createElement('div');
          ccOverlay.className = 'modal-backdrop';
          ccOverlay.innerHTML = `
            <div class="modal-card wide" role="dialog" aria-modal="true" aria-labelledby="cc-title">
              <div class="modal-header">
                <div class="modal-title-wrap">
                  <div class="modal-title" id="cc-title">Chief Complaint & Medical History</div>
                  <div class="modal-subtitle who">Patient: ${currentPatientProfile ? (currentPatientProfile.fullName || currentPatientProfile.name || patient) : patient}  Appt #${apptId}</div>
                </div>
                <button id="cc-close" class="btn-secondary btn-small">Close</button>
              </div>
              <div class="modal-body">
                <div class="field">
                  <label>Chief Complaint</label>
                  <div style="padding:12px; background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:8px; min-height:80px; white-space:pre-wrap; color:var(--text, #0f172a);">${(appt && appt.chiefComplaint) ? appt.chiefComplaint : 'No chief complaint recorded'}</div>
                </div>
                <div class="field">
                  <label>Medical History</label>
                  <div id="medical-history-content" style="padding:12px; background:var(--card, #ffffff); border:1px solid var(--border, #e2e8f0); border-radius:8px; min-height:120px; color:var(--text, #0f172a);">
                    <div style="display:grid; gap:8px;">
                      <div><strong>Allergies:</strong> <span id="allergies-list">Loading...</span></div>
                      <div><strong>Past Illnesses:</strong> <span id="past-illnesses-list">Loading...</span></div>
                      <div><strong>Surgery History:</strong> <span id="surgery-history-list">Loading...</span></div>
                    </div>
                  </div>
                </div>
                <div class="actions" style="justify-content:flex-end;">
                  <button id="cc-proceed" class="btn-primary">Proceed to Vitals</button>
                </div>
              </div>
            </div>`;
          document.body.appendChild(ccOverlay);
          function closeCC() { try { document.body.removeChild(ccOverlay); } catch (_) { } }
          ccOverlay.querySelector('#cc-close')?.addEventListener('click', closeCC);
          ccOverlay.querySelector('#cc-proceed')?.addEventListener('click', () => { closeCC(); openVitals(); });

          const patientName = appt ? appt.patientName : '';
          if (patientName) {
            apiGet(`/api/patients/${encodeURIComponent(patientName)}`)
              .then(profile => {
                const allergiesEl = ccOverlay.querySelector('#allergies-list');
                const pastIllnessesEl = ccOverlay.querySelector('#past-illnesses-list');
                const surgeryHistoryEl = ccOverlay.querySelector('#surgery-history-list');

                if (allergiesEl) {
                  allergiesEl.textContent = (profile.allergies && profile.allergies.length > 0)
                    ? profile.allergies.join(', ')
                    : 'None recorded';
                }
                if (pastIllnessesEl) {
                  pastIllnessesEl.textContent = (profile.pastIllnesses && profile.pastIllnesses.length > 0)
                    ? profile.pastIllnesses.join(', ')
                    : 'None recorded';
                }
                if (surgeryHistoryEl) {
                  surgeryHistoryEl.textContent = (profile.surgeryHistory && profile.surgeryHistory.length > 0)
                    ? profile.surgeryHistory.join(', ')
                    : 'None recorded';
                }
              })
              .catch(err => {
                console.warn('Failed to load patient medical history:', err);
                const allergiesEl = ccOverlay.querySelector('#allergies-list');
                const pastIllnessesEl = ccOverlay.querySelector('#past-illnesses-list');
                const surgeryHistoryEl = ccOverlay.querySelector('#surgery-history-list');

                if (allergiesEl) allergiesEl.textContent = 'Unable to load';
                if (pastIllnessesEl) pastIllnessesEl.textContent = 'Unable to load';
                if (surgeryHistoryEl) surgeryHistoryEl.textContent = 'Unable to load';
              });
          }
          return;
        }
        const btn = e.target.closest('button[data-action="status"]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const status = btn.getAttribute('data-status');
        try {
          if (status === 'scheduled') {
            const appt = cachedAppts.find(a => String(a.id) === String(id));
            const init = appt ? parseApptDate(appt) : new Date();
            openScheduleModal(init, async (picked) => {
              try {
                await apiPost(`/api/appointments/${id}/status`, { status: 'scheduled', time: picked });
                showDoctorFeedbackModal('Appointment', 'Appointment rescheduled successfully', 'success');
                refresh();
              } catch (err) {
                showDoctorFeedbackModal('Schedule Error', err.message || 'Failed to reschedule appointment', 'error');
              }
            });
            return;
          }
          await apiPost(`/api/appointments/${id}/status`, { status });
          showDoctorFeedbackModal('Appointment', 'Appointment updated successfully', 'success');
          refresh();
        } catch (err) {
          showDoctorFeedbackModal('Status Update', (err && err.message) || 'Failed to update status', 'error');
        }
      });

      let searchTimer;
      patientSearch.addEventListener('input', () => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => { refresh(); }, 250);
      });
      patientResults.addEventListener('click', async (e) => {
        const li = e.target.closest('li.item');
        if (!li) return;
        const name = li.getAttribute('data-patient') || li.querySelector('div')?.textContent || '';
        patientFilter = (patientFilter && patientFilter === name) ? '' : name;
        refresh();
      });



      diagList.addEventListener('click', (e) => {
        const li = e.target.closest('li.item[data-appt-id]');
        if (!li) return;
        const allDiagItems = Array.from(diagList.querySelectorAll('li.item[data-appt-id]'));
        allDiagItems.forEach(el => el.classList.remove('active'));
        li.classList.add('active');
        const apptId = li.getAttribute('data-appt-id');
        const appt = cachedAppts.find(a => String(a.id) === String(apptId));
        const existing = cachedDiagnoses.find(d => String(d.appointmentId) === String(apptId));
        diagApptId.value = apptId;
        if (appt) {
          const t = new Date(parseApptDate(appt)).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          diagApptInput.value = `#${appt.id} ${appt.patientName} at ${appt.time || t}`;
        } else {
          diagApptInput.value = `#${apptId}`;
        }
        selectedDiagnoses.clear();
        const arr = (Array.isArray(existing?.diagnoses) && existing.diagnoses.length)
          ? existing.diagnoses
          : (existing?.diagnosis ? String(existing.diagnosis).split(',').map(s => s.trim()).filter(Boolean) : []);
        arr.forEach(addDiagnosis);
        diagNotes.value = existing?.notes || '';
        renderChips();
      });

      diagForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        diagMsg.textContent = '';
        const appointmentId = diagApptId.value;
        const notes = diagNotes.value.trim();
        const diagnoses = Array.from(selectedDiagnoses);
        if (!appointmentId || diagnoses.length === 0) { diagMsg.textContent = 'Select appointment and add at least one diagnosis'; return; }
        try {
          const exists = cachedDiagnoses.find(d => String(d.appointmentId) === String(appointmentId));
          if (exists) {
            await apiPut(`/api/diagnoses/${encodeURIComponent(appointmentId)}`, { diagnoses, notes });
          } else {
            await apiPost('/api/diagnoses', { appointmentId, diagnoses, notes });
          }
          diagMsg.textContent = 'Saved';
          diagInput.value = '';
          diagNotes.value = '';
          diagApptInput.value = '';
          diagApptId.value = '';
          selectedDiagnoses.clear();
          renderChips();
          refresh();
        } catch (err) {
          diagMsg.textContent = err.message;
        }
      });

      // Doctor profile form functionality
      const doctorProfileForm = document.getElementById('doctor-profile-form');
      if (doctorProfileForm) {
        // Load current profile data
        async function loadDoctorProfile() {
          try {
            const profile = await apiGet('/api/doctors/me');
            const fullNameInput = document.getElementById('dp-fullname');
            const abbreviationsInput = document.getElementById('dp-abbreviations');
            const licenseInput = document.getElementById('dp-license');

            if (fullNameInput) fullNameInput.value = profile.fullName || '';
            if (abbreviationsInput) abbreviationsInput.value = profile.abbreviations || '';
            if (licenseInput) licenseInput.value = profile.licenseNumber || '';
          } catch (err) {
            console.warn('Failed to load doctor profile:', err);
          }
        }

        // Handle form submission
        doctorProfileForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const fullNameInput = document.getElementById('dp-fullname');
          const abbreviationsInput = document.getElementById('dp-abbreviations');
          const licenseInput = document.getElementById('dp-license');
          const errorDiv = document.getElementById('dp-error');
          const submitBtn = doctorProfileForm.querySelector('button[type="submit"]');

          if (!fullNameInput || !abbreviationsInput || !licenseInput || !errorDiv || !submitBtn) return;

          const fullName = fullNameInput.value.trim();
          const abbreviations = abbreviationsInput.value.trim();
          const licenseNumber = licenseInput.value.trim();

          // Clear previous error
          errorDiv.style.display = 'none';
          errorDiv.textContent = '';

          // Validate inputs
          if (!fullName || !abbreviations || !licenseNumber) {
            errorDiv.textContent = 'Full name, abbreviations, and license number are required';
            errorDiv.style.display = 'block';
            return;
          }

          // Disable form during submission
          submitBtn.disabled = true;
          submitBtn.textContent = 'Updating...';

          try {
            const updated = await apiPut('/api/doctors/me', {
              fullName,
              abbreviations,
              licenseNumber
            });

            // Update header with new full name and abbreviations
            updateDoctorHeader(fullName, abbreviations);

            // Show success message
            showDoctorFeedbackModal('Profile Updated', 'Your professional information has been updated successfully', 'success');

          } catch (err) {
            errorDiv.textContent = err.message || 'Failed to update profile';
            errorDiv.style.display = 'block';
          } finally {
            // Re-enable form
            submitBtn.disabled = false;
            submitBtn.textContent = 'Update Profile';
          }
        });

        // Load profile data when manage tab is accessed
        const manageTab = document.querySelector('[data-tab="tab-manage"]');
        if (manageTab) {
          manageTab.addEventListener('click', () => {
            setTimeout(loadDoctorProfile, 100); // Small delay to ensure tab is active
          });
        }

        // Load profile data on initial load if manage tab is active
        if (document.querySelector('[data-tab="tab-manage"].active')) {
          loadDoctorProfile();
        }
      }

      // Doctor username change form functionality
      const doctorUsernameForm = document.getElementById('doctor-username-form');
      if (doctorUsernameForm) {
        doctorUsernameForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const newUsernameInput = document.getElementById('du-new-username');
          const passwordInput = document.getElementById('du-password');
          const errorDiv = document.getElementById('du-error');
          const submitBtn = doctorUsernameForm.querySelector('button[type="submit"]');

          if (!newUsernameInput || !passwordInput || !errorDiv || !submitBtn) return;

          const newUsername = newUsernameInput.value.trim();
          const password = passwordInput.value;

          // Clear previous error
          errorDiv.style.display = 'none';
          errorDiv.textContent = '';

          // Validate inputs
          if (!newUsername || !password) {
            errorDiv.textContent = 'New username and current password are required';
            errorDiv.style.display = 'block';
            return;
          }

          // Disable form during submission
          submitBtn.disabled = true;
          submitBtn.textContent = 'Changing...';

          try {
            const result = await apiPut('/api/doctors/me/username', {
              newUsername,
              password
            });

            // Clear form
            newUsernameInput.value = '';
            passwordInput.value = '';

            // Update stored user info
            const currentUser = JSON.parse(localStorage.getItem('authUser') || '{}');
            if (currentUser.username) {
              currentUser.username = result.username;
              localStorage.setItem('authUser', JSON.stringify(currentUser));
            }

            // Show success message
            showDoctorFeedbackModal('Username Changed', 'Your username has been updated successfully. Please log in again with your new username.', 'success');

            // Redirect to login after a delay
            setTimeout(() => {
              localStorage.removeItem('authUser');
              window.location.href = '/';
            }, 2000);

          } catch (err) {
            errorDiv.textContent = err.message || 'Failed to change username';
            errorDiv.style.display = 'block';
          } finally {
            // Re-enable form
            submitBtn.disabled = false;
            submitBtn.textContent = 'Change Username';
          }
        });
      }

      // Doctor password change form functionality
      const doctorPasswordForm = document.getElementById('doctor-password-form');
      if (doctorPasswordForm) {
        doctorPasswordForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const currentPasswordInput = document.getElementById('dp-current-password');
          const newPasswordInput = document.getElementById('dp-new-password');
          const confirmPasswordInput = document.getElementById('dp-confirm-password');
          const errorDiv = document.getElementById('dp-pass-error');
          const submitBtn = doctorPasswordForm.querySelector('button[type="submit"]');

          if (!currentPasswordInput || !newPasswordInput || !confirmPasswordInput || !errorDiv || !submitBtn) return;

          const currentPassword = currentPasswordInput.value;
          const newPassword = newPasswordInput.value;
          const confirmPassword = confirmPasswordInput.value;

          // Clear previous error
          errorDiv.style.display = 'none';
          errorDiv.textContent = '';

          // Validate inputs
          if (!currentPassword || !newPassword) {
            errorDiv.textContent = 'Current password and new password are required';
            errorDiv.style.display = 'block';
            return;
          }

          if (newPassword.length < 6 || newPassword.length > 72) {
            errorDiv.textContent = 'New password must be 6-72 characters long';
            errorDiv.style.display = 'block';
            return;
          }

          if (newPassword !== confirmPassword) {
            errorDiv.textContent = 'New password and confirmation do not match';
            errorDiv.style.display = 'block';
            return;
          }

          // Disable form during submission
          submitBtn.disabled = true;
          submitBtn.textContent = 'Changing...';

          try {
            await apiPut('/api/doctors/me/password', {
              currentPassword,
              newPassword
            });

            // Clear form
            currentPasswordInput.value = '';
            newPasswordInput.value = '';
            confirmPasswordInput.value = '';

            // Show success message
            showDoctorFeedbackModal('Password Changed', 'Your password has been updated successfully. Please log in again.', 'success');

            // Logout and redirect after delay
            setTimeout(() => {
              localStorage.removeItem('authUser');
              window.location.href = '/';
            }, 2000);

          } catch (err) {
            errorDiv.textContent = err.message || 'Failed to change password';
            errorDiv.style.display = 'block';
          } finally {
            // Re-enable form
            submitBtn.disabled = false;
            submitBtn.textContent = 'Change Password';
          }
        });
      }

      // Appointment overlap settings form functionality
      const overlapSettingsForm = document.getElementById('overlap-settings-form');
      if (overlapSettingsForm) {
        const overlapMinutesInput = document.getElementById('overlap-minutes');
        const overlapErrorDiv = document.getElementById('overlap-error');

        // Load current settings
        async function loadOverlapSettings() {
          try {
            const settings = await apiGet('/api/settings/appointments');
            if (overlapMinutesInput && settings && settings.overlapMinutes) {
              overlapMinutesInput.value = settings.overlapMinutes;
            }
          } catch (err) {
            // Silently ignore errors on load (user might not have permission)
            console.log('Could not load overlap settings:', err.message);
          }
        }

        // Load settings when manage tab is clicked
        const manageTabForOverlap = document.querySelector('[data-tab="tab-manage"]');
        if (manageTabForOverlap) {
          manageTabForOverlap.addEventListener('click', () => {
            setTimeout(loadOverlapSettings, 150);
          });
        }

        // Load on initial if manage tab is active
        if (document.querySelector('[data-tab="tab-manage"].active')) {
          loadOverlapSettings();
        }

        overlapSettingsForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const submitBtn = overlapSettingsForm.querySelector('button[type="submit"]');
          if (!overlapMinutesInput || !overlapErrorDiv || !submitBtn) return;

          const overlapMinutes = parseInt(overlapMinutesInput.value, 10);

          // Clear previous error
          overlapErrorDiv.style.display = 'none';
          overlapErrorDiv.textContent = '';

          // Validate input
          if (isNaN(overlapMinutes) || overlapMinutes < 5 || overlapMinutes > 240) {
            overlapErrorDiv.textContent = 'Please enter a value between 5 and 240 minutes';
            overlapErrorDiv.style.display = 'block';
            return;
          }

          // Disable form during submission
          submitBtn.disabled = true;
          submitBtn.textContent = 'Saving...';

          try {
            await apiPost('/api/settings/appointments', { overlapMinutes });

            // Show success message
            showDoctorFeedbackModal('Settings Saved', 'Appointment overlap settings have been updated successfully.', 'success');

          } catch (err) {
            overlapErrorDiv.textContent = err.message || 'Failed to save settings';
            overlapErrorDiv.style.display = 'block';
          } finally {
            // Re-enable form
            submitBtn.disabled = false;
            submitBtn.textContent = 'Save Settings';
          }
        });
      }

      refresh();
    });
  </script>
</body>

</html>